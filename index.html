function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);

    const ss = SpreadsheetApp.openById('SPREADSHEET_ID');
    const sh = ss.getSheetByName('Sheet1');

    // הנחה: כותרות בשורה 1
    const headers = sh.getRange(1, 1, 1, sh.getLastColumn()).getValues()[0];
    const idCol = headers.indexOf('ID') + 1;
    const titleCol = headers.indexOf('Title') + 1;
    const dateCol = headers.indexOf('Date') + 1;
    const descCol = headers.indexOf('Description') + 1;
    const statusCol = headers.indexOf('Status') + 1;
    const ownerCol = headers.indexOf('Owner') + 1;
    const audienceCol = headers.indexOf('Audience') + 1;
    const tasksCol = headers.indexOf('Tasks') + 1;

    if (!idCol) throw new Error('Missing ID column');

    const lastRow = sh.getLastRow();
    const ids = lastRow > 1 ? sh.getRange(2, idCol, lastRow - 1, 1).getValues().flat() : [];
    let rowIndex = ids.findIndex(v => String(v) === String(data.id));

    const tasks = (data.tasks || [])
      .map(t => `${t.text || ''}${t.done ? '(V)' : ''}`)
      .join(',');

    const rowData = [];
    rowData[idCol - 1] = data.id || '';
    rowData[titleCol - 1] = data.title || '';
    rowData[dateCol - 1] = data.dateStr || '';
    rowData[descCol - 1] = data.desc || '';
    rowData[statusCol - 1] = data.status || '';
    rowData[ownerCol - 1] = data.owner || '';
    rowData[audienceCol - 1] = data.audience || '';
    rowData[tasksCol - 1] = tasks;

    if (rowIndex === -1) {
      // insert
      sh.appendRow(Array.from({ length: headers.length }, (_, i) => rowData[i] || ''));
    } else {
      // update existing
      const targetRow = rowIndex + 2;
      sh.getRange(targetRow, 1, 1, headers.length)
        .setValues([Array.from({ length: headers.length }, (_, i) => rowData[i] || sh.getRange(targetRow, i + 1).getValue())]);
    }

    return ContentService
      .createTextOutput(JSON.stringify({ ok: true, id: data.id }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    return ContentService
      .createTextOutput(JSON.stringify({ ok: false, error: String(err) }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
