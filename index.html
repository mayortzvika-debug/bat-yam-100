<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bat Yam 100 Pro</title>
    
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkJhdCBZYW0gMTAwIiwKICAic2hvcnRfbmFtZSI6ICJCYXRZYW0iLAogICJzdGFydF91cmwiOiAiYXBwLmh0bWwiLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDc3YjYiLAogICJ0aGVtZV9jb2xvciI6ICIjMDA3N2I2IiwKICAiaWNvbnMiOiBbeyKic3JjIjogImh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzI5OTAvMjk5MDk5NS5wbmciLCAic2l6ZXMiOiAiMTkyeDE5MiIsICJ0eXBlIjogImltYWdlL3BuZyJ9XQp9">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #0077b6; --bg: #f0f9ff; }
        body { background: var(--bg); font-family: 'Heebo', sans-serif; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        
        /* CARD */
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; transition: transform 0.2s; }
        .card:active { transform: scale(0.98); background: #fafafa; }

        /* HERO */
        .hero-wrapper { position: relative; height: 220px; border-radius: 0 0 35px 35px; overflow: hidden; box-shadow: 0 10px 40px -10px rgba(0, 119, 182, 0.5); background: linear-gradient(135deg, #0077b6, #023e8a); }
        .hero-bg { background-image: url('baner.jpg'); background-size: cover; background-position: center; position: absolute; inset: 0; z-index: 0; opacity: 0.8; }
        
        /* COMPONENTS */
        .glass-btn { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); color: white; border-radius: 20px; transition: 0.2s; display: flex; align-items: center; gap: 5px; }
        .nav-bar { position: fixed; bottom: 25px; left: 20px; right: 20px; background: white; padding: 8px 20px; border-radius: 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 20px 40px -5px rgba(0,0,0,0.15); border: 1px solid #f1f5f9; z-index: 40; }
        .nav-btn { padding: 12px; border-radius: 16px; color: #94a3b8; transition: 0.3s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-btn.active { color: var(--primary); transform: translateY(-2px); }
        .add-btn-main { background: var(--primary); color: white; padding: 12px; border-radius: 20px; box-shadow: 0 10px 20px -5px rgba(0, 119, 182, 0.4); transform: translateY(-20px); border: 4px solid white; }
        
        /* CALENDAR */
        .cal-day { min-height: 70px; background: white; border-radius: 12px; border: 1px solid #f1f5f9; padding: 4px; font-size: 10px; }
        .cal-day.today { border: 2px solid var(--primary); background: #f0f9ff; }
        .cal-event { background: var(--primary); color: white; padding: 2px 4px; border-radius: 4px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 9px; font-weight: bold; }
        
        /* CHIPS */
        .user-chip { padding: 8px 16px; background: white; border: 1px solid #e2e8f0; border-radius: 20px; font-size: 14px; font-weight: bold; color: #64748b; transition: 0.2s; }
        .user-chip.selected { background: #0077b6; color: white; border-color: #0077b6; box-shadow: 0 4px 10px rgba(0,119,182,0.3); }

        /* LANDSCAPE FIX */
        @media (orientation: landscape) and (max-height: 600px) {
            body { padding-bottom: 0; background: white; }
            .hero-wrapper, .nav-bar, #listViewContainer, #tasksView { display: none !important; }
            #calendarView { display: block !important; height: 100vh; position: fixed; inset: 0; z-index: 100; background: white; padding: 10px; overflow-y: auto; }
        }
        
        .animate-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

<div id="loginModal" class="fixed inset-0 bg-slate-900 z-[200] flex items-center justify-center p-6 hidden">
    <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl animate-enter">
        <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl shadow-inner">ğŸ‘‹</div>
        <h2 class="text-2xl font-black text-slate-800 mb-2">××™ ××ª×—×‘×¨?</h2>
        <p class="text-slate-400 text-sm mb-4">×”××¢×¨×›×ª ×–×™×”×ª×” ××ª ×”××©×ª××©×™× ×”×‘××™×:</p>
        
        <div id="userChipsContainer" class="flex flex-wrap gap-2 justify-center mb-6 max-h-40 overflow-y-auto"></div>
        
        <input type="text" id="usernameInput" onkeydown="if(event.key === 'Enter') login()" placeholder="××• ×”×§×œ×“ ×©× ×—×“×©..." class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl text-center font-bold text-lg outline-none focus:border-blue-500 mb-4 transition">
        <button onclick="login()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
    </div>
</div>

<div id="loader" class="fixed inset-0 bg-white z-[90] flex flex-col items-center justify-center transition-opacity duration-300">
    <div class="w-12 h-12 border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
    <p class="text-slate-400 font-bold text-xs tracking-widest">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
</div>

<div id="app" class="hidden max-w-md mx-auto min-h-screen relative">
    
    <div class="hero-wrapper">
        <div class="hero-bg"></div>
        <div class="relative z-10 p-6 flex flex-col justify-between h-full">
            <div class="flex justify-between items-start">
                <div class="glass-btn px-3 py-1 flex items-center gap-2 text-xs font-bold shadow-lg">
                    <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                    <span id="userGreeting">××•×¨×—</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadData(true)" class="glass-btn p-2 rounded-full shadow-lg"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
                    <button onclick="logout()" class="glass-btn p-2 rounded-full shadow-lg"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div class="text-white pb-2">
                <h1 class="text-4xl font-black tracking-tighter leading-none mb-1 drop-shadow-lg">BAT YAM <span class="text-yellow-400">100</span></h1>
                <p class="text-blue-50 text-sm font-medium opacity-90 drop-shadow-md">× ×™×”×•×œ ×¤×¨×•×™×§×˜×™× 2026</p>
            </div>
        </div>
    </div>

    <div class="px-5 pt-6">
        
        <div id="listViewContainer">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                    <i data-lucide="layers" class="w-5 h-5 text-blue-500"></i> ×›×œ ×”×¤×¨×•×™×§×˜×™×
                </h2>
                <span id="totalEvents" class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-md">0</span>
            </div>
            <div id="listView" class="space-y-4 pb-24"></div>
        </div>

        <div id="tasksView" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                    <i data-lucide="check-square" class="w-5 h-5 text-green-500"></i> ×”××©×™××•×ª ×©×œ×™
                </h2>
                <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-md font-bold">××¡×•× ×Ÿ ×œ×¤×™: <span id="filterName"></span></span>
            </div>
            <div id="myTasksList" class="space-y-3 pb-24"></div>
        </div>

        <div id="calendarView" class="hidden">
            <div class="flex justify-between items-center mb-4 pt-4 md:pt-0">
                <h2 class="font-bold text-slate-800 text-lg" id="calMonthTitle"></h2>
                <div class="flex gap-2">
                    <button onclick="changeMonth(-1)" class="p-2 bg-slate-100 rounded-full"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button onclick="changeMonth(1)" class="p-2 bg-slate-100 rounded-full"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                </div>
            </div>
            <div class="grid grid-cols-7 text-center text-xs font-bold text-slate-400 mb-2">
                <div>×</div><div>×‘</div><div>×’</div><div>×“</div><div>×”</div><div>×•</div><div>×©</div>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-1 pb-24"></div>
        </div>

    </div>

    <div class="nav-bar">
        <button onclick="switchView('list')" id="btn-list" class="nav-btn active">
            <i data-lucide="layers" class="w-6 h-6"></i>
            <span>×”×›×œ</span>
        </button>
        <button onclick="document.getElementById('addModal').classList.remove('hidden')" class="add-btn-main active:scale-95 transition">
            <i data-lucide="plus" class="w-8 h-8"></i>
        </button>
        <button onclick="switchView('calendar')" id="btn-calendar" class="nav-btn">
            <i data-lucide="calendar" class="w-6 h-6"></i>
            <span>×™×•××Ÿ</span>
        </button>
        <button onclick="switchView('tasks')" id="btn-tasks" class="nav-btn relative">
            <i data-lucide="check-square" class="w-6 h-6"></i>
            <span>×©×œ×™</span>
            <span id="taskBadge" class="absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full border-2 border-white hidden"></span>
        </button>
    </div>
</div>

<div id="addModal" class="fixed inset-0 bg-slate-900/60 hidden z-[150] flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-lg rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-enter h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-black text-slate-800">×¤×¨×•×™×§×˜ ×—×“×©</h2>
            <button onclick="document.getElementById('addModal').classList.add('hidden')" class="p-2 bg-slate-50 rounded-full hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
        </div>
        
        <div class="space-y-4 overflow-y-auto flex-1 pb-4 px-1">
            <input id="inTitle" type="text" placeholder="×©× ×”××™×¨×•×¢" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 outline-none font-bold text-lg focus:bg-white focus:border-blue-500 transition">
            <div class="grid grid-cols-2 gap-3">
                <input id="inDate" type="date" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none">
                <input id="inOwner" type="text" placeholder="××—×¨××™" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none">
            </div>
            <select id="inStatus" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none">
                <option value="×—×“×©">×—×“×©</option>
                <option value="×‘×˜×™×¤×•×œ">×‘×˜×™×¤×•×œ</option>
                <option value="×‘×•×¦×¢">×‘×•×¦×¢</option>
            </select>
            <textarea id="inDesc" rows="3" placeholder="×ª×™××•×¨..." class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 outline-none"></textarea>
            
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-slate-400 block">××©×™××•×ª</label>
                    <button onclick="addNewTaskLine()" class="text-blue-600 text-xs font-bold">+ ×”×•×¡×£</button>
                </div>
                <div id="newTasksList" class="space-y-2"></div>
            </div>
            
             <label class="flex items-center gap-3 p-3 bg-slate-50 border border-dashed border-slate-300 rounded-xl cursor-pointer hover:bg-slate-100 transition">
                <input type="file" id="inImage" class="hidden" accept="image/*" onchange="handleImageCompress(this)">
                <i data-lucide="image-plus" class="text-slate-400"></i>
                <span class="text-sm font-bold text-slate-500" id="imgStatus">×”×•×¡×£ ×ª××•× ×” (××•×¤×¦×™×•× ×œ×™)</span>
            </label>
        </div>
        <button onclick="saveToExcel()" id="saveBtn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black shadow-lg">×©××•×¨ ×•×¡× ×›×¨×Ÿ</button>
    </div>
</div>

<div id="viewModal" class="fixed inset-0 bg-slate-900/60 hidden z-[150] flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
    <div class="bg-white w-full max-w-lg rounded-t-3xl sm:rounded-3xl p-0 shadow-2xl animate-enter h-[85vh] flex flex-col overflow-hidden">
        <div class="h-40 bg-slate-200 relative">
            <img id="viewImage" class="w-full h-full object-cover hidden">
            <div id="viewImagePlaceholder" class="absolute inset-0 flex items-center justify-center text-slate-400 bg-slate-100">
                <i data-lucide="image" class="w-12 h-12 opacity-20"></i>
            </div>
            <button onclick="document.getElementById('viewModal').classList.add('hidden')" class="absolute top-4 left-4 bg-black/30 text-white p-2 rounded-full backdrop-blur-md"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div id="viewStatusBadge" class="absolute bottom-4 right-4 bg-white/90 px-3 py-1 rounded-full text-xs font-bold shadow-sm backdrop-blur"></div>
        </div>
        <div class="p-6 flex-1 overflow-y-auto">
            <h2 id="viewTitle" class="text-2xl font-black text-slate-800 mb-1 leading-tight"></h2>
            <div class="flex items-center gap-2 mb-4 text-sm text-slate-500 font-medium">
                <span id="viewDate" class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded"></span>
                <span>â€¢</span>
                <span id="viewOwner"></span>
            </div>
            <p id="viewDesc" class="text-sm text-slate-600 leading-relaxed bg-slate-50 p-3 rounded-xl mb-4"></p>
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <h3 class="text-xs font-black text-slate-400 uppercase mb-3 flex items-center gap-2"><i data-lucide="list-todo" class="w-3 h-3"></i> ××©×™××•×ª</h3>
                <div id="viewTasks" class="space-y-3"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ02cU8av1KtchNykwq-QxjU6LiLZx-CSp5B28BxAgnsvJjlTwMMW1QO8qNylEYC78qDQFT_S3-fzUA/pub?output=csv";
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxpdgCT9MgQGJbGRJupmNpEZOxSlWBi99GrAznCFVUM7NsMKytt4gjquKR333sTb62vbg/exec";

    let events = [];
    let currentUser = localStorage.getItem('batyamUser') || "";
    let currentMonth = new Date();
    let currentImageBase64 = "";
    
    // ×¨×©×™××ª ×‘×¨×™×¨×ª ××—×“×œ ×× ××™×Ÿ ×—×™×‘×•×¨
    let knownUsers = new Set(['×‘×Ÿ', '×¨×™× ×ª', '×“×•×“', '×©×¨×”', '××™×›×œ']);

    // Clear Cache Forcefully
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(r => { for(let x of r) x.unregister(); });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadData(false); // Load data first to get users!
    });

    function initApp() {
        if (currentUser) {
            enterApp(currentUser);
        } else {
            renderLoginChips();
            document.getElementById('loginModal').classList.remove('hidden');
        }
        lucide.createIcons();
    }

    function renderLoginChips() {
        const container = document.getElementById('userChipsContainer');
        container.innerHTML = '';
        knownUsers.forEach(user => {
            const btn = document.createElement('button');
            btn.className = 'user-chip';
            btn.innerText = user;
            btn.onclick = () => selectUser(user, btn);
            container.appendChild(btn);
        });
    }

    function selectUser(name, btn) {
        document.querySelectorAll('.user-chip').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById('usernameInput').value = name;
    }

    function login() {
        const name = document.getElementById('usernameInput').value.trim();
        if (name) {
            localStorage.setItem('batyamUser', name);
            if (Notification.permission !== "granted") Notification.requestPermission();
            enterApp(name);
        }
    }

    function logout() {
        if(confirm("×œ×”×ª× ×ª×§?")) {
            localStorage.removeItem('batyamUser');
            location.reload();
        }
    }

    function enterApp(name) {
        currentUser = name;
        document.getElementById('userGreeting').innerText = "×”×™×™, " + name;
        document.getElementById('filterName').innerText = name;
        document.getElementById('loginModal').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        renderAll();
    }

    async function loadData(manual = false) {
        if(manual) document.getElementById('loader').classList.remove('hidden');
        try {
            const res = await fetch(CSV_URL + '&t=' + Date.now());
            const text = await res.text();
            Papa.parse(text, { header: true, skipEmptyLines: true, complete: (results) => {
                events = results.data;
                
                // ×—×™×œ×•×¥ ××©×ª××©×™× ××”××§×¡×œ
                events.forEach(e => {
                    const owner = e.Owner || e[3];
                    if(owner) knownUsers.add(owner.trim());
                });

                document.getElementById('totalEvents').innerText = events.length;
                document.getElementById('loader').classList.add('hidden');
                
                // ×¨×§ ××—×¨×™ ×©×™×© × ×ª×•× ×™×, ××¤×¢×™×œ×™× ××ª ×”××¤×œ×™×§×¦×™×” ××• ××¡×š ×›× ×™×¡×”
                if(manual) renderAll();
                else initApp();
            }});
        } catch(e) { console.error(e); }
    }

    function renderAll() {
        renderList();
        renderMyTasks();
        renderCalendar();
    }

    function switchView(viewName) {
        document.getElementById('listViewContainer').classList.add('hidden');
        document.getElementById('calendarView').classList.add('hidden');
        document.getElementById('tasksView').classList.add('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

        if(viewName === 'list') document.getElementById('listViewContainer').classList.remove('hidden');
        if(viewName === 'calendar') { document.getElementById('calendarView').classList.remove('hidden'); renderCalendar(); }
        if(viewName === 'tasks') document.getElementById('tasksView').classList.remove('hidden');

        if(document.getElementById('btn-' + viewName)) document.getElementById('btn-' + viewName).classList.add('active');
    }

    function renderList() {
        const list = document.getElementById('listView');
        if (!events.length) {
            list.innerHTML = '<p class="text-center text-slate-400 py-10">××™×Ÿ ××™×¨×•×¢×™×</p>';
            return;
        }

        const indexedEvents = events.map((e, i) => ({...e, originalIndex: i}));
        const sorted = indexedEvents.reverse();

        list.innerHTML = sorted.map((e) => {
            const title = e.Title || e[1] || '×œ×œ× ×©×';
            const date = e.Date || e[2] || '';
            const owner = e.Owner || e[3] || '-';
            const status = e.Status || e[5] || '×—×“×©';
            const isMine = owner.includes(currentUser);
            const statusColor = status === '×‘×•×¦×¢' ? 'bg-green-100 text-green-700' : (status === '×‘×˜×™×¤×•×œ' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700');

            return `
                <div onclick="openViewModal(${e.originalIndex})" class="card p-4 flex items-center gap-4 border-l-4 ${isMine ? 'border-l-green-500' : 'border-l-transparent'}">
                    <div class="w-14 h-14 bg-slate-50 rounded-2xl flex flex-col items-center justify-center font-bold text-slate-600 text-xs border border-slate-100 shadow-sm shrink-0">
                        <span class="text-lg leading-none">${date.split('-')[2] || date.split('/')[0] || '?'}</span>
                        <span class="text-[9px] uppercase mt-0.5 opacity-60">×”×—×•×“×©</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-1">
                            <h3 class="font-bold text-slate-800 truncate text-base">${title}</h3>
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${statusColor}">${status}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-400 font-medium">ğŸ‘¤ ${owner}</span>
                            ${isMine ? '<span class="text-[10px] bg-green-50 text-green-600 px-1.5 rounded font-bold">×©×œ×™</span>' : ''}
                        </div>
                    </div>
                </div>`;
        }).join('');
        lucide.createIcons();
    }

    function renderMyTasks() {
        const list = document.getElementById('myTasksList');
        // ×¡×™× ×•×Ÿ ×—×›×: ××¨××” ×¨×§ ××©×™××•×ª ×©××©×•×™×›×•×ª ×œ××©×ª××© ×”××—×•×‘×¨
        const myEvents = events.filter(e => (e.Owner || e[3] || "").includes(currentUser));
        
        document.getElementById('taskBadge').classList.toggle('hidden', myEvents.length === 0);
        
        if(!myEvents.length) {
            list.innerHTML = '<div class="text-center py-10"><p class="text-4xl mb-2">ğŸ‰</p><p class="text-slate-400 font-medium">××™×Ÿ ×œ×š ××©×™××•×ª ×¤×ª×•×—×•×ª!</p></div>';
            return;
        }

        list.innerHTML = myEvents.map(e => {
            const tasks = (e.Tasks || e[6] || "").split('|').filter(t => t);
            const taskHtml = tasks.length ? tasks.map(t => `<div class="flex items-center gap-2 text-sm text-slate-600 bg-slate-50 p-2 rounded"><input type="checkbox" class="w-4 h-4 accent-green-500"> ${t}</div>`).join('') : '<span class="text-xs text-slate-300">××™×Ÿ ××©×™××•×ª ××•×’×“×¨×•×ª</span>';
            
            return `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between mb-3 border-b border-slate-50 pb-2">
                        <h3 class="font-bold text-slate-800">${e.Title || e[1]}</h3>
                        <span class="text-xs font-bold bg-blue-50 text-blue-600 px-2 py-1 rounded">${e.Date || e[2]}</span>
                    </div>
                    <div class="space-y-2">${taskHtml}</div>
                </div>`;
        }).join('');
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        document.getElementById('calMonthTitle').innerText = currentMonth.toLocaleDateString('he-IL', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        let html = '';
        for (let i = 0; i < firstDay; i++) html += `<div></div>`;

        for (let d = 1; d <= daysInMonth; d++) {
            const paddedMonth = String(month + 1).padStart(2, '0');
            const paddedDay = String(d).padStart(2, '0');
            const isoDate = `${year}-${paddedMonth}-${paddedDay}`;
            
            const dayEvents = events.filter(e => {
                const eDate = e.Date || "";
                if (!eDate) return false;
                if (eDate === isoDate) return true;
                const parts = eDate.split('/');
                if (parts.length >= 2) return parseInt(parts[0]) === d && parseInt(parts[1]) === (month + 1);
                return false;
            });

            const isToday = today.getDate() === d && today.getMonth() === month && today.getFullYear() === year;

            const eventDots = dayEvents.map(e => {
                const originalIndex = events.indexOf(e);
                const isMine = (e.Owner || "").includes(currentUser);
                const bgClass = isMine ? 'bg-green-500' : 'bg-blue-600';
                return `<div onclick="openViewModal(${originalIndex})" class="cal-event cursor-pointer ${bgClass}">${e.Title || e[1]}</div>`;
            }).join('');

            html += `
                <div class="cal-day ${isToday ? 'today' : ''}">
                    <span class="font-bold text-slate-400 block mb-1">${d}</span>
                    <div class="flex flex-col gap-0.5 overflow-hidden">${eventDots}</div>
                </div>`;
        }
        grid.innerHTML = html;
    }
    
    function changeMonth(delta) {
        currentMonth.setDate(1); 
        currentMonth.setMonth(currentMonth.getMonth() + delta);
        renderCalendar();
    }

    function addNewTaskLine() {
        const div = document.createElement('div');
        div.innerHTML = `
            <div class="flex gap-2">
                <input type="text" class="task-input w-full p-2 bg-white border border-slate-200 rounded-lg text-sm" placeholder="××©×™××”...">
                <button onclick="this.parentElement.parentElement.remove()" class="text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>`;
        document.getElementById('newTasksList').appendChild(div);
        lucide.createIcons();
    }

    function handleImageCompress(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            document.getElementById('imgStatus').innerText = "×“×•×—×¡ ×ª××•× ×”...";
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 600;
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    currentImageBase64 = canvas.toDataURL('image/jpeg', 0.6);
                    document.getElementById('imgStatus').innerText = "×ª××•× ×” ××•×›× ×” âœ…";
                    document.getElementById('imgStatus').classList.add('text-green-600');
                }
            }
            reader.readAsDataURL(file);
        }
    }

    function openViewModal(idx) {
        const e = events[idx];
        if(!e) return;
        
        document.getElementById('viewTitle').innerText = e.Title || e[1];
        document.getElementById('viewDate').innerText = e.Date || e[2];
        document.getElementById('viewOwner').innerText = e.Owner || e[3];
        document.getElementById('viewDesc').innerText = e.Description || e[4] || "××™×Ÿ ×ª×™××•×¨";
        document.getElementById('viewStatusBadge').innerText = e.Status || e[5] || "×—×“×©";
        
        const img = e.Image || e[7];
        if(img && img.startsWith('data:image')) {
            document.getElementById('viewImage').src = img;
            document.getElementById('viewImage').classList.remove('hidden');
            document.getElementById('viewImagePlaceholder').classList.add('hidden');
        } else {
            document.getElementById('viewImage').classList.add('hidden');
            document.getElementById('viewImagePlaceholder').classList.remove('hidden');
        }

        const tasksStr = e.Tasks || e[6] || "";
        const container = document.getElementById('viewTasks');
        container.innerHTML = tasksStr ? tasksStr.split('|').map(t => `
            <div class="flex items-center gap-2 text-sm text-slate-700 bg-slate-50 p-2 rounded">
                <input type="checkbox" class="accent-blue-500 w-4 h-4"> <span>${t}</span>
            </div>`).join('') : '<span class="text-slate-400 text-xs">××™×Ÿ ××©×™××•×ª</span>';

        document.getElementById('viewModal').classList.remove('hidden');
    }

    async function saveToExcel() {
        const title = document.getElementById('inTitle').value;
        const date = document.getElementById('inDate').value;
        const owner = document.getElementById('inOwner').value;
        const desc = document.getElementById('inDesc').value;
        const status = document.getElementById('inStatus').value;
        const tasks = Array.from(document.querySelectorAll('.task-input')).map(i => i.value).filter(val => val).join('|');

        if(!title) return alert("×—×¡×¨ ×©×");

        const btn = document.getElementById('saveBtn');
        const originalText = btn.innerText;
        btn.innerText = '×©×•×œ×— × ×ª×•× ×™×...';
        btn.disabled = true;

        const formData = new URLSearchParams();
        formData.append('action', 'create');
        formData.append('title', title);
        formData.append('date', date);
        formData.append('owner', owner);
        formData.append('desc', desc);
        formData.append('status', status);
        formData.append('tasks', tasks);
        formData.append('image', currentImageBase64);

        try {
            await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData.toString()
            });

            events.unshift({
                "Title": title, "Date": date, "Owner": owner, 
                "Description": desc, "Status": status, "Tasks": tasks, "Image": currentImageBase64
            });
            renderAll();

            alert("×”×‘×§×©×” × ×©×œ×—×” ×‘×”×¦×œ×—×”!");
            document.getElementById('addModal').classList.add('hidden');
            
            document.getElementById('inTitle').value = '';
            document.getElementById('inDesc').value = '';
            document.getElementById('newTasksList').innerHTML = '';
            currentImageBase64 = "";
            document.getElementById('imgStatus').innerText = "×”×•×¡×£ ×ª××•× ×” (××•×¤×¦×™×•× ×œ×™)";
            document.getElementById('imgStatus').classList.remove('text-green-600');

        } catch (e) {
            alert("×ª×§×œ×” ×‘×©××™×¨×”");
            console.error(e);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
