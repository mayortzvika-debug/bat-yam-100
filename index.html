<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Bat Yam 100</title>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<style>
:root { --p:#0077b6; --d:#023e8a; }
* { box-sizing:border-box; }
body { background:#f0f9ff; font-family:'Heebo',sans-serif; padding-bottom:100px; -webkit-tap-highlight-color:transparent; overscroll-behavior-y:none; }

.hero-wrapper { position:relative; height:220px; border-radius:0 0 36px 36px; overflow:hidden; background:linear-gradient(145deg,var(--p),var(--d)); box-shadow:0 16px 40px -12px rgba(0,119,182,0.5); }
.hero-bg { background-image:url('baner.jpg'); background-size:cover; background-position:center; position:absolute; inset:0; z-index:0; opacity:0.75; }
.hero-overlay { position:absolute; inset:0; z-index:1; background:linear-gradient(to bottom,rgba(0,30,80,0.25),rgba(0,20,60,0.65)); }
.hero-content { position:relative; z-index:2; padding:20px; height:100%; display:flex; flex-direction:column; justify-content:space-between; }
.glass { background:rgba(255,255,255,0.18); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.3); color:white; border-radius:50px; display:inline-flex; align-items:center; gap:6px; cursor:pointer; transition:all 0.2s; }
.glass:active { transform:scale(0.93); }

.card { background:white; border-radius:18px; box-shadow:0 2px 12px rgba(0,0,0,0.055); border:1px solid rgba(0,119,182,0.07); transition:transform 0.15s; cursor:pointer; }
.card:active { transform:scale(0.97); }

.nav-bar { position:fixed; bottom:20px; left:16px; right:16px; background:rgba(255,255,255,0.96); backdrop-filter:blur(16px); padding:8px 12px; border-radius:26px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 12px 40px -8px rgba(0,0,0,0.15); border:1px solid rgba(255,255,255,0.5); z-index:40; }
.nav-btn { padding:10px 12px; border-radius:16px; color:#94a3b8; display:flex; flex-direction:column; align-items:center; gap:3px; font-size:9px; font-weight:700; transition:all 0.2s; }
.nav-btn.active { color:var(--p); background:#e0f2fe; }
.nav-add { background:linear-gradient(135deg,var(--p),var(--d)); color:white; padding:13px; border-radius:22px; box-shadow:0 8px 20px -4px rgba(0,119,182,0.5); transform:translateY(-16px); border:4px solid white; }
.nav-add:active { transform:translateY(-16px) scale(0.93); }

.pnew  { background:#dbeafe; color:#1d4ed8; }
.pact  { background:#fef3c7; color:#b45309; }
.pdone { background:#dcfce7; color:#16a34a; }

.cal-day { min-height:66px; background:white; border-radius:9px; border:1px solid #e0f2fe; padding:3px; overflow:hidden; }
.cal-day.today { border:2px solid var(--p); background:#f0f9ff; }
.cal-empty { min-height:66px; background:#f8fafc; opacity:0.3; border-radius:9px; }
.cal-ev { background:var(--p); color:white; padding:2px 3px; border-radius:3px; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:8px; font-weight:700; display:block; cursor:pointer; }
.cal-ev.mine { background:#16a34a; }

.stat-card { background:white; border-radius:16px; padding:12px 14px; border:1px solid rgba(0,119,182,0.08); box-shadow:0 2px 8px rgba(0,0,0,0.04); }

.overlay { position:fixed; inset:0; background:rgba(15,23,42,0.6); display:flex; align-items:flex-end; justify-content:center; z-index:150; backdrop-filter:blur(4px); }
.sheet { background:white; width:100%; max-width:480px; border-radius:30px 30px 0 0; display:flex; flex-direction:column; max-height:92vh; animation:up 0.3s cubic-bezier(0.16,1,0.3,1); }
@keyframes up { from{transform:translateY(100%)} to{transform:translateY(0)} }

.login-wrap { position:fixed; inset:0; background:#0f172a; z-index:200; display:flex; align-items:center; justify-content:center; padding:20px; }
.login-box { background:white; border-radius:26px; padding:32px 24px; width:100%; max-width:340px; text-align:center; animation:pop 0.35s cubic-bezier(0.16,1,0.3,1); }
@keyframes pop { from{transform:scale(0.85);opacity:0} to{transform:scale(1);opacity:1} }
.chip { padding:9px 18px; border-radius:50px; border:2px solid #e2e8f0; cursor:pointer; font-weight:700; font-size:14px; transition:all 0.15s; background:white; }
.chip.sel { border-color:var(--p); background:#e0f2fe; color:var(--p); }

.task-row { display:flex; align-items:center; gap:10px; padding:9px 12px; background:#f8fafc; border-radius:10px; }
.task-row input[type=checkbox] { width:17px; height:17px; accent-color:var(--p); cursor:pointer; flex-shrink:0; }
.task-row.done span { text-decoration:line-through; color:#94a3b8; }

#loader { position:fixed; inset:0; background:white; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:opacity 0.4s; }
.badge { position:absolute; top:6px; right:6px; width:9px; height:9px; background:#ef4444; border-radius:50%; border:2px solid white; }
.scrollbar-hide::-webkit-scrollbar{display:none;} .scrollbar-hide{-ms-overflow-style:none;scrollbar-width:none;}
</style>
</head>
<body>

<div id="loader">
  <div class="relative mb-4">
    <div class="w-14 h-14 border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin"></div>
    <div class="absolute inset-0 flex items-center justify-center font-black text-blue-600 text-xs">100</div>
  </div>
  <p class="text-slate-400 text-xs font-bold tracking-widest">×˜×•×¢×Ÿ...</p>
</div>

<div id="loginWrap" class="login-wrap" style="display:none">
  <div class="login-box">
    <div style="width:72px;height:72px;background:#eff6ff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 16px">ğŸ‘‹</div>
    <h2 class="text-2xl font-black text-slate-800 mb-1">×‘×¨×•×›×™× ×”×‘××™×</h2>
    <p class="text-slate-400 text-sm mb-5">××™ ××ª/×”?</p>
    <div id="loginChips" class="flex flex-wrap gap-2 justify-center mb-4"></div>
    <input id="loginName" type="text" placeholder="×©× ××—×¨..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-center font-bold outline-none text-sm mb-4">
    <button id="loginBtn" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-black shadow-lg">×›× ×™×¡×” â†’</button>
  </div>
</div>

<div id="app" style="display:none" class="max-w-md mx-auto">
  <div class="hero-wrapper">
    <div class="hero-bg"></div>
    <div class="hero-overlay"></div>
    <div class="hero-content">
      <div class="flex justify-between items-center">
        <button id="heroUser" class="glass px-3 py-2 text-xs font-bold">
          <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
          <span id="userLabel">××•×¨×—</span>
          <i data-lucide="settings" class="w-3 h-3 opacity-70"></i>
        </button>
        <div class="flex gap-2">
          <button id="notifBtn" class="glass p-2"><i data-lucide="bell" class="w-5 h-5"></i></button>
          <button id="refreshBtn" class="glass p-2"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
        </div>
      </div>
      <div>
        <h1 class="text-4xl font-black tracking-tighter text-white drop-shadow-lg leading-none mb-1">BAT YAM <span class="text-yellow-300">100</span></h1>
        <p class="text-blue-100 text-sm font-medium opacity-90">× ×™×”×•×œ ×¤×¨×•×™×§×˜×™× Â· 2026</p>
      </div>
    </div>
  </div>

  <div class="px-4 pt-5">
    <div id="vList">
      <div class="flex gap-3 mb-5 overflow-x-auto scrollbar-hide pb-1">
        <div class="stat-card flex-1 min-w-[100px]"><span class="text-[10px] text-slate-400 font-bold block mb-1">×¡×”"×›</span><span id="stTotal" class="text-3xl font-black text-slate-800">0</span></div>
        <div class="stat-card flex-1 min-w-[100px] bg-green-50 border-green-100"><span class="text-[10px] text-green-600 font-bold block mb-1">×©×œ×™</span><span id="stMine" class="text-3xl font-black text-green-700">0</span></div>
        <div class="stat-card flex-1 min-w-[100px] bg-amber-50 border-amber-100"><span class="text-[10px] text-amber-600 font-bold block mb-1">×‘×˜×™×¤×•×œ</span><span id="stAct" class="text-3xl font-black text-amber-700">0</span></div>
      </div>
      <h2 class="text-sm font-black text-slate-600 mb-3 flex items-center gap-2"><i data-lucide="layout-list" class="w-4 h-4 text-blue-500"></i> ×›×œ ×”×¤×¨×•×™×§×˜×™×</h2>
      <div id="eventCards" class="space-y-3 pb-28"></div>
    </div>

    <div id="vCal" style="display:none">
      <div class="flex justify-between items-center mb-3">
        <h2 id="calTitle" class="font-black text-slate-800 text-sm"></h2>
        <div class="flex gap-2">
          <button id="calPrev" class="p-2 bg-white rounded-full shadow-sm border border-slate-100"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
          <button id="calNext" class="p-2 bg-white rounded-full shadow-sm border border-slate-100"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
        </div>
      </div>
      <div class="grid grid-cols-7 text-center text-[9px] font-black text-slate-400 mb-1 gap-1">
        <div>××³</div><div>×‘×³</div><div>×’×³</div><div>×“×³</div><div>×”×³</div><div>×•×³</div><div>×©×³</div>
      </div>
      <div id="calGrid" class="grid grid-cols-7 gap-1 pb-28"></div>
    </div>

    <div id="vTasks" style="display:none">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-sm font-black text-slate-600 flex items-center gap-2"><i data-lucide="check-square" class="w-4 h-4 text-green-500"></i> ××©×™××•×ª</h2>
        <select id="taskFilter" class="text-xs font-bold bg-white border border-slate-200 rounded-xl px-3 py-2 outline-none"><option value="">×›×•×œ×</option></select>
      </div>
      <div id="taskCards" class="space-y-3 pb-28"></div>
    </div>
  </div>

  <div class="nav-bar">
    <button id="nav-list" class="nav-btn active"><i data-lucide="home" class="w-5 h-5"></i><span>×‘×™×ª</span></button>
    <button id="nav-tasks" class="nav-btn relative"><i data-lucide="check-square" class="w-5 h-5"></i><span>××©×™××•×ª</span><span id="taskBadge" class="badge" style="display:none"></span></button>
    <button id="nav-add" class="nav-add"><i data-lucide="plus" class="w-7 h-7"></i></button>
    <button id="nav-cal" class="nav-btn"><i data-lucide="calendar" class="w-5 h-5"></i><span>×œ×•×— ×©× ×”</span></button>
    <button id="nav-settings" class="nav-btn"><i data-lucide="user" class="w-5 h-5"></i><span>×¤×¨×•×¤×™×œ</span></button>
  </div>
</div>

<!-- ADD MODAL -->
<div id="addModal" class="overlay" style="display:none">
  <div class="sheet" style="height:90vh">
    <div class="p-5 flex justify-between items-center border-b border-slate-100 shrink-0">
      <h2 class="text-xl font-black text-slate-800">×¤×¨×•×™×§×˜ ×—×“×©</h2>
      <button id="addClose" class="p-2 bg-slate-50 rounded-full"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
    </div>
    <div class="flex-1 overflow-y-auto p-5 space-y-4">
      <div>
        <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">×©× ×”××™×¨×•×¢ *</label>
        <input id="inTitle" type="text" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 outline-none font-bold text-lg focus:bg-white focus:border-blue-500 transition">
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">×ª××¨×™×š</label>
          <input id="inDate" type="date" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none focus:border-blue-500">
        </div>
        <div>
          <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">××—×¨××™</label>
          <input id="inOwner" type="text" placeholder="×©×" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none focus:border-blue-500 font-medium">
        </div>
      </div>
      <div>
        <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">×¡×˜×˜×•×¡</label>
        <div id="statusBtns" class="flex gap-2">
          <button class="sbtn flex-1 py-2 rounded-xl font-bold text-sm pnew border-2 border-blue-200" data-val="×—×“×©">×—×“×©</button>
          <button class="sbtn flex-1 py-2 rounded-xl font-bold text-sm bg-slate-50 text-slate-400 border-2 border-slate-100" data-val="×‘×˜×™×¤×•×œ">×‘×˜×™×¤×•×œ</button>
          <button class="sbtn flex-1 py-2 rounded-xl font-bold text-sm bg-slate-50 text-slate-400 border-2 border-slate-100" data-val="×‘×•×¦×¢">×‘×•×¦×¢</button>
        </div>
        <input type="hidden" id="inStatus" value="×—×“×©">
      </div>
      <div>
        <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">×ª×™××•×¨</label>
        <textarea id="inDesc" rows="3" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none focus:bg-white focus:border-blue-500 transition text-sm"></textarea>
      </div>
      <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
        <div class="flex justify-between items-center mb-3">
          <label class="text-[10px] font-black text-slate-400 uppercase">××©×™××•×ª</label>
          <button id="addTaskBtn" class="text-blue-600 text-xs font-bold px-2 py-1">+ ×”×•×¡×£</button>
        </div>
        <div id="newTasksList" class="space-y-2"></div>
      </div>
      <label class="flex items-center gap-3 p-4 border-2 border-dashed border-slate-200 rounded-xl cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition">
        <input type="file" id="inImage" class="hidden" accept="image/*">
        <i data-lucide="image-plus" class="text-slate-300 w-5 h-5"></i>
        <div>
          <span id="imgStatus" class="text-sm font-bold text-slate-500 block">×”×•×¡×£ ×ª××•× ×” (××•×¤×¦×™×•× ×œ×™)</span>
          <span class="text-[10px] text-slate-400">×¢×“ ~37KB</span>
        </div>
      </label>
      <div id="imgPreviewWrap" style="display:none" class="h-36 rounded-xl overflow-hidden border border-slate-100">
        <img id="imgPreviewEl" class="w-full h-full object-cover">
      </div>
    </div>
    <div class="p-5 border-t border-slate-100 shrink-0">
      <button id="saveBtn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black shadow-lg">×©××•×¨ ×•×¡× ×›×¨×Ÿ â†</button>
    </div>
  </div>
</div>

<!-- VIEW MODAL -->
<div id="viewModal" class="overlay" style="display:none">
  <div class="sheet" style="height:88vh">
    <div class="h-44 bg-slate-100 relative shrink-0">
      <img id="viewImg" class="w-full h-full object-cover" style="display:none">
      <div id="viewImgPH" class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-blue-50 to-slate-100">
        <i data-lucide="image" class="w-12 h-12 text-slate-200"></i>
      </div>
      <button id="viewClose" class="absolute top-4 left-4 bg-black/30 text-white p-2 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
      <div id="viewPill" class="absolute bottom-4 right-4 px-3 py-1 rounded-full text-xs font-black shadow-sm"></div>
    </div>
    <div class="flex-1 overflow-y-auto p-5">
      <h2 id="viewTitle" class="text-2xl font-black text-slate-800 mb-1 leading-snug"></h2>
      <div class="flex items-center gap-2 mb-4">
        <span id="viewDate" class="bg-blue-50 text-blue-600 font-bold px-2 py-0.5 rounded text-xs"></span>
        <span class="text-slate-300">Â·</span>
        <span id="viewOwner" class="text-slate-500 font-medium text-xs"></span>
      </div>
      <div id="vstBtns" class="flex gap-2 mb-4">
        <button class="vstb flex-1 py-2 rounded-xl font-bold text-xs border-2" data-val="×—×“×©">×—×“×©</button>
        <button class="vstb flex-1 py-2 rounded-xl font-bold text-xs border-2" data-val="×‘×˜×™×¤×•×œ">×‘×˜×™×¤×•×œ</button>
        <button class="vstb flex-1 py-2 rounded-xl font-bold text-xs border-2" data-val="×‘×•×¦×¢">×‘×•×¦×¢</button>
      </div>
      <p id="viewDesc" class="text-sm text-slate-600 leading-relaxed bg-slate-50 p-3 rounded-xl mb-4"></p>
      <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-[10px] font-black text-slate-400 uppercase">××©×™××•×ª</h3>
          <button id="viewAddTask" class="text-blue-500 text-xs font-bold px-2 py-1">+ ×”×•×¡×£</button>
        </div>
        <div id="viewTasksList" class="space-y-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settingsModal" class="overlay" style="display:none">
  <div class="sheet" style="padding:28px;border-radius:30px 30px 0 0;max-height:70vh">
    <div class="flex justify-between items-center mb-5">
      <h2 class="text-xl font-black text-slate-800">×”×’×“×¨×•×ª</h2>
      <button id="settingsClose" class="p-2 bg-slate-50 rounded-full"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
    </div>
    <p class="text-xs font-bold text-slate-400 mb-3 uppercase">×”×—×œ×£ ××©×ª××©</p>
    <div id="settingsChips" class="flex flex-wrap gap-2 mb-4"></div>
    <input id="settingsName" type="text" placeholder="×©× ××—×¨..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-center font-bold outline-none text-sm mb-4">
    <button id="switchBtn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-black">×”×—×œ×£</button>
  </div>
</div>

<script>
const CSV_URL    = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ02cU8av1KtchNykwq-QxjU6LiLZx-CSp5B28BxAgnsvJjlTwMMW1QO8qNylEYC78qDQFT_S3-fzUA/pub?output=csv";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxpdgCT9MgQGJbGRJupmNpEZOxSlWBi99GrAznCFVUM7NsMKytt4gjquKR333sTb62vbg/exec";
const PRESET     = ['×‘×Ÿ','×¨×™× ×ª','×“×•×“','×©×¨×”','××™×›×œ'];

let events = [], currentUser = localStorage.getItem('batyamUser')||'';
let calYear = new Date().getFullYear(), calMonth = new Date().getMonth();
let imgBase64 = '', viewIdx = -1;

// â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  lucide.createIcons();
  wireEvents();
  if (currentUser) { startApp(); }
  else             { showLogin(); }
});

function showLogin() {
  hide('loader');
  show('loginWrap');
  buildChips('loginChips', null);
}

function startApp() {
  document.getElementById('userLabel').textContent = currentUser;
  show('app');
  loadData();
}

// â”€â”€â”€ WIRE EVENTS (all addEventListener â€” zero onclick in HTML) â”€
function wireEvents() {
  // Login
  $('loginBtn').addEventListener('click', doLogin);
  $('loginName').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });

  // Nav
  $('nav-list').addEventListener('click', () => switchView('List'));
  $('nav-cal').addEventListener('click',  () => switchView('Cal'));
  $('nav-tasks').addEventListener('click',() => switchView('Tasks'));
  $('nav-add').addEventListener('click',  openAdd);
  $('nav-settings').addEventListener('click', openSettings);
  $('heroUser').addEventListener('click', openSettings);
  $('refreshBtn').addEventListener('click', () => loadData(true));
  $('notifBtn').addEventListener('click', askNotif);

  // Add modal
  $('addClose').addEventListener('click', closeAdd);
  $('addTaskBtn').addEventListener('click', () => addTaskRow('newTasksList'));
  $('saveBtn').addEventListener('click', saveEvent);
  $('inImage').addEventListener('change', handleImg);

  // Status btns in add modal (use event delegation on parent)
  $('statusBtns').addEventListener('click', e => {
    const btn = e.target.closest('.sbtn');
    if (!btn) return;
    $('inStatus').value = btn.dataset.val;
    document.querySelectorAll('.sbtn').forEach(b => {
      b.className = 'sbtn flex-1 py-2 rounded-xl font-bold text-sm bg-slate-50 text-slate-400 border-2 border-slate-100';
    });
    const cls = {×—×“×©:'pnew border-blue-200',×‘×˜×™×¤×•×œ:'pact border-amber-200',×‘×•×¦×¢:'pdone border-green-200'};
    btn.className = `sbtn flex-1 py-2 rounded-xl font-bold text-sm ${cls[btn.dataset.val]} border-2`;
  });

  // View modal
  $('viewClose').addEventListener('click', () => hide('viewModal'));
  $('viewAddTask').addEventListener('click', () => addTaskRow('viewTasksList'));
  $('vstBtns').addEventListener('click', e => {
    const btn = e.target.closest('.vstb');
    if (btn) changeStatus(btn.dataset.val);
  });

  // Settings
  $('settingsClose').addEventListener('click', () => hide('settingsModal'));
  $('switchBtn').addEventListener('click', doSwitch);

  // Task filter
  $('taskFilter').addEventListener('change', renderTasks);

  // Cal navigation
  $('calPrev').addEventListener('click', () => { calMonth--; if(calMonth<0){calMonth=11;calYear--;} renderCal(); });
  $('calNext').addEventListener('click', () => { calMonth++; if(calMonth>11){calMonth=0;calYear++;} renderCal(); });

  // Backdrop close
  ['addModal','viewModal','settingsModal'].forEach(id => {
    $(id).addEventListener('click', e => { if(e.target.id===id) hide(id); });
  });
}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function $(id) { return document.getElementById(id); }
function show(id) { $(id).style.display = (id==='loginWrap'||id==='overlay') ? 'flex' : 'block'; }
function hide(id) { $(id).style.display = 'none'; }
function showOverlay(id) { $(id).style.display = 'flex'; lucide.createIcons(); }

// â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildChips(cid, active) {
  const c = $(cid);
  c.innerHTML = '';
  PRESET.forEach(name => {
    const btn = document.createElement('button');
    btn.className = 'chip' + (name===(active||currentUser) ? ' sel' : '');
    btn.textContent = name;
    btn.addEventListener('click', () => {
      c.querySelectorAll('.chip').forEach(b => b.classList.remove('sel'));
      btn.classList.add('sel');
    });
    c.appendChild(btn);
  });
}

function getChip(cid, iid) {
  const sel = document.querySelector(`#${cid} .chip.sel`);
  if (sel) return sel.textContent;
  return $(iid) ? $(iid).value.trim() : '';
}

function doLogin() {
  const name = getChip('loginChips','loginName');
  if (!name) { alert('×‘×—×¨/×™ ×©×'); return; }
  localStorage.setItem('batyamUser', name);
  currentUser = name;
  hide('loginWrap');
  startApp();
}

function openSettings() {
  buildChips('settingsChips', currentUser);
  showOverlay('settingsModal');
}

function doSwitch() {
  const name = getChip('settingsChips','settingsName');
  if (!name) { alert('×‘×—×¨ ×©×'); return; }
  localStorage.setItem('batyamUser', name);
  currentUser = name;
  $('userLabel').textContent = name;
  renderAll();
  hide('settingsModal');
}

// â”€â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData(manual=false) {
  if (manual) { $('loader').style.cssText='display:flex;opacity:1;pointer-events:auto'; }
  try {
    const res = await fetch(CSV_URL+'&t='+Date.now());
    const txt = await res.text();
    Papa.parse(txt, {
      header:true, skipEmptyLines:true,
      complete: r => { events=r.data; renderAll(); hideLoader(); }
    });
  } catch(e) { console.error(e); hideLoader(); }
}

function hideLoader() {
  const l=$('loader');
  l.style.opacity='0';
  setTimeout(()=>{ l.style.display='none'; }, 420);
}

function renderAll() {
  renderList(); renderCal(); renderTasks(); updateStats(); buildFilterDrop();
  lucide.createIcons();
}

// â”€â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
  $('stTotal').textContent = events.length;
  $('stMine').textContent  = events.filter(e=>(e.Owner||'').includes(currentUser)).length;
  $('stAct').textContent   = events.filter(e=>(e.Status||'')==='×‘×˜×™×¤×•×œ').length;
  const myOpen = events.filter(e=>(e.Owner||'').includes(currentUser)&&(e.Status||'')!=='×‘×•×¦×¢').length;
  $('taskBadge').style.display = myOpen>0?'block':'none';
}

// â”€â”€â”€ LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList() {
  const c=$('eventCards'); c.innerHTML='';
  if(!events.length){ c.innerHTML='<p class="text-center text-slate-400 py-16">××™×Ÿ ×¤×¨×•×™×§×˜×™× ×¢×“×™×™×Ÿ</p>'; return; }
  const frag=document.createDocumentFragment();
  [...events].map((e,i)=>({e,i})).reverse().forEach(({e,i})=>{
    const title=e.Title||'×œ×œ× ×©×', date=e.Date||'', owner=e.Owner||'-';
    const status=e.Status||'×—×“×©', isMine=owner.includes(currentUser);
    const day=date.split('-')[2]||date.split('/')[0]||'?';
    const pill=status==='×‘×•×¦×¢'?'pdone':status==='×‘×˜×™×¤×•×œ'?'pact':'pnew';
    const div=document.createElement('div');
    div.className=`card p-4 flex items-center gap-4 border-r-4 ${isMine?'border-r-green-500':'border-r-transparent'}`;
    div.innerHTML=`
      <div style="width:52px;height:52px" class="bg-blue-50 rounded-2xl flex flex-col items-center justify-center border border-blue-100 font-black text-blue-600 shrink-0">
        <span class="text-xl leading-none">${day}</span><span class="text-[8px] opacity-60 mt-0.5">×—×•×“×©</span>
      </div>
      <div class="flex-1 min-w-0">
        <div class="flex justify-between items-start gap-2 mb-1">
          <h3 class="font-bold text-slate-800 text-sm truncate">${title}</h3>
          <span class="text-[10px] font-black px-2 py-0.5 rounded-full shrink-0 ${pill}">${status}</span>
        </div>
        <span class="text-[11px] text-slate-400">ğŸ‘¤ ${owner}${isMine?' <b class="text-green-600">Â· ×©×œ×™</b>':''}</span>
      </div>`;
    div.addEventListener('click', ()=>openView(i));
    frag.appendChild(div);
  });
  c.appendChild(frag);
}

// â”€â”€â”€ CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCal() {
  const grid=$('calGrid'); grid.innerHTML='';
  $('calTitle').textContent=new Date(calYear,calMonth,1).toLocaleDateString('he-IL',{month:'long',year:'numeric'});
  const firstDay=new Date(calYear,calMonth,1).getDay();
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const today=new Date();

  for(let i=0;i<firstDay;i++){
    const b=document.createElement('div'); b.className='cal-empty'; grid.appendChild(b);
  }
  for(let d=1;d<=daysInMonth;d++){
    const mm=String(calMonth+1).padStart(2,'0'), dd=String(d).padStart(2,'0');
    const isToday=d===today.getDate()&&calMonth===today.getMonth()&&calYear===today.getFullYear();
    const fmts=[`${calYear}-${mm}-${dd}`,`${d}/${calMonth+1}/${calYear}`,`${dd}/${mm}/${calYear}`];
    const cell=document.createElement('div');
    cell.className='cal-day'+(isToday?' today':'');
    const num=document.createElement('span');
    num.style.cssText=`font-size:11px;font-weight:800;display:block;color:${isToday?'#0077b6':'#64748b'}`;
    num.textContent=d; cell.appendChild(num);
    events.forEach((e,idx)=>{
      const evDate=(e.Date||'').trim();
      if(!fmts.includes(evDate)) return;
      const isMine=(e.Owner||'').includes(currentUser);
      const ev=document.createElement('span');
      ev.className='cal-ev'+(isMine?' mine':'');
      ev.textContent=e.Title||'â€”';
      ev.addEventListener('click',evt=>{evt.stopPropagation();openView(idx);});
      cell.appendChild(ev);
    });
    grid.appendChild(cell);
  }
}

// â”€â”€â”€ TASKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildFilterDrop() {
  const sel=$('taskFilter'), cur=sel.value;
  const owners=[...new Set(events.map(e=>e.Owner||'').filter(Boolean))];
  sel.innerHTML='<option value="">×›×•×œ×</option>';
  owners.forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; if(o===cur)opt.selected=true; sel.appendChild(opt); });
}

function renderTasks() {
  const c=$('taskCards'); c.innerHTML='';
  const filter=$('taskFilter').value;
  const open=events.filter(e=>(e.Status||'')!=='×‘×•×¦×¢'&&(!filter||(e.Owner||'').includes(filter)));
  if(!open.length){ c.innerHTML='<div class="text-center py-16"><p class="text-4xl mb-2">ğŸ‰</p><p class="text-slate-400">××™×Ÿ ××©×™××•×ª ×¤×ª×•×—×•×ª!</p></div>'; return; }
  const frag=document.createDocumentFragment();
  open.forEach(e=>{
    const idx=events.indexOf(e), isMine=(e.Owner||'').includes(currentUser);
    const tasks=(e.Tasks||'').split('|').filter(t=>t.trim());
    const card=document.createElement('div');
    card.className=`card p-4 border-r-4 ${isMine?'border-r-green-500':'border-r-blue-200'}`;
    const header=document.createElement('div');
    header.className='flex justify-between items-center mb-2 pb-2 border-b border-slate-50';
    header.innerHTML=`<h3 class="font-bold text-slate-800 text-sm truncate">${e.Title||'â€”'}</h3><span class="text-[10px] text-slate-400 font-bold shrink-0 ml-2">ğŸ‘¤ ${e.Owner||'-'}</span>`;
    card.appendChild(header);
    const tWrap=document.createElement('div'); tWrap.className='space-y-1.5 mb-2';
    if(tasks.length){
      tasks.forEach(t=>{
        const row=document.createElement('div'); row.className='task-row';
        const cb=document.createElement('input'); cb.type='checkbox';
        cb.addEventListener('change',()=>row.classList.toggle('done',cb.checked));
        const sp=document.createElement('span'); sp.textContent=t;
        row.appendChild(cb); row.appendChild(sp); tWrap.appendChild(row);
      });
    } else {
      tWrap.innerHTML='<span class="text-xs text-slate-300">××™×Ÿ ××©×™××•×ª ××¤×•×¨×˜×•×ª</span>';
    }
    card.appendChild(tWrap);
    const openBtn=document.createElement('button');
    openBtn.className='text-xs font-bold text-blue-500 mt-1';
    openBtn.textContent='×¤×ª×— ×¤×¨×•×™×§×˜ â†';
    openBtn.addEventListener('click',()=>openView(idx));
    card.appendChild(openBtn);
    frag.appendChild(card);
  });
  c.appendChild(frag);
}

// â”€â”€â”€ VIEW MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openView(idx) {
  const e=events[idx]; if(!e) return;
  viewIdx=idx;
  $('viewTitle').textContent=e.Title||'';
  $('viewDate').textContent =e.Date ||'';
  $('viewOwner').textContent=e.Owner||'';
  $('viewDesc').textContent =e.Description||'××™×Ÿ ×ª×™××•×¨';
  refreshViewStatus(e.Status||'×—×“×©');
  const img=e.Image||'';
  if(img.startsWith('data:image')){ $('viewImg').src=img; show('viewImg'); hide('viewImgPH'); }
  else { hide('viewImg'); $('viewImgPH').style.display='flex'; }
  const tList=$('viewTasksList'); tList.innerHTML='';
  const tasks=(e.Tasks||'').split('|').filter(t=>t.trim());
  if(tasks.length){
    tasks.forEach(t=>{
      const row=document.createElement('div'); row.className='task-row';
      const cb=document.createElement('input'); cb.type='checkbox';
      cb.addEventListener('change',()=>row.classList.toggle('done',cb.checked));
      const sp=document.createElement('span'); sp.textContent=t;
      row.appendChild(cb); row.appendChild(sp); tList.appendChild(row);
    });
  } else {
    tList.innerHTML='<span class="text-xs text-slate-300">××™×Ÿ ××©×™××•×ª</span>';
  }
  showOverlay('viewModal');
}

function refreshViewStatus(st) {
  const aMap={×—×“×©:'pnew border-blue-400',×‘×˜×™×¤×•×œ:'pact border-amber-400',×‘×•×¦×¢:'pdone border-green-400'};
  const cMap={×—×“×©:'bg-blue-100 text-blue-800',×‘×˜×™×¤×•×œ:'bg-amber-100 text-amber-800',×‘×•×¦×¢:'bg-green-100 text-green-800'};
  document.querySelectorAll('.vstb').forEach(b=>{
    b.className=b.dataset.val===st
      ?`vstb flex-1 py-2 rounded-xl font-bold text-xs border-2 ${aMap[st]}`
      :'vstb flex-1 py-2 rounded-xl font-bold text-xs border-2 bg-slate-50 text-slate-400 border-slate-100';
  });
  const pill=$('viewPill'); pill.textContent=st;
  pill.className=`absolute bottom-4 right-4 px-3 py-1 rounded-full text-xs font-black shadow-sm ${cMap[st]}`;
}

function changeStatus(st) {
  if(viewIdx<0) return;
  events[viewIdx].Status=st; refreshViewStatus(st); updateStats(); renderList();
}

// â”€â”€â”€ ADD MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAdd()  { showOverlay('addModal'); }
function closeAdd() { hide('addModal'); }

function addTaskRow(cid) {
  const c=$(cid);
  const row=document.createElement('div'); row.className='flex gap-2 items-center';
  const inp=document.createElement('input');
  inp.type='text'; inp.placeholder='××©×™××”...';
  inp.className='task-input flex-1 bg-white border border-slate-200 rounded-xl p-2.5 text-sm outline-none focus:border-blue-400';
  const del=document.createElement('button');
  del.className='text-red-400 hover:text-red-600 shrink-0 p-1';
  del.innerHTML='<i data-lucide="trash-2" class="w-4 h-4"></i>';
  del.addEventListener('click',()=>row.remove());
  row.appendChild(inp); row.appendChild(del); c.appendChild(row);
  lucide.createIcons(); inp.focus();
}

function handleImg() {
  const file=$('inImage').files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    if(ev.target.result.length>50000){ alert('×”×ª××•× ×” ×’×“×•×œ×” ××“×™ â€” ×¢×“ ~37KB'); $('inImage').value=''; return; }
    imgBase64=ev.target.result;
    $('imgStatus').textContent='âœ… ×ª××•× ×” × ×‘×—×¨×”';
    $('imgPreviewEl').src=imgBase64; $('imgPreviewWrap').style.display='block';
  };
  reader.readAsDataURL(file);
}

async function saveEvent() {
  const title=$('inTitle').value.trim(), date=$('inDate').value;
  const owner=$('inOwner').value.trim(), desc=$('inDesc').value.trim();
  const status=$('inStatus').value;
  const tasks=[...$('newTasksList').querySelectorAll('.task-input')]
               .map(i=>i.value.trim()).filter(Boolean).join('|');
  if(!title){ alert('× × ×œ×”×–×™×Ÿ ×©× ××™×¨×•×¢'); return; }
  const btn=$('saveBtn'); btn.textContent='×©×•××¨...'; btn.disabled=true;
  const body=new URLSearchParams({title,date,owner,desc,status,tasks,image:imgBase64});
  try { await fetch(SCRIPT_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:body.toString()}); }
  catch(e){ console.error(e); }
  events.unshift({Title:title,Date:date,Owner:owner,Description:desc,Status:status,Tasks:tasks,Image:imgBase64});
  renderAll(); closeAdd(); resetForm();
  setTimeout(()=>loadData(),3500);
  btn.textContent='×©××•×¨ ×•×¡× ×›×¨×Ÿ â†'; btn.disabled=false;
}

function resetForm() {
  ['inTitle','inDate','inOwner','inDesc'].forEach(id=>$(id).value='');
  $('inStatus').value='×—×“×©'; $('newTasksList').innerHTML=''; $('inImage').value='';
  $('imgStatus').textContent='×”×•×¡×£ ×ª××•× ×” (××•×¤×¦×™×•× ×œ×™)'; $('imgPreviewWrap').style.display='none';
  document.querySelectorAll('.sbtn').forEach((b,i)=>{
    b.className=i===0?'sbtn flex-1 py-2 rounded-xl font-bold text-sm pnew border-2 border-blue-200'
                     :'sbtn flex-1 py-2 rounded-xl font-bold text-sm bg-slate-50 text-slate-400 border-2 border-slate-100';
  });
  imgBase64='';
}

// â”€â”€â”€ VIEW SWITCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchView(name) {
  ['List','Cal','Tasks'].forEach(v=>{
    $('v'+v).style.display='none';
    const nb=$('nav-'+v.toLowerCase()); if(nb) nb.classList.remove('active');
  });
  $('v'+name).style.display='block';
  const nb=$('nav-'+name.toLowerCase()); if(nb) nb.classList.add('active');
}

// â”€â”€â”€ NOTIFS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function askNotif() {
  Notification.requestPermission().then(p=>alert(p==='granted'?'ğŸ”” ×”×•×¤×¢×œ!':'×œ× ××•×©×¨'));
}
</script>
</body>
</html>
