<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Bat Yam 100</title>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&family=Frank+Ruhl+Libre:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root { --ink:#0d1b2a; --blue:#0057a8; --sky:#2196f3; --gold:#f5a623; --mint:#00b89c; --bg:#f4f6f9; --card:#ffffff; --border:#e4e9f0; --muted:#7a8899; }
* { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
body { background:var(--bg); font-family:'Heebo',sans-serif; padding-bottom:110px; overscroll-behavior-y:none; color:var(--ink); }

/* ANIMATIONS */
@keyframes spin{to{transform:rotate(360deg)}} 
@keyframes up{from{transform:translateY(110%)}to{transform:translateY(0)}} 
@keyframes pop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}

/* LOADER */
#ldr { position:fixed; inset:0; background:var(--ink); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:opacity .4s; }
#ldr .ring { width:50px; height:50px; border:3px solid rgba(255,255,255,.15); border-top-color:var(--gold); border-radius:50%; animation:spin 1s linear infinite; margin-bottom:15px; }
#ldr p { color:rgba(255,255,255,.5); font-size:10px; font-weight:900; letter-spacing:.2em; }

/* LAYOUT */
.hero { position:relative; height:240px; border-radius:0 0 32px 32px; overflow:hidden; background:var(--ink); box-shadow:0 20px 40px -12px rgba(13,27,42,.5); }
.hero-bg { background-image:url('baner.jpg'); background-size:cover; background-position:center; position:absolute; inset:0; opacity:.6; }
.hero-c { position:relative; z-index:2; padding:22px 20px; height:100%; display:flex; flex-direction:column; justify-content:space-between; }
.hero-t { font-family:'Frank Ruhl Libre',serif; font-size:42px; font-weight:900; color:white; line-height:.9; letter-spacing:-1px; text-shadow:0 4px 20px rgba(0,0,0,.5); }
.hero-t span { color:var(--gold); }

.glass-btn { background:rgba(255,255,255,.15); backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,.25); color:white; border-radius:30px; display:inline-flex; align-items:center; gap:6px; padding:6px 12px; font-size:12px; font-weight:700; transition:all .2s; }
.glass-btn:active { transform:scale(.95); background:rgba(255,255,255,.25); }

/* STATS */
.stats { display:flex; gap:10px; padding:0 16px; margin:-24px 0 24px; position:relative; z-index:10; }
.stat { flex:1; background:var(--card); border-radius:16px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,.06); border-top:3px solid transparent; text-align:center; }
.stat:nth-child(1){border-color:var(--blue)} .stat:nth-child(2){border-color:var(--mint)} .stat:nth-child(3){border-color:var(--gold)}
.sn { font-size:28px; font-weight:900; line-height:1; color:var(--ink); }
.sl { font-size:10px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.03em; margin-top:4px; }

/* CARDS */
#eCards { display:grid; gap:12px; padding:0 16px 100px; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); }
.ecard { background:var(--card); border-radius:18px; border:1px solid var(--border); box-shadow:0 2px 10px rgba(0,0,0,.04); overflow:hidden; display:flex; min-height:90px; transition:transform .15s; }
.ecard:active { transform:scale(.98); }
.bar { width:5px; flex-shrink:0; background:var(--blue); }
.bar.mine { background:var(--mint); } .bar.done { background:#cbd5e1; }
.date-box { width:56px; background:#f8fafc; border-left:1px solid var(--border); display:flex; flex-direction:column; align-items:center; justify-content:center; flex-shrink:0; }
.d-big { font-size:24px; font-weight:900; line-height:1; }
.d-mon { font-size:10px; font-weight:700; color:var(--muted); text-transform:uppercase; margin-top:2px; }
.body { flex:1; padding:12px; display:flex; flex-direction:column; justify-content:center; min-width:0; }
.tit { font-size:15px; font-weight:700; color:var(--ink); line-height:1.3; margin-bottom:6px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
.meta { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.own { font-size:11px; font-weight:600; color:var(--muted); }

/* PILLS */
.pill { padding:3px 10px; border-radius:20px; font-size:10px; font-weight:800; }
.p-new { background:#dbeafe; color:#1e40af; }
.p-wip { background:#fef3c7; color:#92400e; }
.p-done { background:#d1fae5; color:#065f46; }

/* NAV */
.nav { position:fixed; bottom:20px; left:16px; right:16px; background:var(--ink); padding:8px 12px; border-radius:30px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 12px 32px rgba(13,27,42,.4); z-index:50; }
.nb { background:none; border:none; color:rgba(255,255,255,.4); display:flex; flex-direction:column; align-items:center; gap:3px; font-size:9px; font-weight:700; padding:8px 12px; border-radius:16px; transition:all .2s; }
.nb.on { color:white; background:rgba(255,255,255,.15); }
.n-add { background:var(--gold); color:var(--ink); padding:14px; border-radius:20px; border:4px solid var(--ink); transform:translateY(-20px); box-shadow:0 8px 24px rgba(245,166,35,.4); }
.n-add:active { transform:translateY(-20px) scale(.95); }

/* MODALS */
.ov { position:fixed; inset:0; background:rgba(13,27,42,.7); z-index:100; display:none; align-items:flex-end; justify-content:center; backdrop-filter:blur(4px); }
.sh { background:var(--card); width:100%; max-width:500px; max-height:92vh; border-radius:28px 28px 0 0; display:flex; flex-direction:column; animation:up .3s cubic-bezier(.16,1,.3,1); box-shadow:0 -10px 40px rgba(0,0,0,.2); }
.sh-h { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
.sh-t { font-size:18px; font-weight:900; }
.cls { width:32px; height:32px; border-radius:50%; background:#f1f5f9; display:flex; align-items:center; justify-content:center; border:none; }

.fld { width:100%; padding:12px; background:#f8fafc; border:1.5px solid var(--border); border-radius:12px; outline:none; font-family:'Heebo',sans-serif; font-size:14px; transition:0.2s; }
.fld:focus { border-color:var(--blue); background:white; }
.lbl { font-size:10px; font-weight:900; color:var(--muted); text-transform:uppercase; margin-bottom:5px; display:block; }

/* TASKS ROW */
.tr { display:flex; align-items:center; gap:10px; padding:10px; background:white; border:1px solid var(--border); border-radius:10px; margin-bottom:6px; }
.tr input[type=checkbox] { width:18px; height:18px; accent-color:var(--blue); }
.tr.done span { text-decoration:line-through; color:var(--muted); opacity:0.7; }

/* CALENDAR */
.cal-g { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; padding-bottom:100px; }
.cd { min-height:70px; background:white; border:1px solid var(--border); border-radius:10px; padding:4px; }
.cd.tod { border:2px solid var(--blue); background:#eff6ff; }
.cev { background:var(--blue); color:white; padding:2px 4px; border-radius:4px; font-size:9px; margin-top:2px; white-space:nowrap; overflow:hidden; font-weight:700; }
.cev.mine { background:var(--mint); }

/* HELPERS */
.badge { position:absolute; top:6px; right:6px; width:8px; height:8px; background:#ef4444; border-radius:50%; border:2px solid var(--ink); display:none; }
.sh-scroll { flex:1; overflow-y:auto; padding:20px; }
.hide { display:none!important; }
</style>
</head>
<body>

<div id="ldr"><div class="ring"></div><p>×˜×•×¢×Ÿ × ×ª×•× ×™×...</p></div>

<div id="lw" class="ov" style="z-index:200;align-items:center;padding:20px">
  <div class="sh" style="border-radius:24px;max-height:auto;animation:pop .3s">
    <div style="padding:32px 24px;text-align:center">
      <div style="font-size:40px;margin-bottom:10px">ğŸ‘‹</div>
      <h2 style="font-size:22px;font-weight:900;margin-bottom:6px">××™ ××ª×—×‘×¨?</h2>
      <div id="lchips" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:20px 0"></div>
      <input id="lname" type="text" class="fld" style="text-align:center;margin-bottom:12px" placeholder="××• ×”×§×œ×“ ×©×...">
      <button id="lbtn" style="width:100%;background:var(--ink);color:white;padding:14px;border-radius:12px;font-weight:800">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
    </div>
  </div>
</div>

<div id="app" class="hide" style="max-width:480px;margin:0 auto">
  <div class="hero">
    <div class="hero-bg"></div>
    <div class="hero-c">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <button id="uBtn" class="glass-btn"><span style="width:8px;height:8px;background:#4ade80;border-radius:50%"></span><span id="uName">××•×¨×—</span></button>
        <button id="rBtn" class="glass-btn" style="padding:8px"><i data-lucide="refresh-cw" style="width:16px"></i></button>
      </div>
      <div>
        <div class="hero-t">BAT YAM<br><span>100</span></div>
        <div style="color:rgba(255,255,255,.7);font-size:13px;font-weight:500;margin-top:4px">× ×™×”×•×œ ×¤×¨×•×™×§×˜×™× 2026</div>
      </div>
    </div>
  </div>

  <div class="stats">
    <div class="stat"><div id="sTot" class="sn">0</div><div class="sl">×¤×¨×•×™×§×˜×™×</div></div>
    <div class="stat"><div id="sMine" class="sn">0</div><div class="sl">×©×œ×™</div></div>
    <div class="stat"><div id="sAct" class="sn">0</div><div class="sl">×‘×˜×™×¤×•×œ</div></div>
  </div>

  <div id="vList">
    <div style="padding:0 16px 12px;display:flex;justify-content:space-between;align-items:center">
      <span class="lbl" style="margin:0;font-size:12px;color:var(--ink)">×›×œ ×”×¤×¨×•×™×§×˜×™×</span>
      <span id="cnt" style="font-size:11px;font-weight:700;color:var(--muted)"></span>
    </div>
    <div id="eCards"></div>
  </div>

  <div id="vCal" class="hide" style="padding:0 16px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2 id="cTit" style="font-weight:900;font-size:18px"></h2>
      <div style="display:flex;gap:8px">
        <button id="cP" class="cls"><i data-lucide="chevron-right" style="width:16px"></i></button>
        <button id="cN" class="cls"><i data-lucide="chevron-left" style="width:16px"></i></button>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-size:10px;font-weight:800;color:var(--muted);margin-bottom:6px">
      <div>×</div><div>×‘</div><div>×’</div><div>×“</div><div>×”</div><div>×•</div><div>×©</div>
    </div>
    <div id="cGrid" class="cal-g"></div>
  </div>

  <div id="vTasks" class="hide" style="padding:0 16px">
    <div style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
      <h2 style="font-weight:900;font-size:18px">××©×™××•×ª ×¤×ª×•×—×•×ª</h2>
      <select id="tFil" style="background:white;border:1px solid var(--border);border-radius:8px;font-size:12px;padding:4px"><option value="">×›×•×œ×</option></select>
    </div>
    <div id="tListMain" style="padding-bottom:100px;display:flex;flex-direction:column;gap:10px"></div>
  </div>

  <div class="nav">
    <button id="nList" class="nb on"><i data-lucide="home" style="width:20px"></i><span>×‘×™×ª</span></button>
    <button id="nTask" class="nb" style="position:relative"><i data-lucide="check-square" style="width:20px"></i><span>××©×™××•×ª</span><span id="bdg" class="badge"></span></button>
    <button id="nAdd" class="n-add"><i data-lucide="plus" style="width:24px"></i></button>
    <button id="nCal" class="nb"><i data-lucide="calendar" style="width:20px"></i><span>×™×•××Ÿ</span></button>
    <button id="nSet" class="nb"><i data-lucide="user" style="width:20px"></i><span>×¤×¨×•×¤×™×œ</span></button>
  </div>
</div>

<div id="mAdd" class="ov">
  <div class="sh" style="height:90vh">
    <div class="sh-h"><span class="sh-t">×¤×¨×•×™×§×˜ ×—×“×©</span><button id="cAdd" class="cls"><i data-lucide="x" style="width:16px"></i></button></div>
    <div class="sh-scroll">
      <div style="display:flex;flex-direction:column;gap:16px">
        <div><label class="lbl">×©× ×”××™×¨×•×¢</label><input id="iaT" type="text" class="fld" style="font-weight:700;font-size:16px"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div><label class="lbl">×ª××¨×™×š</label><input id="iaD" type="date" class="fld"></div>
          <div><label class="lbl">××—×¨××™</label><select id="iaO" class="fld"><option value="">×‘×—×¨...</option></select></div>
        </div>
        <div>
          <label class="lbl">×¡×˜×˜×•×¡</label>
          <div style="display:flex;gap:8px">
            <button class="fld" style="flex:1;text-align:center;font-weight:700;background:#dbeafe;color:#1e40af;border-color:#93c5fd" onclick="setS(this,'×—×“×©')">×—×“×©</button>
            <button class="fld" style="flex:1;text-align:center;font-weight:700;color:#94a3b8" onclick="setS(this,'×‘×˜×™×¤×•×œ')">×‘×˜×™×¤×•×œ</button>
            <button class="fld" style="flex:1;text-align:center;font-weight:700;color:#94a3b8" onclick="setS(this,'×‘×•×¦×¢')">×‘×•×¦×¢</button>
          </div>
          <input type="hidden" id="iaS" value="×—×“×©">
        </div>
        <div><label class="lbl">×ª×™××•×¨</label><textarea id="iaDesc" rows="3" class="fld"></textarea></div>
        
        <div style="background:#f1f5f9;padding:12px;border-radius:12px">
          <label class="lbl">××©×™××•×ª</label>
          <div id="iaTL" style="display:flex;flex-direction:column;gap:8px;margin-bottom:8px"></div>
          <button id="btnAddT" style="font-size:12px;font-weight:700;color:var(--blue)">+ ×”×•×¡×£ ××©×™××”</button>
        </div>

        <label style="display:flex;align-items:center;gap:10px;padding:12px;border:2px dashed var(--border);border-radius:12px">
          <input type="file" id="iaImg" hidden accept="image/*">
          <i data-lucide="image" style="color:var(--muted)"></i>
          <span id="iaImgTxt" style="font-size:12px;font-weight:700;color:var(--muted)">×”×•×¡×£ ×ª××•× ×”</span>
        </label>
      </div>
    </div>
    <div style="padding:16px;border-top:1px solid var(--border)">
      <button id="btnSave" style="width:100%;background:var(--ink);color:white;padding:14px;border-radius:12px;font-weight:800">×©××•×¨ ×•×¡× ×›×¨×Ÿ</button>
    </div>
  </div>
</div>

<div id="mView" class="ov">
  <div class="sh" style="height:90vh">
    <div style="height:160px;position:relative;background:#e2e8f0">
      <img id="ivImg" style="width:100%;height:100%;object-fit:cover;display:none">
      <div id="ivPH" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#94a3b8"><i data-lucide="image" style="width:40px;height:40px"></i></div>
      <button id="cView" class="cls" style="position:absolute;top:16px;left:16px;background:rgba(0,0,0,0.4);color:white"><i data-lucide="x" style="width:16px"></i></button>
      <div id="ivS" style="position:absolute;bottom:16px;right:16px;background:white;padding:4px 10px;border-radius:20px;font-size:10px;font-weight:800"></div>
    </div>
    <div class="sh-scroll">
      <h2 id="ivT" style="font-size:22px;font-weight:900;line-height:1.2;margin-bottom:8px"></h2>
      <div style="display:flex;gap:10px;margin-bottom:20px">
        <span id="ivD" style="background:#eff6ff;color:var(--blue);font-size:11px;font-weight:700;padding:4px 8px;border-radius:6px"></span>
        <span id="ivO" style="font-size:12px;font-weight:600;color:var(--muted);align-self:center"></span>
      </div>
      
      <div style="display:flex;gap:8px;margin-bottom:20px">
        <button onclick="updSt('×—×“×©')" class="fld" style="flex:1;text-align:center;padding:8px;font-size:12px;font-weight:700">×—×“×©</button>
        <button onclick="updSt('×‘×˜×™×¤×•×œ')" class="fld" style="flex:1;text-align:center;padding:8px;font-size:12px;font-weight:700">×‘×˜×™×¤×•×œ</button>
        <button onclick="updSt('×‘×•×¦×¢')" class="fld" style="flex:1;text-align:center;padding:8px;font-size:12px;font-weight:700">×‘×•×¦×¢</button>
      </div>

      <p id="ivDesc" style="font-size:14px;color:#334155;background:#f8fafc;padding:12px;border-radius:10px;margin-bottom:20px"></p>

      <div style="background:#f1f5f9;padding:14px;border-radius:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <span class="lbl" style="margin:0">××©×™××•×ª</span>
          <button id="btnAddTV" class="add-task-btn">+ ×”×•×¡×£</button>
        </div>
        <div id="ivTL" style="display:flex;flex-direction:column;gap:8px"></div>
        <div id="ivNewT" style="margin-top:8px"></div>
      </div>
    </div>
  </div>
</div>

<script>
// --- CONFIG ---
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ02cU8av1KtchNykwq-QxjU6LiLZx-CSp5B28BxAgnsvJjlTwMMW1QO8qNylEYC78qDQFT_S3-fzUA/pub?output=csv";
const SCRIPT = "https://script.google.com/macros/s/AKfycbxpdgCT9MgQGJbGRJupmNpEZOxSlWBi99GrAznCFVUM7NsMKytt4gjquKR333sTb62vbg/exec";
let OWNERS = ['×‘×Ÿ','×¨×™× ×ª','×’×œ×™×ª','××‘×™×©×™','××•×¨','×™×•×¡×™','×¨×•×ª×'];

let events=[], me=localStorage.getItem('user')||'', calM=new Date().getMonth(), calY=new Date().getFullYear(), img64='', vIdx=-1;

// --- INIT ---
window.onload = () => {
  lucide.createIcons();
  wire();
  loadData();
};

function wire() {
  id('lbtn').onclick=login;
  id('lname').onkeydown=e=>{if(e.key==='Enter')login()};
  
  id('nList').onclick=()=>sv('List');
  id('nCal').onclick=()=>sv('Cal');
  id('nTask').onclick=()=>sv('Tasks');
  id('nAdd').onclick=()=>show('mAdd');
  id('nSet').onclick=()=>{id('lw').style.display='flex'};
  
  id('cAdd').onclick=()=>{id('mAdd').style.display='none'};
  id('cView').onclick=()=>{id('mView').style.display='none'};
  
  id('rBtn').onclick=()=>loadData(true);
  
  id('btnAddT').onclick=()=>addTR('iaTL');
  id('btnSave').onclick=save;
  id('iaImg').onchange=hImg;
  
  id('calP').onclick=()=>{calM--;if(calM<0){calM=11;calY--}renCal()};
  id('calN').onclick=()=>{calM++;if(calM>11){calM=0;calY++}renCal()};
  
  id('tFil').onchange=renTasks;
  
  // Quick Add Task in View
  id('btnAddTV').onclick = () => {
    const c = id('ivTL');
    const d = document.createElement('div'); d.className='tr';
    d.innerHTML = `<input type="text" style="flex:1;outline:none;font-size:13px" placeholder="×›×ª×•×‘ ×•×œ×—×¥ Enter..."><button onclick="this.parentElement.remove()">âœ•</button>`;
    c.appendChild(d);
    const inp = d.querySelector('input');
    inp.focus();
    inp.onkeydown = (e) => {
      if(e.key==='Enter' && inp.value.trim()){
        const tasks = getTasks(events[vIdx]);
        tasks.push(inp.value.trim());
        const str = tasks.join('|');
        // Update local
        events[vIdx].tasks = str;
        events[vIdx].Tasks = str;
        events[vIdx]['××©×™××•×ª'] = str;
        // Update UI
        renViewTasks(events[vIdx]);
        // Send
        const body = new URLSearchParams({action:'update', title:val(events[vIdx],'title'), tasks:str});
        fetch(SCRIPT,{method:'POST',mode:'no-cors',body});
      }
    }
  };
}

// --- DATA ---
function val(e,k){ 
  // Super Mapper: ×× ×¨××œ ×©××•×ª ×¢××•×“×•×ª
  if(!e) return '';
  if(k==='title') return e.Title||e.title||e['×©× ×”××™×¨×•×¢']||e['×©×']||'';
  if(k==='date') return e.Date||e.date||e['×ª××¨×™×š']||'';
  if(k==='owner') return e.Owner||e.owner||e['××—×¨××™']||'-';
  if(k==='status') return e.Status||e.status||e['×¡×˜×˜×•×¡']||'×—×“×©';
  if(k==='desc') return e.Description||e.description||e['×ª×™××•×¨']||'';
  if(k==='img') return e.Image||e.image||e['×ª××•× ×”']||'';
  if(k==='tasks') return e.Tasks||e.tasks||e['××©×™××•×ª']||'';
  return '';
}

async function loadData(manual){
  if(manual) id('ldr').style.opacity=1;
  try {
    const r=await fetch(CSV_URL+'&t='+Date.now());
    const t=await r.text();
    Papa.parse(t,{header:true,skipEmptyLines:true,complete:res=>{
      events=res.data.filter(e=>val(e,'title')); // ××¡× ×Ÿ ×©×•×¨×•×ª ×¨×™×§×•×ª
      // ×—×™×œ×•×¥ ××—×¨××™×
      events.forEach(e=>{
        const o=val(e,'owner');
        if(o && !OWNERS.includes(o)) OWNERS.push(o);
      });
      fillSel();
      
      if(me) { id('app').style.display='block'; ren(); }
      else { id('lw').style.display='flex'; renChips(); }
      
      id('ldr').style.opacity=0; setTimeout(()=>{id('ldr').style.display='none'},500);
    }});
  } catch(e){ alert('×©×’×™××” ×‘×˜×¢×™× ×”'); id('ldr').style.display='none'; }
}

function ren(){
  renList(); renCal(); renTasks(); updStat();
}

function renList(){
  const c=id('eCards'); c.innerHTML='';
  if(!events.length){ c.innerHTML='<div style="text-align:center;color:#94a3b8;padding:40px">××™×Ÿ ××™×¨×•×¢×™×</div>'; return; }
  
  // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š
  const s=[...events].sort((a,b)=>{
    const d1=pDate(val(a,'date')), d2=pDate(val(b,'date'));
    return d2-d1; // ×”×›×™ ×—×“×© ×œ××¢×œ×”
  });

  s.forEach(e=>{
    const idx=events.indexOf(e);
    const d=document.createElement('div'); d.className='ecard';
    const st=val(e,'status');
    const mine=val(e,'owner')===me;
    const isDone=st.includes('×‘×•×¦×¢');
    const dt=val(e,'date').split(/[-/]/);
    const day=dt[0]||'?';
    
    d.innerHTML=`
      <div class="bar ${mine?'mine':''} ${isDone?'done':''}"></div>
      <div class="date-box"><span class="d-big">${day}</span><span class="d-mon">×—×•×“×©</span></div>
      <div class="body">
        <div class="tit">${val(e,'title')}</div>
        <div class="meta">
          <span class="pill ${cls(st)}">${st}</span>
          <span class="own">ğŸ‘¤ ${val(e,'owner')}</span>
        </div>
      </div>
    `;
    d.onclick=()=>openV(idx);
    c.appendChild(d);
  });
}

function renCal(){
  const g=id('cGrid'); g.innerHTML='';
  id('cTit').innerText = new Date(calY,calM,1).toLocaleDateString('he-IL',{month:'long',year:'numeric'});
  const dim = new Date(calY,calM+1,0).getDate();
  const fd = new Date(calY,calM,1).getDay();
  
  for(let i=0;i<fd;i++) g.appendChild(document.createElement('div'));
  
  for(let d=1;d<=dim;d++){
    const cell=document.createElement('div');
    const isT=d===new Date().getDate() && calM===new Date().getMonth();
    cell.className='cd'+(isT?' tod':'');
    cell.innerHTML=`<span style="font-weight:900;font-size:10px;color:${isT?'var(--blue)':'#94a3b8'}">${d}</span>`;
    
    // ×—×™×¤×•×© ××™×¨×•×¢×™× ×‘×™×•× ×”×–×” (×ª××™×›×” ×‘×›×œ ×”×¤×•×¨××˜×™×)
    events.forEach((e,ix)=>{
      const date=val(e,'date');
      const parts=date.split(/[-/]/);
      let match=false;
      // DD/MM/YYYY
      if(parts.length>=3 && parseInt(parts[0])===d && parseInt(parts[1])===(calM+1) && parseInt(parts[2])===calY) match=true;
      // YYYY-MM-DD
      if(parts.length>=3 && parseInt(parts[2])===d && parseInt(parts[1])===(calM+1) && parseInt(parts[0])===calY) match=true;
      
      if(match){
        const sp=document.createElement('div');
        sp.className='cev'+(val(e,'owner')===me?' mine':'');
        sp.innerText=val(e,'title');
        sp.onclick=(x)=>{x.stopPropagation();openV(ix)};
        cell.appendChild(sp);
      }
    });
    g.appendChild(cell);
  }
}

function renTasks(){
  const c=id('tListMain'); c.innerHTML='';
  const f=id('tFil').value;
  const op=events.filter(e=>{
    const st=val(e,'status');
    if(st==='×‘×•×¦×¢') return false;
    if(f && val(e,'owner')!==f) return false;
    return true;
  });
  
  if(!op.length) c.innerHTML='<div style="text-align:center;color:#cbd5e1;margin-top:40px">××™×Ÿ ××©×™××•×ª</div>';
  
  op.forEach(e=>{
    const ts=getTasks(e);
    if(!ts.length) return;
    const card=document.createElement('div');
    card.style.cssText='background:white;padding:12px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.03)';
    card.innerHTML=`<div style="font-weight:700;font-size:13px;margin-bottom:6px">${val(e,'title')}</div>`;
    ts.forEach(t=>{
      card.innerHTML+=`<div style="font-size:12px;padding:4px 0;border-top:1px solid #f1f5f9">â–ª ${t}</div>`;
    });
    const b=document.createElement('button');
    b.innerText='×¤×ª×—'; b.style.cssText='font-size:11px;color:var(--blue);font-weight:700;margin-top:6px';
    b.onclick=()=>openV(events.indexOf(e));
    card.appendChild(b);
    c.appendChild(card);
  });
}

function openV(idx){
  const e=events[idx]; if(!e)return;
  vIdx=idx;
  id('ivT').innerText=val(e,'title');
  id('ivD').innerText=val(e,'date');
  id('ivO').innerText=val(e,'owner');
  id('ivDesc').innerText=val(e,'desc');
  id('ivS').innerText=val(e,'status');
  
  const im=val(e,'img');
  if(im && im.length>50) { id('ivImg').src=im; id('ivImg').style.display='block'; id('ivPH').style.display='none'; }
  else { id('ivImg').style.display='none'; id('ivPH').style.display='flex'; }
  
  renViewTasks(e);
  id('mView').style.display='flex';
}

function renViewTasks(e){
  const c=id('ivTL'); c.innerHTML='';
  const ts=getTasks(e);
  ts.forEach((t,i)=>{
    const d=document.createElement('div'); d.className='tr';
    d.innerHTML=`<input type="checkbox"> <span style="flex:1;font-size:13px">${t}</span>`;
    d.querySelector('input').onchange=function(){
      if(this.checked){
        if(confirm('×œ××—×•×§ ××©×™××”?')){
          ts.splice(i,1);
          const str=ts.join('|');
          e.tasks=str; e.Tasks=str; e['××©×™××•×ª']=str;
          const body=new URLSearchParams({action:'update',title:val(e,'title'),tasks:str});
          fetch(SCRIPT,{method:'POST',mode:'no-cors',body});
          renViewTasks(e);
        } else this.checked=false;
      }
    };
    c.appendChild(d);
  });
}

function updSt(st){
  if(vIdx<0)return;
  const e=events[vIdx];
  e.status=st; e.Status=st; e['×¡×˜×˜×•×¡']=st;
  id('ivS').innerText=st;
  ren();
  const body=new URLSearchParams({action:'update',title:val(e,'title'),status:st});
  fetch(SCRIPT,{method:'POST',mode:'no-cors',body});
}

async function save(){
  const t=id('iaT').value; if(!t)return alert('×—×¡×¨ ×©×');
  const d=id('iaD').value;
  const o=id('iaO').value;
  const s=id('iaS').value;
  const desc=id('iaDesc').value;
  const tasks=[...id('iaTL').querySelectorAll('input')].map(x=>x.value).filter(x=>x).join('|');
  
  const btn=id('btnSave'); btn.innerText='×©×•××¨...';
  
  const body=new URLSearchParams({
    action:'create', title:t, date:d, owner:o, status:s, desc:desc, tasks:tasks, image:img64
  });
  
  await fetch(SCRIPT,{method:'POST',mode:'no-cors',body});
  
  events.unshift({Title:t, Date:d, Owner:o, Status:s, Description:desc, Tasks:tasks, Image:img64});
  ren();
  id('mAdd').style.display='none';
  btn.innerText='×©××•×¨ ×•×¡× ×›×¨×Ÿ';
  // Reset
  id('iaT').value=''; id('iaDesc').value=''; id('iaTL').innerHTML='';
}

/* UTILS */
function id(x){return document.getElementById(x)}
function sv(x){
  ['List','Cal','Tasks'].forEach(v=>{id('v'+v).classList.add('hide');id('n'+v).classList.remove('on')});
  id('v'+x).classList.remove('hide'); id('n'+x).classList.add('on');
}
function renChips(){
  const c=id('lchips'); c.innerHTML='';
  OWNERS.forEach(o=>{
    const b=document.createElement('button'); b.className='glass-btn'; b.style.color='var(--ink)'; b.style.border='1px solid var(--border)';
    b.innerText=o; b.onclick=()=>{id('lname').value=o};
    c.appendChild(b);
  });
}
function login(){
  const n=id('lname').value; if(!n)return;
  me=n; localStorage.setItem('user',n);
  id('lw').style.display='none'; id('app').style.display='block';
  id('uName').innerText=n;
  ren();
}
function addTR(cid){
  const c=id(cid);
  const d=document.createElement('div'); d.className='tr';
  d.innerHTML=`<input style="flex:1;outline:none" placeholder="××©×™××”...">`;
  c.appendChild(d);
}
function hImg(){
  const f=id('iaImg').files[0];
  const r=new FileReader();
  r.onload=e=>{
    const img=new Image(); img.src=e.target.result;
    img.onload=()=>{
      const cv=document.createElement('canvas'); const x=cv.getContext('2d');
      const s=500/img.width; cv.width=500; cv.height=img.height*s;
      x.drawImage(img,0,0,500,cv.height);
      img64=cv.toDataURL('image/jpeg',0.6);
      id('iaImgTxt').innerText='×ª××•× ×” ××•×›× ×”';
    }
  };
  r.readAsDataURL(f);
}
function fillSel(){
  const s=id('iaO'); s.innerHTML='<option value="">×‘×—×¨...</option>';
  const f=id('tFil'); f.innerHTML='<option value="">×›×•×œ×</option>';
  OWNERS.forEach(o=>{
    s.innerHTML+=`<option>${o}</option>`;
    f.innerHTML+=`<option>${o}</option>`;
  });
}
function setS(b,v){
  id('iaS').value=v;
  b.parentElement.querySelectorAll('button').forEach(x=>{
    x.style.background='white'; x.style.color='#94a3b8'; x.style.borderColor='transparent';
  });
  const c={×—×“×©:'#dbeafe',×‘×˜×™×¤×•×œ:'#fef3c7',×‘×•×¦×¢:'#d1fae5'};
  const t={×—×“×©:'#1e40af',×‘×˜×™×¤×•×œ:'#92400e',×‘×•×¦×¢:'#065f46'};
  b.style.background=c[v]; b.style.color=t[v]; b.style.borderColor=t[v];
}
function cls(s){
  if(s.includes('×‘×•×¦×¢'))return 'p-done';
  if(s.includes('×˜×™×¤×•×œ'))return 'p-wip';
  return 'p-new';
}
function getTasks(e){
  const t=val(e,'tasks');
  return t?t.split('|').filter(x=>x.trim()):[];
}
function pDate(s){
  if(!s)return 0;
  const p=s.split(/[-/]/);
  if(p[0].length===4) return new Date(p[0],p[1]-1,p[2]); // YYYY-MM-DD
  return new Date(p[2],p[1]-1,p[0]); // DD/MM/YYYY
}
</script>
</body>
</html>
