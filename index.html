<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Bat Yam 100</title>

  <!-- FAVICON (×©×™× ×‘×ª×™×§×™×™×” favicon.ico + ××•×¤×¦×™×•× ×œ×™ favicon.png) -->
  <link rel="icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="favicon.png">

  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&family=Frank+Ruhl+Libre:wght@400;700;900&display=swap" rel="stylesheet" />

  <style>
    :root{
      --ink:#0d1b2a;
      --blue:#0057a8;
      --sky:#2196f3;
      --gold:#f5a623;
      --mint:#00b89c;
      --bg:#f4f6f9;
      --card:#ffffff;
      --border:#e4e9f0;
      --muted:#7a8899;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      background:var(--bg);
      font-family:'Heebo',sans-serif;
      color:var(--ink);
      -webkit-tap-highlight-color:transparent;
      overscroll-behavior-y:none;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes up{from{transform:translateY(110%)}to{transform:translateY(0)}}
    @keyframes pop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
    @keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

    /* LOADER */
    #ldr{
      position:fixed;inset:0;background:var(--ink);z-index:9999;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      transition:opacity .5s;
    }
    #ldr .ring{
      width:60px;height:60px;border:3px solid rgba(255,255,255,.12);
      border-top-color:var(--gold);border-radius:50%;
      animation:spin 1s linear infinite;margin-bottom:18px;
    }
    #ldr p{color:rgba(255,255,255,.4);font-size:10px;font-weight:900;letter-spacing:.2em;text-transform:uppercase}

    /* HERO */
    .hero{
      position:relative;height:220px;
      border-radius:0 0 28px 28px;overflow:hidden;background:var(--ink);
      box-shadow:0 18px 40px -12px rgba(13,27,42,.6);
    }
    .hero-bg{
      background-image:url('baner.jpg');
      background-size:cover;background-position:center;
      position:absolute;inset:0;opacity:.55;
    }
    .hero-stripe{
      position:absolute;bottom:0;left:0;right:0;height:4px;
      background:linear-gradient(90deg,var(--gold) 0%,var(--mint) 50%,var(--sky) 100%);
    }
    .hero-c{
      position:relative;z-index:2;padding:18px 18px;
      height:100%;display:flex;flex-direction:column;justify-content:space-between;
    }
    .glass-pill{
      background:rgba(255,255,255,.14);
      backdrop-filter:blur(14px);
      border:1px solid rgba(255,255,255,.22);
      color:white;border-radius:40px;
      display:inline-flex;align-items:center;gap:7px;
      padding:7px 14px;font-size:12px;font-weight:900;
      cursor:pointer;transition:all .18s;
    }
    .glass-pill:active{transform:scale(.94);background:rgba(255,255,255,.28)}
    .glass-ic{
      background:rgba(255,255,255,.14);
      backdrop-filter:blur(14px);
      border:1px solid rgba(255,255,255,.22);
      color:white;border-radius:50%;
      width:38px;height:38px;
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;transition:all .18s;
    }
    .glass-ic:active{transform:scale(.92)}
    /* ×©×™× ×•×™ ×¤×•× ×˜ BAT-YAM */
    .hero-title{
      font-family:'Heebo',sans-serif;
      font-size:40px;font-weight:900;color:white;
      line-height:.95;letter-spacing:-1px;
      text-shadow:0 2px 16px rgba(0,0,0,.35);
    }
    .hero-title span{
      font-family:'Frank Ruhl Libre',serif;
      color:var(--gold);
      letter-spacing:-1px;
    }
    .hero-sub{color:rgba(255,255,255,.72);font-size:13px;font-weight:400;margin-top:6px}
    .hero-dot{width:8px;height:8px;border-radius:50%;background:#4ade80;animation:pulse 2s infinite}

    /* STATS */
    .stats-row{
      display:flex;gap:10px;padding:0 16px;margin:-18px 0 10px;position:relative;z-index:5;
    }
    .stat{
      flex:1;background:var(--card);
      border-radius:16px;padding:12px 12px;
      box-shadow:0 4px 18px rgba(0,0,0,.08);
      border-top:3px solid transparent;
      animation:fade .4s ease both;
    }
    .stat:nth-child(1){border-top-color:var(--blue)}
    .stat:nth-child(2){border-top-color:var(--mint);animation-delay:.08s}
    .stat:nth-child(3){border-top-color:var(--gold);animation-delay:.16s}
    .stat-num{font-size:30px;font-weight:900;line-height:1}
    .stat-lbl{font-size:10px;font-weight:900;color:var(--muted);margin-top:3px;text-transform:uppercase;letter-spacing:.04em}

    /* TOP NAV â€” ×¦××•×“ ×œ××¢×œ×” */
    .nav{
      position:sticky;top:0;z-index:50;
      margin:10px 14px 10px;
      background:var(--ink);
      padding:8px 10px;border-radius:18px;
      display:flex;justify-content:space-between;align-items:center;
      box-shadow:0 12px 28px -8px rgba(13,27,42,.45);
    }
    .nb{
      padding:10px 12px;border-radius:14px;
      color:rgba(255,255,255,.45);
      display:flex;flex-direction:column;align-items:center;gap:3px;
      font-size:9px;font-weight:900;letter-spacing:.04em;
      background:none;border:none;cursor:pointer;
      transition:all .2s;text-transform:uppercase;
    }
    .nb.on{color:white;background:rgba(255,255,255,.12)}
    .nadd{
      background:var(--gold);
      color:var(--ink);padding:12px;border-radius:16px;
      box-shadow:0 6px 18px rgba(245,166,35,.45);
      border:3px solid var(--ink);
      cursor:pointer;transition:all .18s;
    }
    .nadd:active{transform:scale(.92)}
    .badge{position:absolute;top:6px;right:6px;width:8px;height:8px;background:#ef4444;border-radius:50%;border:2px solid var(--ink);}

    /* SECTION HEADER */
    .sec-head{display:flex;justify-content:space-between;align-items:center;padding:0 16px;margin:10px 0 12px}
    .sec-title{
      font-size:12px;font-weight:900;color:var(--ink);
      display:flex;align-items:center;gap:8px;
      text-transform:uppercase;letter-spacing:.06em;
    }
    .sec-title::before{content:'';width:3px;height:16px;background:var(--blue);border-radius:2px;display:block}

    /* EVENT CARD */
    #eCards{display:grid;grid-template-columns:1fr;gap:10px;padding:0 16px 22px}
    @media(min-width:900px){
      #app{max-width:1100px!important}
      #eCards{grid-template-columns:repeat(2,1fr)}
    }
    @media(min-width:1300px){
      #eCards{grid-template-columns:repeat(3,1fr)}
    }
    .ecard{
      background:var(--card);border-radius:18px;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
      border:1px solid var(--border);
      display:flex;align-items:stretch;overflow:hidden;cursor:pointer;
      transition:transform .15s, box-shadow .15s;
      animation:fade .35s ease both;
    }
    .ecard:active{transform:scale(.98);box-shadow:0 1px 7px rgba(0,0,0,.07)}
    .ecard-accent{width:5px;flex-shrink:0;background:var(--blue)}
    .ecard-accent.mine{background:var(--mint)}
    .ecard-accent.done{background:#d1d5db}
    .ecard-date{
      width:60px;flex-shrink:0;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      padding:12px 0;border-left:1px solid var(--border);background:#fafbfc;
    }
    .ecard-date .day{font-size:24px;font-weight:900;line-height:1}
    .ecard-date .day.range{font-size:15px;font-weight:900;color:var(--blue)}
    .ecard-date .mon{font-size:9px;font-weight:900;color:var(--muted);text-transform:uppercase;margin-top:2px}
    .ecard-body{flex:1;padding:12px 12px 12px 10px;min-width:0}
    .ecard-title{font-size:15px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:6px}
    .ecard-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .ecard-owner{font-size:11px;color:var(--muted);font-weight:700}

    /* STATUS PILL */
    .pill{display:inline-block;padding:3px 9px;border-radius:20px;font-size:10px;font-weight:900;letter-spacing:.02em;white-space:nowrap}
    .pill-new{background:#dbeafe;color:#1e40af}
    .pill-wip{background:#fef3c7;color:#92400e}
    .pill-done{background:#d1fae5;color:#065f46}
    .pill-wait{background:#f3f4f6;color:#4b5563}

    /* TASK ROW */
    .tr{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;background:#f8fafc;
      border-radius:10px;border:1px solid var(--border);
      transition:all .15s;
    }
    .tr input[type=checkbox]{width:18px;height:18px;accent-color:var(--blue);cursor:pointer;flex-shrink:0}
    .tr.done span{text-decoration:line-through;color:var(--muted)}

    /* OVERLAY / SHEET */
    .ov{
      position:fixed;inset:0;background:rgba(13,27,42,.7);
      display:flex;align-items:flex-end;justify-content:center;
      z-index:150;backdrop-filter:blur(6px);
    }
    @media(min-width:900px){.ov{align-items:center;padding:20px}}
    .sh{
      background:var(--card);width:100%;max-width:520px;
      border-radius:28px 28px 0 0;
      display:flex;flex-direction:column;max-height:92vh;
      animation:up .32s cubic-bezier(.16,1,.3,1);
      box-shadow:0 -8px 48px rgba(13,27,42,.25);
    }
    @media(min-width:900px){.sh{border-radius:28px;max-height:85vh}}
    .sh-head{
      padding:16px 18px;display:flex;justify-content:space-between;align-items:center;
      border-bottom:1px solid var(--border);flex-shrink:0;
    }
    .sh-title{font-size:18px;font-weight:900}
    .sh-hide::-webkit-scrollbar{display:none}
    .sh-hide{-ms-overflow-style:none;scrollbar-width:none}

    /* FORM */
    .fld{
      width:100%;padding:12px 14px;background:#f8fafc;border-radius:12px;
      border:1.5px solid var(--border);outline:none;
      font-family:'Heebo',sans-serif;font-size:14px;color:var(--ink);
      transition:all .2s;
    }
    .fld:focus{border-color:var(--blue);background:white;box-shadow:0 0 0 3px rgba(0,87,168,.1)}
    .fld-lg{font-size:16px;font-weight:900;padding:14px}
    label.lbl{font-size:10px;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:6px}
    .sb{
      flex:1;padding:9px 6px;border-radius:12px;font-weight:900;font-size:12px;
      border:2px solid var(--border);background:#f8fafc;color:var(--muted);
      cursor:pointer;font-family:'Heebo',sans-serif;transition:all .15s;
    }
    .sb.active-n{border-color:#93c5fd;background:#dbeafe;color:#1e40af}
    .sb.active-w{border-color:#fcd34d;background:#fef3c7;color:#92400e}
    .sb.active-d{border-color:#6ee7b7;background:#d1fae5;color:#065f46}
    .close-btn{
      width:34px;height:34px;border-radius:50%;
      background:#f1f5f9;border:none;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }
    .add-task-btn{
      color:var(--blue);font-size:12px;font-weight:900;
      background:#eff6ff;border:none;border-radius:8px;
      padding:6px 10px;cursor:pointer;font-family:'Heebo',sans-serif;
    }

    /* LOGIN */
    .lw{position:fixed;inset:0;background:var(--ink);z-index:200;display:flex;align-items:center;justify-content:center;padding:24px}
    .lb{background:white;border-radius:28px;padding:34px 26px;width:100%;max-width:360px;text-align:center;animation:pop .38s cubic-bezier(.16,1,.3,1)}
    .lb-top{height:5px;margin:-34px -26px 26px;background:linear-gradient(90deg,var(--gold),var(--mint),var(--sky));border-radius:28px 28px 0 0}
    .chip{
      padding:10px 18px;border-radius:40px;border:2px solid var(--border);
      cursor:pointer;font-weight:900;font-size:14px;background:white;
      transition:all .15s;color:var(--ink);
    }
    .chip.sel{border-color:var(--blue);background:#eff6ff;color:var(--blue)}
  </style>
</head>

<body>
  <!-- LOADER -->
  <div id="ldr">
    <div class="ring"></div>
    <p>BAT YAM 100</p>
  </div>

  <!-- LOGIN -->
  <div id="lw" class="lw" style="display:none">
    <div class="lb">
      <div class="lb-top"></div>
      <div style="font-size:36px;margin-bottom:12px">ğŸ™ï¸</div>
      <h2 style="font-size:24px;font-weight:900;color:var(--ink);margin-bottom:4px;font-family:'Frank Ruhl Libre',serif">BAT YAM 100</h2>
      <p style="color:var(--muted);font-size:13px;margin-bottom:22px">××™ ××ª/×”?</p>
      <div id="lchips" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:16px"></div>
      <input id="lname" type="text" placeholder="×©× ××—×¨..." class="fld" style="text-align:center;margin-bottom:14px">
      <button id="lbtn" style="width:100%;background:var(--ink);color:white;padding:14px;border-radius:14px;font-weight:900;font-size:15px;border:none;cursor:pointer;font-family:'Heebo',sans-serif;letter-spacing:.03em">
        ×›× ×™×¡×” â†
      </button>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none" class="max-w-5xl mx-auto">

    <!-- HERO -->
    <div class="hero">
      <div class="hero-bg"></div>
      <div class="hero-c">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <button id="btnUser" class="glass-pill">
            <span class="hero-dot"></span>
            <span id="uLabel">××•×¨×—</span>
            <i data-lucide="chevron-down" style="width:13px;height:13px;opacity:.7"></i>
          </button>
          <div style="display:flex;gap:8px">
            <button id="btnRefresh" class="glass-ic"><i data-lucide="refresh-cw" style="width:17px;height:17px"></i></button>
          </div>
        </div>
        <div>
          <div class="hero-title">BAT YAM<br><span>100</span></div>
          <p class="hero-sub">× ×™×”×•×œ ×¤×¨×•×™×§×˜×™× ×¢×™×¨×•× ×™ Â· 2026</p>
        </div>
      </div>
      <div class="hero-stripe"></div>
    </div>

    <!-- STATS -->
    <div class="stats-row">
      <div class="stat">
        <div id="stT" class="stat-num">0</div>
        <div class="stat-lbl">×¤×¨×•×™×§×˜×™×</div>
      </div>
      <div class="stat">
        <div id="stM" class="stat-num">0</div>
        <div class="stat-lbl">×©×œ×™</div>
      </div>
      <div class="stat">
        <div id="stA" class="stat-num">0</div>
        <div class="stat-lbl">×‘×˜×™×¤×•×œ</div>
      </div>
    </div>

    <!-- TOP NAV -->
    <div class="nav">
      <button id="nb-list" class="nb on"><i data-lucide="home" style="width:20px;height:20px"></i><span>×‘×™×ª</span></button>
      <button id="nb-tasks" class="nb" style="position:relative">
        <i data-lucide="check-square" style="width:20px;height:20px"></i><span>××©×™××•×ª</span>
        <span id="tbadge" class="badge" style="display:none"></span>
      </button>
      <button id="nb-add" class="nadd"><i data-lucide="plus" style="width:24px;height:24px"></i></button>
      <button id="nb-done" class="nb"><i data-lucide="badge-check" style="width:20px;height:20px"></i><span>×‘×•×¦×¢×•</span></button>
      <button id="nb-set" class="nb"><i data-lucide="user" style="width:20px;height:20px"></i><span>×¤×¨×•×¤×™×œ</span></button>
    </div>

    <!-- LIST VIEW -->
    <div id="vList">
      <div class="sec-head">
        <span class="sec-title">×›×œ ×”×¤×¨×•×™×§×˜×™×</span>
        <span id="countBadge" style="font-size:11px;font-weight:900;color:var(--muted)"></span>
      </div>
      <div id="eCards"></div>
    </div>

    <!-- TASKS OPEN VIEW -->
    <div id="vTasks" style="display:none">
      <div class="sec-head">
        <span class="sec-title">××©×™××•×ª ×‘×‘×™×¦×•×¢</span>
        <select id="tFilter" style="font-size:11px;font-weight:900;background:var(--card);border:1.5px solid var(--border);border-radius:10px;padding:6px 12px;outline:none;font-family:'Heebo',sans-serif;color:var(--ink);cursor:pointer">
          <option value="">×›×•×œ×</option>
        </select>
      </div>
      <div id="tCards" style="display:flex;flex-direction:column;gap:10px;padding:0 16px 22px"></div>
    </div>

    <!-- TASKS DONE VIEW -->
    <div id="vDone" style="display:none">
      <div class="sec-head">
        <span class="sec-title">××©×™××•×ª ×©×‘×•×¦×¢×•</span>
        <select id="dFilter" style="font-size:11px;font-weight:900;background:var(--card);border:1.5px solid var(--border);border-radius:10px;padding:6px 12px;outline:none;font-family:'Heebo',sans-serif;color:var(--ink);cursor:pointer">
          <option value="">×›×•×œ×</option>
        </select>
      </div>
      <div id="dCards" style="display:flex;flex-direction:column;gap:10px;padding:0 16px 22px"></div>
    </div>
  </div>

  <!-- ADD MODAL -->
  <div id="mAdd" class="ov" style="display:none">
    <div class="sh" style="height:92vh">
      <div class="sh-head">
        <span class="sh-title">×¤×¨×•×™×§×˜ ×—×“×©</span>
        <button id="mAddClose" class="close-btn"><i data-lucide="x" style="width:17px;height:17px;color:var(--muted)"></i></button>
      </div>

      <div style="flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:16px" class="sh-hide">
        <div>
          <label class="lbl">×©× ×”×¤×¨×•×™×§×˜ *</label>
          <input id="inT" type="text" class="fld fld-lg" placeholder="×©× ×”×¤×¨×•×™×§×˜...">
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label class="lbl">×ª××¨×™×š ×”×ª×—×œ×”</label>
            <input id="inD" type="date" class="fld">
          </div>
          <div>
            <label class="lbl">×ª××¨×™×š ×¡×™×•× (××•×¤×¦×™×•× ×œ×™)</label>
            <input id="inDEnd" type="date" class="fld">
          </div>
        </div>

        <div>
          <label class="lbl">××—×¨××™</label>
          <select id="inO" class="fld">
            <option value="">×‘×—×¨ ××—×¨××™...</option>
          </select>
        </div>

        <div>
          <label class="lbl">×¡×˜×˜×•×¡</label>
          <div id="sBtns" style="display:flex;gap:8px">
            <button class="sb active-n" data-v="×—×“×©">×—×“×©</button>
            <button class="sb" data-v="×‘×˜×™×¤×•×œ">×‘×˜×™×¤×•×œ</button>
            <button class="sb" data-v="×‘×•×¦×¢">×‘×•×¦×¢</button>
          </div>
          <input type="hidden" id="inS" value="×—×“×©">
        </div>

        <div>
          <label class="lbl">×ª×™××•×¨</label>
          <textarea id="inDesc" rows="3" class="fld" style="resize:none" placeholder="×ª×™××•×¨, ×”×¢×¨×•×ª..."></textarea>
        </div>

        <div style="background:#f8fafc;padding:14px;border-radius:14px;border:1.5px solid var(--border)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <label class="lbl" style="margin:0">××©×™××•×ª</label>
            <button id="btnAddTask" class="add-task-btn">+ ×”×•×¡×£ ××©×™××”</button>
          </div>
          <div id="tList" style="display:flex;flex-direction:column;gap:8px"></div>
          <div style="font-size:11px;color:var(--muted);margin-top:8px">
            ×˜×™×¤: ×¡××Ÿ ××©×™××” ×›×‘×•×¦×¢×” ××ª×•×š â€œ×¤×ª×— ×¤×¨×•×™×§×˜â€.
          </div>
        </div>

        <label style="display:flex;align-items:center;gap:12px;padding:14px;border:2px dashed var(--border);border-radius:14px;cursor:pointer">
          <input type="file" id="inImg" style="display:none" accept="image/*">
          <i data-lucide="image-plus" style="width:20px;height:20px;color:var(--muted)"></i>
          <div>
            <span id="imgSt" style="font-size:13px;font-weight:900;color:var(--muted);display:block">×”×•×¡×£ ×ª××•× ×”</span>
            <span style="font-size:10px;color:#cbd5e1">×¢×“ ~37KB</span>
          </div>
        </label>

        <div id="imgPW" style="display:none;height:140px;border-radius:12px;overflow:hidden;border:1px solid var(--border)">
          <img id="imgPE" style="width:100%;height:100%;object-fit:cover">
        </div>
      </div>

      <div style="padding:14px;border-top:1.5px solid var(--border)">
        <button id="saveBtn" style="width:100%;background:var(--ink);color:white;padding:16px;border-radius:14px;font-weight:900;font-size:15px;border:none;cursor:pointer;font-family:'Heebo',sans-serif;box-shadow:0 4px 18px rgba(13,27,42,.35)">
          ×©××•×¨ â†
        </button>
      </div>
    </div>
  </div>

  <!-- VIEW MODAL -->
  <div id="mView" class="ov" style="display:none">
    <div class="sh" style="height:90vh">
      <div class="sh-head">
        <span class="sh-title" id="vHead">×¤×¨×•×™×§×˜</span>
        <button id="mViewClose" class="close-btn"><i data-lucide="x" style="width:17px;height:17px;color:var(--muted)"></i></button>
      </div>

      <div style="flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:12px" class="sh-hide">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div>
            <div id="vT" style="font-size:20px;font-weight:900;font-family:'Frank Ruhl Libre',serif"></div>
            <div id="vMeta" style="margin-top:6px;color:var(--muted);font-size:12px;font-weight:700"></div>
          </div>
          <div id="vPill"></div>
        </div>

        <div id="vsBtns" style="display:flex;gap:8px">
          <button class="vsb sb" data-v="×—×“×©">×—×“×©</button>
          <button class="vsb sb" data-v="×‘×˜×™×¤×•×œ">×‘×˜×™×¤×•×œ</button>
          <button class="vsb sb" data-v="×‘×•×¦×¢">×‘×•×¦×¢</button>
        </div>

        <div id="vDesc" style="font-size:13px;line-height:1.7;background:#f8fafc;padding:14px;border-radius:12px;border:1px solid var(--border)"></div>

        <div style="background:#f8fafc;padding:14px;border-radius:14px;border:1.5px solid var(--border)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <span style="font-size:10px;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em">××©×™××•×ª</span>
            <button id="btnVAddTask" class="add-task-btn">+ ×”×•×¡×£</button>
          </div>
          <div id="vtList" style="display:flex;flex-direction:column;gap:8px"></div>

          <button id="btnSaveTasks" style="margin-top:12px;width:100%;background:var(--ink);color:white;padding:12px;border-radius:12px;font-weight:900;border:none;cursor:pointer">
            ×©××•×¨ ××©×™××•×ª
          </button>
        </div>

        <button id="btnDelete" style="width:100%;background:#fff;color:#dc2626;padding:12px;border-radius:12px;font-weight:900;border:2px solid #fecaca;cursor:pointer">
          ××—×§ ×¤×¨×•×™×§×˜
        </button>
      </div>
    </div>
  </div>

<script>
/* ===============================
   CONFIG â€” ×›×‘×¨ ×¢×•×“×›×Ÿ ×¢× ×”Ö¾URL ×©×œ×š âœ…
   =============================== */
const API = "https://script.google.com/macros/s/AKfycbw5px8YbyPnu2ZBhMXYS2i-mf9uebsDAXe4NFNIusfP7veYOw11qD84AOH68o0HSRZK3g/exec";

let OWNERS = ['×‘×Ÿ','×¨×™× ×ª','×’×œ×™×ª','××‘×™×©×™','××•×¨','×™×•×¡×™','×¨×•×ª×'];
let events = [];
let me = localStorage.getItem('batyam_user') || '';
let img64 = '';
let viewIdx = -1;

window.addEventListener('DOMContentLoaded', () => {
  lucide.createIcons();
  wire();
  me ? boot() : showLogin();
});

const id = x => document.getElementById(x);
function show(x){ id(x).style.display='block'; }
function hide(x){ id(x).style.display='none'; }
function showFlex(x){ id(x).style.display='flex'; }
function showOv(x){ id(x).style.display='flex'; lucide.createIcons(); }

function showLogin(){ hideLoaderNow(); showFlex('lw'); buildChips('lchips'); }
function boot(){
  id('uLabel').textContent = me;
  show('app');
  loadData(true);
  setInterval(() => loadData(true), 30000);
}

function wire(){
  id('lbtn').onclick = doLogin;
  id('lname').onkeydown = e => { if(e.key==='Enter') doLogin(); };

  id('nb-list').onclick  = () => sv('List');
  id('nb-tasks').onclick = () => sv('Tasks');
  id('nb-done').onclick  = () => sv('Done');
  id('nb-add').onclick   = openAdd;
  id('nb-set').onclick   = openSet;

  id('btnUser').onclick    = openSet;
  id('btnRefresh').onclick = () => loadData(true);

  id('mAddClose').onclick = closeAdd;
  id('btnAddTask').onclick = () => addRow('tList');
  id('saveBtn').onclick = saveProject;
  id('inImg').onchange = handleImg;

  id('sBtns').onclick = e => {
    const b = e.target.closest('.sb'); if(!b || !b.dataset.v) return;
    id('inS').value = b.dataset.v;
    id('sBtns').querySelectorAll('.sb').forEach(x => x.className='sb');
    const cls = {×—×“×©:'sb active-n',×‘×˜×™×¤×•×œ:'sb active-w',×‘×•×¦×¢:'sb active-d'};
    b.className = cls[b.dataset.v] || 'sb';
  };

  id('mViewClose').onclick = () => hide('mView');
  id('btnVAddTask').onclick = () => addRow('vtList');
  id('btnSaveTasks').onclick = saveTasksOnly;
  id('btnDelete').onclick = deleteProject;

  id('vsBtns').onclick = e => {
    const b = e.target.closest('.vsb'); if(!b) return;
    changeProjectStatus(b.dataset.v);
  };

  id('tFilter').onchange = renderTasksOpen;
  id('dFilter').onchange = renderTasksDone;

  ['mAdd','mView'].forEach(x => {
    id(x).onclick = e => { if(e.target.id===x) hide(x); };
  });
}

function hideLoaderNow(){ id('ldr').style.display='none'; }
function hideLoader(){
  const l = id('ldr');
  l.style.transition='opacity .5s';
  l.style.opacity='0';
  setTimeout(()=>{ l.style.display='none'; }, 520);
}

/* Login/Profile */
function buildChips(cid){
  const c = id(cid); c.innerHTML='';
  OWNERS.forEach(n=>{
    const b=document.createElement('button');
    b.className='chip' + (n===me?' sel':'');
    b.textContent=n;
    b.onclick=()=>{ c.querySelectorAll('.chip').forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); };
    c.appendChild(b);
  });
}
function getChip(cid, iid){
  const s=document.querySelector(`#${cid} .chip.sel`);
  return s ? s.textContent : (id(iid)?.value.trim()||'');
}
function doLogin(){
  const n=getChip('lchips','lname');
  if(!n){ alert('×‘×—×¨/×™ ×©×'); return; }
  localStorage.setItem('batyam_user', n);
  me=n;
  hide('lw');
  boot();
}
function openSet(){
  const name = prompt('×”×§×œ×“/×™ ×©× ××©×ª××©:');
  if(!name) return;
  localStorage.setItem('batyam_user', name.trim());
  me=name.trim();
  id('uLabel').textContent = me;
  loadData(true);
}

/* Data */
async function apiGet(){
  const url = `${API}?action=read&t=${Date.now()}`;
  const r = await fetch(url, { method:'GET' });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || 'API error');
  return j.rows || [];
}
async function apiPost(params){
  const body = new URLSearchParams(params);
  const r = await fetch(API, {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body: body.toString()
  });
  const txt = await r.text();
  try { return JSON.parse(txt); } catch { return { ok:true, raw:txt }; }
}

function normalizeRow(row){
  const e = {};
  e.id    = String(row.ID ?? row.Id ?? row.id ?? '').trim();
  e.title = String(row.Title ?? row.title ?? '').trim();
  e.date  = String(row.Date ?? row.date ?? '').trim();
  e.owner = String(row.Owner ?? row.owner ?? '').trim();
  e.desc  = String(row.Desc ?? row.Description ?? row.desc ?? '').trim();
  e.status= String(row.Status ?? row.status ?? '×—×“×©').trim();
  e.image = String(row.Image ?? row.image ?? '').trim();

  const tcell = row.TasksJSON ?? row.Tasks ?? row.tasks ?? '[]';
  e.tasks = parseTasksCell(String(tcell ?? '[]'));
  return e;
}

async function loadData(manual=false){
  if(manual){
    id('ldr').style.cssText='position:fixed;inset:0;background:var(--ink);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:1';
    id('ldr').style.opacity='1';
    id('ldr').style.display='flex';
  }
  try{
    const rows = await apiGet();
    const fresh = rows.map(r => normalizeRow(r)).filter(e => e.title);

    events.length = 0;
    events.push(...fresh);

    events.forEach(e=>{
      (e.owner||'').split(/[+,]/).map(x=>x.trim()).filter(Boolean).forEach(o=>{
        if(o && !OWNERS.includes(o)) OWNERS.push(o);
      });
    });

    fillOwnerSelect();
    buildFilters();
    renderAll();
    hideLoader();
  }catch(err){
    console.error(err);
    hideLoader();
    alert('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×. ×‘×“×•×§ WebApp "Anyone" ×•×©×”-URL × ×›×•×Ÿ');
  }
}

/* Tasks */
function parseTasksCell(cell){
  const s = (cell || '').trim();
  if(!s) return [];
  if(s.startsWith('[')){
    try{
      const arr = JSON.parse(s);
      return (Array.isArray(arr) ? arr : []).map(x => ({
        text: String(x.text || '').trim(),
        done: !!x.done
      })).filter(x=>x.text);
    }catch{
      return [];
    }
  }
  return s.split('|').map(t=>t.trim()).filter(Boolean).map(t=>({text:t,done:false}));
}
function encodeTasks(arr){
  return JSON.stringify((arr||[]).map(x=>({text:String(x.text||'').trim(), done:!!x.done})).filter(x=>x.text));
}

/* Date */
function parseSingle(s){
  if(!s) return null; s=s.trim();
  let m=s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m) return new Date(+m[3], +m[2]-1, +m[1]);
  m=s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m) return new Date(+m[1], +m[2]-1, +m[3]);
  return null;
}
function parseEventDate(raw){
  if(!raw) return {start:null,end:null,isRange:false};
  raw=raw.trim();
  const rm=raw.match(/^(\d{1,2}\/\d{1,2}\/\d{4})\s*-\s*(\d{1,2}\/\d{1,2}\/\d{4})$/);
  if(rm) return {start:parseSingle(rm[1]), end:parseSingle(rm[2]), isRange:true};
  const s=parseSingle(raw);
  return {start:s,end:null,isRange:false};
}
function fmtEventDate(raw){
  const {start,end,isRange} = parseEventDate(raw);
  if(!start) return raw||'';
  const opts={day:'numeric',month:'long'};
  if(isRange && end){
    const s=start.toLocaleDateString('he-IL', opts);
    const e=end.toLocaleDateString('he-IL', {day:'numeric',month:'long',year:'numeric'});
    return `${s} â€“ ${e}`;
  }
  return start.toLocaleDateString('he-IL', {day:'numeric',month:'long',year:'numeric'});
}
function getDisplayDay(raw){
  const {start,end,isRange}=parseEventDate(raw);
  if(!start) return {day:'?',isRange:false};
  if(isRange && end) return {day:`${start.getDate()}â€“${end.getDate()}`,isRange:true};
  return {day:String(start.getDate()),isRange:false};
}
function getMonthLabel(raw){
  const {start}=parseEventDate(raw);
  if(!start) return '';
  return start.toLocaleDateString('he-IL',{month:'short'});
}

/* Render */
function pillClass(st){
  if(!st) return 'pill pill-new';
  if(st.includes('×‘×•×¦×¢') || st.includes('×ª×•××')) return 'pill pill-done';
  if(st.includes('×˜×™×¤×•×œ') || st.includes('×—×•×–×™×') || st.includes('×”×–×× ×”') || st.includes('×ª×”×œ×™×š')) return 'pill pill-wip';
  if(st.includes('×××ª×™×Ÿ') || st.includes('×ª×•××—×¨')) return 'pill pill-wait';
  return 'pill pill-new';
}

function renderAll(){
  renderList();
  renderTasksOpen();
  renderTasksDone();
  updateStats();
  lucide.createIcons();
}
function updateStats(){
  id('stT').textContent = events.length;
  id('stM').textContent = events.filter(e => (e.owner||'').includes(me)).length;
  id('stA').textContent = events.filter(e => (e.status||'').includes('×˜×™×¤×•×œ') || (e.status||'').includes('×ª×”×œ×™×š') || (e.status||'').includes('×”×–×× ×”')).length;
  id('countBadge').textContent = events.length + ' ×¤×¨×•×™×§×˜×™×';
  const myOpenTasks = countMyOpenTasks();
  id('tbadge').style.display = myOpenTasks > 0 ? 'block' : 'none';
}
function countMyOpenTasks(){
  let cnt=0;
  events.forEach(e=>{
    if(!(e.owner||'').includes(me)) return;
    e.tasks.forEach(t=>{ if(!t.done) cnt++; });
  });
  return cnt;
}

function renderList(){
  const c = id('eCards'); c.innerHTML='';
  if(!events.length){
    c.innerHTML='<p style="text-align:center;color:var(--muted);padding:64px 0;font-weight:900">××™×Ÿ ×¤×¨×•×™×§×˜×™× ×¢×“×™×™×Ÿ</p>';
    return;
  }
  const sorted=[...events].sort((a,b)=>{
    const ad=parseEventDate(a.date).start;
    const bd=parseEventDate(b.date).start;
    if(!ad && !bd) return 0;
    if(!ad) return 1;
    if(!bd) return -1;
    return ad - bd;
  });

  const frag=document.createDocumentFragment();
  sorted.forEach((e, loopIdx)=>{
    const origIdx = events.indexOf(e);
    const title=e.title||'×œ×œ× ×©×';
    const raw=e.date||'';
    const owner=e.owner||'-';
    const status=e.status||'×—×“×©';
    const isMine = owner.includes(me);
    const isDone = status.includes('×‘×•×¦×¢') || status.includes('×ª×•××');
    const {day,isRange}=getDisplayDay(raw);
    const mon=getMonthLabel(raw);

    const div=document.createElement('div');
    div.className='ecard';
    div.style.animationDelay=(loopIdx*0.04)+'s';

    const accent=document.createElement('div');
    accent.className='ecard-accent' + (isDone?' done': isMine?' mine':'');
    div.appendChild(accent);

    const dateBox=document.createElement('div');
    dateBox.className='ecard-date';
    dateBox.innerHTML=`<span class="day${isRange?' range':''}">${day}</span><span class="mon">${mon}</span>`;
    div.appendChild(dateBox);

    const body=document.createElement('div');
    body.className='ecard-body';
    body.innerHTML=`
      <div class="ecard-title">${escapeHtml(title)}</div>
      <div class="ecard-meta">
        <span class="${pillClass(status)}">${escapeHtml(status)}</span>
        <span class="ecard-owner">ğŸ‘¤ ${escapeHtml(owner)}${isMine?' Â· <b style="color:var(--mint)">×©×œ×™</b>':''}</span>
      </div>`;
    div.appendChild(body);

    div.onclick=()=>openView(origIdx);
    frag.appendChild(div);
  });

  c.appendChild(frag);
}

function buildFilters(){
  const owners=[...new Set(events.map(e=>(e.owner||'').trim()).filter(Boolean))];
  const tf=id('tFilter'), df=id('dFilter');
  const curT=tf.value, curD=df.value;

  tf.innerHTML='<option value="">×›×•×œ×</option>';
  df.innerHTML='<option value="">×›×•×œ×</option>';

  owners.forEach(o=>{
    const a=document.createElement('option');
    a.value=o; a.textContent=o;
    if(o===curT) a.selected=true;
    tf.appendChild(a);

    const b=document.createElement('option');
    b.value=o; b.textContent=o;
    if(o===curD) b.selected=true;
    df.appendChild(b);
  });
}

function renderTasksOpen(){
  const c=id('tCards'); c.innerHTML='';
  const filter=id('tFilter').value;

  const blocks=[];
  events.forEach((e, idx)=>{
    if(filter && !(e.owner||'').includes(filter)) return;
    const openTasks = e.tasks.filter(t=>!t.done);
    if(!openTasks.length) return;
    blocks.push({e,idx, tasks:openTasks});
  });

  if(!blocks.length){
    c.innerHTML='<div style="text-align:center;padding:64px 0"><div style="font-size:40px;margin-bottom:10px">ğŸ‰</div><p style="color:var(--muted);font-weight:900">××™×Ÿ ××©×™××•×ª ×‘×‘×™×¦×•×¢!</p></div>';
    return;
  }

  const frag=document.createDocumentFragment();
  blocks.forEach(b=>{
    frag.appendChild(taskCard(b.e, b.idx, b.tasks));
  });
  c.appendChild(frag);
}

function renderTasksDone(){
  const c=id('dCards'); c.innerHTML='';
  const filter=id('dFilter').value;

  const blocks=[];
  events.forEach((e, idx)=>{
    if(filter && !(e.owner||'').includes(filter)) return;
    const doneTasks = e.tasks.filter(t=>t.done);
    if(!doneTasks.length) return;
    blocks.push({e,idx, tasks:doneTasks});
  });

  if(!blocks.length){
    c.innerHTML='<div style="text-align:center;padding:64px 0"><div style="font-size:40px;margin-bottom:10px">âœ…</div><p style="color:var(--muted);font-weight:900">××™×Ÿ ××©×™××•×ª ×©×‘×•×¦×¢×• ×¢×“×™×™×Ÿ</p></div>';
    return;
  }

  const frag=document.createDocumentFragment();
  blocks.forEach(b=>{
    frag.appendChild(taskCard(b.e, b.idx, b.tasks));
  });
  c.appendChild(frag);
}

function taskCard(e, idx, tasks){
  const card=document.createElement('div');
  card.className='ecard';
  card.style.flexDirection='column';
  card.style.cursor='default';

  const top=document.createElement('div');
  top.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:14px 14px 10px;border-bottom:1px solid var(--border)';
  top.innerHTML=`
    <div style="display:flex;align-items:center;gap:8px">
      <div class="ecard-accent ${(e.owner||'').includes(me)?'mine':''}" style="width:3px;height:20px;border-radius:2px;flex-shrink:0"></div>
      <h3 style="font-weight:900;color:var(--ink);font-size:13px">${escapeHtml(e.title||'â€”')}</h3>
    </div>
    <span style="font-size:11px;color:var(--muted);font-weight:900">ğŸ‘¤ ${escapeHtml(e.owner||'-')}</span>
  `;
  card.appendChild(top);

  const tw=document.createElement('div');
  tw.style.cssText='padding:10px 14px;display:flex;flex-direction:column;gap:7px';

  tasks.forEach(t=>{
    const row=document.createElement('div');
    row.className='tr' + (t.done?' done':'');
    const cb=document.createElement('input');
    cb.type='checkbox';
    cb.checked=!!t.done;
    cb.disabled=true;
    const sp=document.createElement('span');
    sp.style.fontSize='13px';
    sp.style.fontWeight='900';
    sp.textContent=t.text;
    row.appendChild(cb); row.appendChild(sp);
    tw.appendChild(row);
  });

  card.appendChild(tw);

  const foot=document.createElement('div');
  foot.style.cssText='padding:8px 14px 12px;display:flex;justify-content:flex-end';
  const ob=document.createElement('button');
  ob.style.cssText='font-size:11px;font-weight:900;color:var(--blue);background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:6px 12px;cursor:pointer;font-family:Heebo,sans-serif';
  ob.textContent='×¤×ª×— ×¤×¨×•×™×§×˜ â†';
  ob.onclick=()=>openView(idx);
  foot.appendChild(ob);
  card.appendChild(foot);

  return card;
}

/* View */
function openView(idx){
  const e=events[idx]; if(!e) return;
  viewIdx=idx;
  id('vT').textContent = e.title || '';
  id('vMeta').textContent = `ğŸ“… ${fmtEventDate(e.date||'')} Â· ğŸ‘¤ ${e.owner||'â€”'}`;
  id('vDesc').textContent = e.desc || '××™×Ÿ ×ª×™××•×¨';
  refreshVSt(e.status || '×—×“×©');
  renderViewTasks();
  showOv('mView');
}

function refreshVSt(st){
  const map={×—×“×©:'active-n',×‘×˜×™×¤×•×œ:'active-w',×‘×•×¦×¢:'active-d'};
  document.querySelectorAll('.vsb').forEach(b=>{
    b.className='vsb sb' + (b.dataset.v===st ? ' '+(map[b.dataset.v]||'') : '');
  });
  id('vPill').innerHTML = `<span class="${pillClass(st)}">${escapeHtml(st)}</span>`;
}

function renderViewTasks(){
  const e = events[viewIdx];
  const tl = id('vtList');
  tl.innerHTML = '';

  const arr = e.tasks || [];
  if(!arr.length){
    tl.innerHTML = '<span style="font-size:11px;color:#cbd5e1">××™×Ÿ ××©×™××•×ª ××•×’×“×¨×•×ª</span>';
    return;
  }

  const open = arr.filter(x => !x.done);
  const done = arr.filter(x => x.done);

  const makeHeader = (txt, count) => {
    const h = document.createElement('div');
    h.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin:10px 2px 6px';
    h.innerHTML = `
      <div style="font-weight:900;color:var(--ink);font-size:11px;letter-spacing:.04em;text-transform:uppercase">${txt}</div>
      <div style="font-size:11px;color:var(--muted);font-weight:900">${count}</div>
    `;
    return h;
  };

  const makeRow = (t, index) => {
    const row = document.createElement('div');
    row.className='tr' + (t.done?' done':'');
    row.style.background='white';

    const cb=document.createElement('input');
    cb.type='checkbox';
    cb.checked=!!t.done;
    cb.onchange=()=>{
      t.done = cb.checked;
      renderViewTasks();
    };

    const sp=document.createElement('span');
    sp.style.fontSize='13px';
    sp.style.fontWeight='900';
    sp.textContent=t.text;

    const del=document.createElement('button');
    del.type='button';
    del.style.cssText='margin-right:auto;background:none;border:none;cursor:pointer;padding:4px 6px;color:#fca5a5;display:flex;align-items:center';
    del.innerHTML='<i data-lucide="trash-2" style="width:16px;height:16px"></i>';
    del.onclick=()=>{
      events[viewIdx].tasks.splice(index,1);
      renderViewTasks();
    };

    row.appendChild(cb); row.appendChild(sp); row.appendChild(del);
    return row;
  };

  if(open.length){
    tl.appendChild(makeHeader('××©×™××•×ª ×‘×‘×™×¦×•×¢', open.length));
    open.forEach(t=>{
      const idx = events[viewIdx].tasks.indexOf(t);
      tl.appendChild(makeRow(t, idx));
    });
  }

  if(done.length){
    tl.appendChild(makeHeader('××©×™××•×ª ×©×‘×•×¦×¢×•', done.length));
    done.forEach(t=>{
      const idx = events[viewIdx].tasks.indexOf(t);
      tl.appendChild(makeRow(t, idx));
    });
  }

  lucide.createIcons();
}

async function saveTasksOnly(){
  if(viewIdx<0) return;
  const e=events[viewIdx];
  const res = await apiPost({ action:'update', id: e.id, tasks_json: encodeTasks(e.tasks) });
  if(!res.ok){ alert('×©×’×™××” ×‘×©××™×¨×ª ××©×™××•×ª'); return; }
  await loadData(true);
  alert('âœ… ××©×™××•×ª × ×©××¨×•');
}

async function changeProjectStatus(st){
  if(viewIdx<0) return;
  const e=events[viewIdx];
  e.status = st;
  refreshVSt(st);

  const res = await apiPost({ action:'update', id: e.id, status: st });
  if(!res.ok){ alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡'); return; }
  await loadData(true);
}

async function deleteProject(){
  if(viewIdx<0) return;
  const e=events[viewIdx];
  if(!confirm('×œ××—×•×§ ××ª ×”×¤×¨×•×™×§×˜?')) return;
  const res = await apiPost({ action:'delete', id: e.id });
  if(!res.ok){ alert('×©×’×™××” ×‘××—×™×§×”'); return; }
  hide('mView');
  await loadData(true);
}

/* Add */
function openAdd(){ fillOwnerSelect(); showOv('mAdd'); }
function closeAdd(){ hide('mAdd'); }

function fillOwnerSelect(){
  const sel=id('inO'), cur=sel.value;
  sel.innerHTML='<option value="">×‘×—×¨ ××—×¨××™...</option>';
  OWNERS.forEach(o=>{
    const opt=document.createElement('option');
    opt.value=o; opt.textContent=o;
    if(o===cur) opt.selected=true;
    sel.appendChild(opt);
  });
}

function addRow(cid){
  const c=id(cid);
  const row=document.createElement('div');
  row.className='tr';
  row.style.background='white';

  const inp=document.createElement('input');
  inp.type='text';
  inp.placeholder='×›×ª×•×‘ ××©×™××”...';
  inp.className='task-inp';
  inp.style.cssText='flex:1;background:transparent;border:none;outline:none;font-size:13px;font-weight:900;font-family:Heebo,sans-serif;color:var(--ink);min-width:0';

  inp.addEventListener('keydown', e=>{
    if(e.key==='Enter' && inp.value.trim()){
      e.preventDefault();
      const btnId = cid==='tList' ? 'btnAddTask' : 'btnVAddTask';
      id(btnId).click();
    }
  });

  const del=document.createElement('button');
  del.type='button';
  del.style.cssText='background:none;border:none;cursor:pointer;padding:4px 6px;color:#fca5a5;display:flex;align-items:center';
  del.innerHTML='<i data-lucide="x" style="width:16px;height:16px"></i>';
  del.onclick=()=>row.remove();

  row.appendChild(inp); row.appendChild(del);
  c.appendChild(row);
  lucide.createIcons();
  setTimeout(()=>inp.focus(), 40);
}

function handleImg(){
  const f=id('inImg').files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    if(ev.target.result.length>50000){ alert('×”×ª××•× ×” ×’×“×•×œ×” ××“×™ â€” ×¢×“ ~37KB'); id('inImg').value=''; return; }
    img64=ev.target.result;
    id('imgSt').textContent='âœ… ×ª××•× ×” × ×‘×—×¨×”';
    id('imgPE').src=img64; id('imgPW').style.display='block';
  };
  r.readAsDataURL(f);
}

async function saveProject(){
  const title=id('inT').value.trim();
  const dStart=id('inD').value;
  const dEnd=id('inDEnd').value;
  const owner=id('inO').value;
  const desc=id('inDesc').value.trim();
  const status=id('inS').value;

  const tasks = [...id('tList').querySelectorAll('.task-inp')]
    .map(x=>x.value.trim()).filter(Boolean)
    .map(t=>({text:t,done:false}));

  if(!title){ alert('× × ×œ×”×–×™×Ÿ ×©× ×¤×¨×•×™×§×˜'); return; }

  let dateVal = '';
  if(dStart && dEnd){
    const s=new Date(dStart), e=new Date(dEnd);
    dateVal = `${s.getDate()}/${s.getMonth()+1}/${s.getFullYear()}-${e.getDate()}/${e.getMonth()+1}/${e.getFullYear()}`;
  } else if(dStart){
    const s=new Date(dStart);
    dateVal = `${s.getDate()}/${s.getMonth()+1}/${s.getFullYear()}`;
  }

  const btn=id('saveBtn');
  btn.textContent='×©×•××¨...';
  btn.disabled=true;

  const res = await apiPost({
    action:'create',
    title,
    date: dateVal,
    owner,
    desc,
    status,
    tasks_json: encodeTasks(tasks),
    image: img64 || ''
  });

  btn.textContent='×©××•×¨ â†';
  btn.disabled=false;

  if(!res.ok){ alert('×©×’×™××” ×‘×©××™×¨×”. ×‘×“×•×§ WebApp + ×”×¨×©××•×ª'); return; }

  closeAdd();
  resetForm();
  await loadData(true);
}

function resetForm(){
  ['inT','inD','inDEnd','inDesc'].forEach(x=>id(x).value='');
  id('inO').value=''; id('inS').value='×—×“×©';
  id('tList').innerHTML='';
  id('inImg').value='';
  id('imgSt').textContent='×”×•×¡×£ ×ª××•× ×”';
  id('imgPW').style.display='none';
  id('sBtns').querySelectorAll('.sb').forEach((b,i)=>{ b.className = i===0?'sb active-n':'sb'; });
  img64='';
}

/* View switch */
function sv(name){
  ['List','Tasks','Done'].forEach(v=>{
    id('v'+v).style.display='none';
    const nb=id('nb-'+v.toLowerCase());
    if(nb) nb.classList.remove('on');
  });
  id('v'+name).style.display='block';
  const nb=id('nb-'+name.toLowerCase());
  if(nb) nb.classList.add('on');
}

/* Small */
function escapeHtml(s){
  return String(s||'')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}
</script>
</body>
</html>
