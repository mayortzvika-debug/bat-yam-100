<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Bat Yam 100</title>

  <!-- favicon (אותו שם בתיקיה) -->
  <link rel="icon" href="favicon.ico" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&family=Rubik:wght@400;600;800;900&family=Frank+Ruhl+Libre:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0d1b2a;
      --blue:#0057a8;
      --sky:#2196f3;
      --gold:#f5a623;
      --mint:#00b89c;
      --bg:#f4f6f9;
      --card:#ffffff;
      --border:#e4e9f0;
      --muted:#7a8899;
      --danger:#ef4444;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      background:var(--bg);
      font-family:'Heebo',sans-serif;
      color:var(--ink);
      -webkit-tap-highlight-color:transparent;
      overscroll-behavior-y:none;
    }
    @keyframes spin {to{transform:rotate(360deg)}}
    @keyframes fade {from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    @keyframes pop  {from{transform:scale(.92);opacity:0}to{transform:scale(1);opacity:1}}

    #ldr{
      position:fixed; inset:0; background:var(--ink); z-index:9999;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      transition:opacity .5s;
    }
    #ldr .ring{
      width:60px; height:60px; border:3px solid rgba(255,255,255,.12);
      border-top-color:var(--gold); border-radius:50%;
      animation:spin 1s linear infinite; margin-bottom:18px;
    }
    #ldr p{color:rgba(255,255,255,.45); font-size:10px; font-weight:800; letter-spacing:.2em; text-transform:uppercase}

    .topWrap{
      position:sticky; top:0; z-index:80;
      background:linear-gradient(180deg, rgba(13,27,42,1) 0%, rgba(13,27,42,1) 65%, rgba(13,27,42,.0) 100%);
      padding-bottom:10px;
    }

    .hero{
      position:relative; height:220px;
      border-radius:0 0 28px 28px; overflow:hidden;
      background:var(--ink);
      box-shadow:0 18px 44px -14px rgba(13,27,42,.55);
      margin:0 14px;
    }
    .hero-bg{
      background-image:url('baner.jpg');
      background-size:cover; background-position:center;
      position:absolute; inset:0; opacity:.55;
    }
    .hero-stripe{
      position:absolute; bottom:0; left:0; right:0; height:4px;
      background:linear-gradient(90deg,var(--gold) 0%,var(--mint) 50%,var(--sky) 100%);
    }
    .hero-c{
      position:relative; z-index:2;
      padding:18px 18px;
      height:100%;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .glass-pill{
      background:rgba(255,255,255,.14);
      backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px);
      border:1px solid rgba(255,255,255,.22);
      color:white; border-radius:40px;
      display:inline-flex; align-items:center; gap:7px;
      padding:7px 14px; font-size:12px; font-weight:800;
      cursor:pointer; transition:all .18s;
    }
    .glass-pill:active{transform:scale(.94); background:rgba(255,255,255,.28)}
    .glass-ic{
      background:rgba(255,255,255,.14);
      backdrop-filter:blur(14px); -webkit-backdrop-filter:blur(14px);
      border:1px solid rgba(255,255,255,.22);
      color:white; border-radius:50%;
      width:38px; height:38px; display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:all .18s;
    }
    .glass-ic:active{transform:scale(.92)}
    .hero-dot{width:8px;height:8px;border-radius:50%;background:#4ade80}

    .hero-title{
      font-family:'Frank Ruhl Libre',serif;
      font-size:40px; font-weight:900; color:white;
      line-height:.92; letter-spacing:-1px;
      text-shadow:0 2px 16px rgba(0,0,0,.4);
    }
    .hero-title span{
      font-family:'Rubik',sans-serif;
      color:var(--gold);
      letter-spacing:-.6px;
    }
    .hero-sub{color:rgba(255,255,255,.72); font-size:13px; font-weight:400; margin-top:6px}

    .stats-row{
      display:flex; gap:10px;
      padding:0 14px;
      margin:-18px 0 10px;
      position:relative; z-index:5;
    }
    .stat{
      flex:1; background:var(--card);
      border-radius:16px; padding:14px 12px;
      box-shadow:0 4px 20px rgba(0,0,0,.08);
      border-top:3px solid transparent;
      animation:fade .4s ease both;
    }
    .stat:nth-child(1){border-top-color:var(--blue)}
    .stat:nth-child(2){border-top-color:var(--mint)}
    .stat:nth-child(3){border-top-color:var(--gold)}
    .stat-num{font-size:30px;font-weight:900;color:var(--ink);line-height:1}
    .stat-lbl{font-size:10px;font-weight:800;color:var(--muted);margin-top:3px;text-transform:uppercase;letter-spacing:.04em}

    .sec-head{display:flex;justify-content:space-between;align-items:center;padding:0 14px;margin:12px 0 12px}
    .sec-title{
      font-size:13px;font-weight:900;color:var(--ink);
      display:flex;align-items:center;gap:8px;
      text-transform:uppercase;letter-spacing:.06em
    }
    .sec-title::before{content:'';width:3px;height:16px;background:var(--blue);border-radius:2px;display:block}

    #eCards{
      display:grid; grid-template-columns:1fr; gap:10px;
      padding:0 14px 18px;
    }
    @media (min-width: 900px){
      .containerWide{max-width:1100px;margin:0 auto}
      #eCards{grid-template-columns:repeat(2,1fr)}
    }
    @media (min-width: 1200px){
      #eCards{grid-template-columns:repeat(3,1fr)}
    }
    .ecard{
      background:var(--card); border-radius:18px;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
      border:1px solid var(--border);
      display:flex; align-items:stretch; overflow:hidden;
      cursor:pointer; transition:transform .15s, box-shadow .15s;
      animation:fade .25s ease both;
    }
    .ecard:active{transform:scale(.98); box-shadow:0 1px 6px rgba(0,0,0,.07)}
    .ecard-accent{width:5px; flex-shrink:0; background:var(--blue)}
    .ecard-accent.mine{background:var(--mint)}
    .ecard-accent.done{background:#d1d5db}
    .ecard-date{
      width:60px; flex-shrink:0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding:12px 0;
      border-left:1px solid var(--border);
      background:#fafbfc;
    }
    .ecard-date .day{font-size:26px;font-weight:900;color:var(--ink);line-height:1}
    .ecard-date .day.range{font-size:16px;font-weight:900;color:var(--blue);line-height:1.1}
    .ecard-date .mon{font-size:9px;font-weight:800;color:var(--muted);text-transform:uppercase;margin-top:2px}
    .ecard-body{flex:1; padding:14px 14px 14px 12px; min-width:0}
    .ecard-title{font-size:15px;font-weight:800;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:6px}
    .ecard-meta{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
    .ecard-owner{font-size:11px;color:var(--muted);font-weight:700}

    .pill{display:inline-block;padding:3px 9px;border-radius:20px;font-size:10px;font-weight:800;letter-spacing:.02em;white-space:nowrap}
    .pill-wip{background:#fef3c7;color:#92400e}
    .pill-done{background:#d1fae5;color:#065f46}
    .pill-wait{background:#f3f4f6;color:#4b5563}

    .navTop{
      margin:6px 14px 0;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter:blur(10px);
      border-radius:22px;
      display:flex; gap:8px; justify-content:space-between; align-items:center;
      padding:6px;
    }
    .nb{
      flex:1;
      padding:10px 10px; border-radius:18px;
      color:rgba(255,255,255,.62);
      display:flex; flex-direction:column; align-items:center; gap:3px;
      font-size:9px; font-weight:900; letter-spacing:.04em;
      background:none; border:none; cursor:pointer;
      transition:all .2s; text-transform:uppercase;
    }
    .nb.on{color:white; background:rgba(255,255,255,.14)}
    .nbAdd{
      background:var(--gold); color:var(--ink);
      padding:12px; border-radius:18px;
      border:2px solid rgba(0,0,0,.35);
      cursor:pointer; transition:all .18s;
      min-width:52px;
      display:flex; align-items:center; justify-content:center;
    }
    .nbAdd:active{transform:scale(.93)}
    .badge{position:absolute; top:6px; right:10px; width:8px;height:8px;background:var(--danger);border-radius:50%; border:2px solid rgba(13,27,42,1)}

    .ov{
      position:fixed; inset:0; background:rgba(13,27,42,.7);
      display:flex; align-items:flex-end; justify-content:center;
      z-index:150; backdrop-filter:blur(6px);
    }
    @media (min-width:768px){.ov{align-items:center;padding:20px}}
    .sh{
      background:var(--card); width:100%; max-width:560px;
      border-radius:28px 28px 0 0;
      display:flex; flex-direction:column; max-height:92vh;
      animation:pop .22s ease both;
      box-shadow:0 -8px 48px rgba(13,27,42,.25);
    }
    @media (min-width:768px){.sh{border-radius:28px; max-height:86vh}}
    .sh-head{
      padding:16px 18px; display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid var(--border); flex-shrink:0;
    }
    .sh-title{font-size:18px;font-weight:900;color:var(--ink)}
    .close-btn{
      width:34px;height:34px;border-radius:50%;
      background:#f1f5f9;border:none;cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }

    .fld{
      width:100%; padding:12px 14px; background:#f8fafc; border-radius:12px;
      border:1.5px solid var(--border); outline:none;
      font-family:'Heebo',sans-serif; font-size:14px; color:var(--ink);
      transition:all .2s;
    }
    .fld:focus{border-color:var(--blue); background:white; box-shadow:0 0 0 3px rgba(0,87,168,.1)}
    label.lbl{font-size:10px;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:6px}

    .tTab{
      flex:1; padding:10px 12px; border-radius:14px; border:1.5px solid var(--border);
      background:var(--card); cursor:pointer; font-weight:900; font-size:12px; color:var(--muted);
    }
    .tTab.on{border-color:var(--blue); color:var(--blue); background:#eff6ff}
    .taskTabs{display:flex; gap:8px; padding:0 14px; margin-top:10px;}

    .tr{
      display:flex; align-items:flex-start; gap:10px;
      padding:10px 12px; background:#f8fafc;
      border-radius:10px; border:1px solid var(--border);
    }
    .tr input[type=checkbox]{width:18px;height:18px;accent-color:var(--blue);cursor:pointer;flex-shrink:0;margin-top:2px}
    .tr.done span{text-decoration:line-through;color:var(--muted)}
    .tMeta{
      font-size:10px; font-weight:800; color:var(--muted);
      display:flex; gap:8px; flex-wrap:wrap; margin-top:4px;
    }

    .btnMini{
      font-size:11px; font-weight:900;
      color:var(--blue);
      background:#eff6ff;
      border:1px solid #bfdbfe;
      border-radius:10px;
      padding:7px 10px;
      cursor:pointer;
      font-family:'Heebo',sans-serif;
    }
    .btnMain{
      width:100%;
      background:var(--ink); color:white;
      padding:15px; border-radius:14px;
      font-weight:900; font-size:15px;
      border:none; cursor:pointer;
      font-family:'Heebo',sans-serif;
      box-shadow:0 4px 18px rgba(13,27,42,.35);
      letter-spacing:.03em;
    }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:16px; z-index:99999;
      background:rgba(13,27,42,.92); color:white;
      padding:10px 14px; border-radius:14px;
      font-size:12px; font-weight:800;
      display:none;
      max-width:92vw;
    }

    /* Calendar event labels */
    .cal-ev{
      margin-top:4px;
      font-size:9px;
      font-weight:900;
      color:var(--ink);
      background:#fff7e6;
      border:1px solid #ffe3b3;
      border-radius:8px;
      padding:2px 6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      line-height:1.25;
    }
    .cal-more{
      margin-top:4px;
      font-size:9px;
      font-weight:900;
      color:var(--muted);
    }
  </style>
</head>

<body>
  <div id="ldr">
    <div class="ring"></div>
    <p>BAT YAM 100</p>
  </div>

  <div id="app" style="display:none">
    <div class="topWrap">

      <div class="hero containerWide">
        <div class="hero-bg"></div>
        <div class="hero-c">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <button id="btnUser" class="glass-pill">
              <span class="hero-dot"></span>
              <span id="uLabel">אורח</span>
              <i data-lucide="chevron-down" style="width:13px;height:13px;opacity:.7"></i>
            </button>
            <div style="display:flex;gap:8px">
              <button id="btnRefresh" class="glass-ic"><i data-lucide="refresh-cw" style="width:17px;height:17px"></i></button>
            </div>
          </div>
          <div>
            <div class="hero-title">BAT YAM<br><span>100</span></div>
            <p class="hero-sub">ניהול פרויקטים עירוני · 2026</p>
          </div>
        </div>
        <div class="hero-stripe"></div>
      </div>

      <div class="navTop containerWide">
        <button id="nb-list" class="nb on"><i data-lucide="home" style="width:20px;height:20px"></i><span>בית</span></button>
        <button id="nb-tasks" class="nb" style="position:relative">
          <i data-lucide="check-square" style="width:20px;height:20px"></i><span>משימות</span>
          <span id="tbadge" class="badge" style="display:none"></span>
        </button>
        <button id="nb-add" class="nbAdd"><i data-lucide="plus" style="width:24px;height:24px"></i></button>
        <button id="nb-cal" class="nb"><i data-lucide="calendar" style="width:20px;height:20px"></i><span>לוח שנה</span></button>
        <button id="nb-set" class="nb"><i data-lucide="user" style="width:20px;height:20px"></i><span>פרופיל</span></button>
      </div>

      <div class="stats-row containerWide">
        <div class="stat"><div id="stT" class="stat-num">0</div><div class="stat-lbl">פרויקטים</div></div>
        <div class="stat"><div id="stM" class="stat-num">0</div><div class="stat-lbl">שלי</div></div>
        <div class="stat"><div id="stA" class="stat-num">0</div><div class="stat-lbl">פתוחים</div></div>
      </div>
    </div>

    <div id="vList" class="containerWide">
      <div class="sec-head">
        <span class="sec-title">כל הפרויקטים</span>
        <span id="countBadge" style="font-size:11px;font-weight:800;color:var(--muted)"></span>
      </div>
      <div id="eCards"></div>
      <div style="height:18px"></div>
    </div>

    <div id="vCal" style="display:none" class="containerWide">
      <div class="sec-head" style="margin-top:6px">
        <span class="sec-title">לוח שנה</span>
        <div style="display:flex;gap:8px">
          <button id="calP" class="btnMini"><i data-lucide="chevron-right" style="width:16px;height:16px"></i></button>
          <button id="calN" class="btnMini"><i data-lucide="chevron-left" style="width:16px;height:16px"></i></button>
        </div>
      </div>
      <div id="calTit" style="padding:0 14px 10px;font-weight:900"></div>
      <div style="padding:0 14px">
        <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;text-align:center;font-size:9px;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:5px">
          <div>א׳</div><div>ב׳</div><div>ג׳</div><div>ד׳</div><div>ה׳</div><div>ו׳</div><div>ש׳</div>
        </div>
        <div id="calG" style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;padding-bottom:18px"></div>
      </div>
    </div>

    <div id="vTasks" style="display:none" class="containerWide">
      <div class="sec-head">
        <span class="sec-title">משימות</span>
        <select id="tFilter" class="fld" style="width:auto;font-size:12px;font-weight:900;padding:9px 10px;cursor:pointer">
          <option value="">כולם</option>
        </select>
      </div>

      <div class="taskTabs">
        <button id="tabDoing" class="tTab on">בביצוע</button>
        <button id="tabDone" class="tTab">בוצעו</button>
      </div>

      <div id="tCards" style="display:flex;flex-direction:column;gap:10px;padding:12px 14px 18px"></div>
    </div>
  </div>

  <div id="mView" class="ov" style="display:none"></div>
  <div id="toast" class="toast"></div>

  <script>
    /* =========================
       CONFIG
       ========================= */
    const BASE = "https://script.google.com/macros/s/AKfycbz1nTdeJO9wI4RgUBExrD2KEZnKbVp19IlJVFnxGEzWRfJpldH83-G158ymHgK_Pm_Lwg/exec";
    const OWNER_PRESET = ['בן','רינת','גלית','אבישי','מור','יוסי','רותם'];

    let events = [];
    let me = localStorage.getItem('batyam_user') || '';
    let activeEvent = null;
    let viewTaskMode = 'doing'; // doing | done

    // ✅ ברירת מחדל: יוני 2026
    let calY = 2026;
    let calM = 5; // 0=Jan ... 5=June

    const $ = (id) => document.getElementById(id);

    window.addEventListener('DOMContentLoaded', async () => {
      lucide.createIcons();
      $('uLabel').textContent = me || 'אורח';

      bindNav_();
      bindCal_();
      $('btnRefresh').addEventListener('click', () => loadAll_(true));

      $('tabDoing').addEventListener('click', () => { viewTaskMode='doing'; setTabs_(); renderTasksHub_(); });
      $('tabDone').addEventListener('click', () => { viewTaskMode='done'; setTabs_(); renderTasksHub_(); });

      await loadAll_(false);
      hideLoader_();
      $('app').style.display = 'block';
    });

    function toast_(msg){
      const t = $('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(window.__t_to);
      window.__t_to = setTimeout(()=> t.style.display='none', 2600);
    }

    function hideLoader_(){
      const l=$('ldr');
      l.style.opacity='0';
      setTimeout(()=>{ l.style.display='none'; }, 450);
    }

    function bindNav_(){
      const show = (v) => {
        $('vList').style.display = (v==='list') ? '' : 'none';
        $('vCal').style.display  = (v==='cal') ? '' : 'none';
        $('vTasks').style.display= (v==='tasks') ? '' : 'none';

        $('nb-list').classList.toggle('on', v==='list');
        $('nb-cal').classList.toggle('on', v==='cal');
        $('nb-tasks').classList.toggle('on', v==='tasks');
      };

      $('nb-list').addEventListener('click', ()=> show('list'));
      $('nb-cal').addEventListener('click', ()=> { show('cal'); renderCalendar_(); });
      $('nb-tasks').addEventListener('click', ()=> { show('tasks'); renderTasksHub_(); });

      $('btnUser').addEventListener('click', () => {
        const name = prompt('שם משתמש (למשל: בן / גלית / רינת):', me || '');
        if(name !== null){
          me = String(name).trim();
          localStorage.setItem('batyam_user', me);
          $('uLabel').textContent = me || 'אורח';
          renderAll_();
        }
      });

      $('nb-add').addEventListener('click', () => {
        toast_('הוספת פרויקט נעשית מהשיט (בינתיים). אפשר להוסיף גם דרך API אם תרצה.');
      });

      $('nb-set').addEventListener('click', () => toast_('פרופיל: לחץ על הכפתור עם השם למעלה לשינוי משתמש.'));
    }

    function bindCal_(){
      $('calP').addEventListener('click', ()=>{ calM--; if(calM<0){calM=11;calY--} renderCalendar_(); });
      $('calN').addEventListener('click', ()=>{ calM++; if(calM>11){calM=0;calY++} renderCalendar_(); });
    }

    /* =========================
       Data fetch
       ========================= */
    async function loadAll_(forceToast){
      try{
        const url = BASE + '?action=list&_=' + Date.now();
        const res = await fetch(url);
        const j = await res.json();
        if(!j.ok) throw new Error(j.error || 'Load failed');

        events = (j.rows || []).map(normRow_).filter(x => (x.Title || x.status || x.owner || x.date || x.Description || (x._tasks||[]).length));
        renderAll_();

        if(forceToast) toast_('עודכן מהשיט ✅');
      }catch(err){
        console.error(err);
        toast_('שגיאה בטעינת נתונים: ' + (err.message || err));
      }
    }

    function normRow_(r){
      const o = { ...r };

      o.ID = String(o.ID || o.id || '').trim();
      o.Title = String(o.Title || o.title || '').trim();
      o.owner = String(o.owner || o.Owner || '').trim();
      o.status = String(o.status || o.Status || '').trim();
      o.date = o.date || o.Date || '';

      o.Description = String(o.Description || o.desc || o.Desc || '').trim();
      o.notes = String(o.notes || o.Notes || '').trim();

      o.targetAudience = String(
        o["Target Audience"] ?? o.targetAudience ?? o.TargetAudience ?? o["Target audience"] ?? ''
      ).trim();

      o.image = String(o.image || o.Image || '').trim();

      o._tasks = parseTasks_(o.tasks);

      return o;
    }

    function parseTasks_(cell){
      const s = (cell === undefined || cell === null) ? '' : String(cell).trim();
      if(!s) return [];

      if(s.startsWith('[') || s.startsWith('{')){
        try{
          const parsed = JSON.parse(s);
          if(Array.isArray(parsed)){
            return parsed.map(t => ({
              id: t.id || ('t_' + Math.random().toString(16).slice(2)),
              text: String(t.text || t.title || '').trim(),
              done: !!t.done,
              createdAt: t.createdAt || '',
              doneAt: t.doneAt || ''
            })).filter(x => x.text);
          }
        }catch(e){}
      }

      const parts =
        s.includes('\n') ? s.split(/\r?\n/) :
        s.includes(',')  ? s.split(',') :
        [s];

      return parts
        .map(x => x.trim())
        .filter(Boolean)
        .map(txt => ({
          id: 't_' + Math.random().toString(16).slice(2),
          text: txt,
          done: false,
          createdAt: '',
          doneAt: ''
        }));
    }

    function renderAll_(){
      renderCards_();
      renderStats_();
      renderCalendar_();
      buildTasksFilter_();
      renderTasksHub_();
      updateBadge_();
    }

    function renderStats_(){
      $('stT').textContent = events.length;
      const mine = me ? events.filter(e => (e.owner||'').includes(me)).length : 0;
      $('stM').textContent = mine;
      const open = events.filter(e => (e._tasks||[]).some(t=>!t.done)).length;
      $('stA').textContent = open;
      $('countBadge').textContent = 'סה״כ: ' + events.length;
    }

    function pillForStatus_(s){
      const v = String(s||'').trim();
      if(!v) return `<span class="pill pill-wait">ללא סטטוס</span>`;
      if(v.includes('בתהליך') || v.includes('תמחור') || v.includes('חוזים') || v.includes('הזמנת') || v.includes('ממתין')) return `<span class="pill pill-wip">${escapeHtml_(v)}</span>`;
      if(v.includes('בוצע') || v.includes('הסתיים') || v.includes('סגור')) return `<span class="pill pill-done">${escapeHtml_(v)}</span>`;
      return `<span class="pill pill-wait">${escapeHtml_(v)}</span>`;
    }

    // ✅ מיון כרונולוגי למסך הבית (תאריך/טווח). בלי תאריך -> סוף
    function sortKeyTime_(e){
      const s = String(e.date||'').trim();
      if(!s) return Number.POSITIVE_INFINITY;

      const rng = parseDateRange_(s);
      if(rng) return rng.start.getTime();

      const d = parseDate_(s);
      if(d) return d.getTime();

      return Number.POSITIVE_INFINITY;
    }

    function renderCards_(){
      const wrap = $('eCards');
      wrap.innerHTML = '';

      const sorted = [...events].sort((a,b)=>{
        const ta = sortKeyTime_(a);
        const tb = sortKeyTime_(b);
        if(ta !== tb) return ta - tb;
        return String(a.Title||'').localeCompare(String(b.Title||''),'he');
      });

      sorted.forEach(e => {
        const accentClass = (me && (e.owner||'').includes(me)) ? 'mine' : '';
        const anyDone = (e._tasks||[]).length && (e._tasks||[]).every(t=>t.done);
        const doneClass = anyDone ? 'done' : '';

        const { dayTxt, monTxt, isRange } = dateBadge_(e.date);

        const card = document.createElement('div');
        card.className = 'ecard';
        card.innerHTML = `
          <div class="ecard-accent ${accentClass} ${doneClass}"></div>
          <div class="ecard-date">
            <div class="day ${isRange?'range':''}">${dayTxt}</div>
            <div class="mon">${monTxt}</div>
          </div>
          <div class="ecard-body">
            <div class="ecard-title">${escapeHtml_(e.Title || '(ללא כותרת)')}</div>
            <div class="ecard-meta">
              ${pillForStatus_(e.status)}
              <span class="ecard-owner">${escapeHtml_(e.owner || '')}</span>
            </div>
            ${e.Description ? `<div style="margin-top:8px;color:var(--muted);font-size:12px;line-height:1.25">${escapeHtml_(e.Description)}</div>`:''}
          </div>
        `;
        card.addEventListener('click', ()=> openEvent_(e.ID));
        wrap.appendChild(card);
      });
    }

    function dateBadge_(raw){
      const s = String(raw||'').trim();
      if(!s) return { dayTxt:'—', monTxt:'תאריך', isRange:false };

      const rng = parseDateRange_(s);
      if(rng){
        return { dayTxt:'טווח', monTxt:'תאריכים', isRange:true };
      }

      const d = parseDate_(s);
      if(!d) return { dayTxt:'—', monTxt:'תאריך', isRange:false };

      const day = d.getDate();
      const mon = ['ינו','פבר','מרץ','אפר','מאי','יונ','יול','אוג','ספט','אוק','נוב','דצמ'][d.getMonth()];
      return { dayTxt:String(day), monTxt:mon, isRange:false };
    }

    function parseDate_(s){
      if(!s) return null;

      // ISO / Date string
      let d = new Date(s);
      if(!isNaN(d.getTime())) return d;

      // m/d/yyyy or d/m/yyyy ambiguity:
      // אם החלק הראשון >12 זה בטוח יום/חודש
      let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if(m){
        const a = parseInt(m[1],10);
        const b = parseInt(m[2],10);
        const yy = parseInt(m[3],10);

        let dd, mm;
        if(a > 12){ dd = a; mm = b-1; }
        else if(b > 12){ dd = b; mm = a-1; }
        else {
          // אצלך רוב התאריכים הם m/d/yyyy (7/30/2026)
          dd = b; mm = a-1;
        }

        d = new Date(yy, mm, dd);
        if(!isNaN(d.getTime())) return d;
      }

      return null;
    }

    function parseDateDMY_(s){
      const m = String(s||'').trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if(!m) return null;
      const dd = parseInt(m[1],10);
      const mm = parseInt(m[2],10) - 1;
      const yy = parseInt(m[3],10);
      const d = new Date(yy, mm, dd);
      return isNaN(d.getTime()) ? null : d;
    }

    function parseDateRange_(s){
      // "26/7/2026-30/8/2026"
      const parts = String(s||'').trim().split('-');
      if(parts.length !== 2) return null;
      const start = parseDateDMY_(parts[0].trim());
      const end   = parseDateDMY_(parts[1].trim());
      if(!start || !end) return null;
      return { start, end };
    }

    /* =========================
       Event modal + tasks
       ========================= */
    function openEvent_(id){
      const e = events.find(x => x.ID === id);
      if(!e){ toast_('לא נמצא פרויקט'); return; }

      activeEvent = JSON.parse(JSON.stringify(e)); // clone
      activeEvent._tasks = (e._tasks || []).map(t=>({ ...t }));

      renderEventModal_();
    }

    function closeModal_(){
      $('mView').style.display='none';
      $('mView').innerHTML='';
      activeEvent = null;
    }

    function renderEventModal_(){
      const e = activeEvent;
      const m = $('mView');
      m.style.display='flex';
      m.innerHTML = `
        <div class="sh">
          <div class="sh-head">
            <div>
              <div class="sh-title">${escapeHtml_(e.Title || 'פרויקט')}</div>
              <div style="margin-top:2px;color:var(--muted);font-size:12px;font-weight:800">${escapeHtml_(e.ID)}</div>
            </div>
            <button class="close-btn" id="xClose"><i data-lucide="x" style="width:16px;height:16px"></i></button>
          </div>

          <div style="padding:14px 14px 0">
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <div style="flex:1;min-width:160px">
                <label class="lbl">סטטוס</label>
                <input id="fStatus" class="fld" value="${escapeAttr_(e.status||'')}" placeholder="למשל: בתהליך" />
              </div>
              <div style="flex:1;min-width:160px">
                <label class="lbl">אחראי</label>
                <input id="fOwner" class="fld" value="${escapeAttr_(e.owner||'')}" placeholder="למשל: גלית" />
              </div>
            </div>

            <div style="margin-top:10px">
              <label class="lbl">תיאור</label>
              <textarea id="fDesc" class="fld" rows="3" placeholder="תיאור קצר...">${escapeHtml_(e.Description||'')}</textarea>
            </div>

            <div style="margin-top:10px">
              <label class="lbl">Target Audience</label>
              <input id="fTA" class="fld" value="${escapeAttr_(e.targetAudience||'')}" placeholder="כולם / נוער /..." />
            </div>

            <div class="taskTabs" style="margin-top:12px;padding:0">
              <button id="mTabDoing" class="tTab ${viewTaskMode==='doing'?'on':''}">בביצוע</button>
              <button id="mTabDone" class="tTab ${viewTaskMode==='done'?'on':''}">בוצעו</button>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px">
              <input id="newTaskText" class="fld" placeholder="הוסף משימה..." />
              <button id="btnAddTask" class="btnMini" style="white-space:nowrap">הוסף</button>
            </div>

            <div id="taskList" style="display:flex;flex-direction:column;gap:8px;margin-top:10px;padding-bottom:10px"></div>

            <div style="display:flex;gap:10px;margin:10px 0 16px">
              <button id="btnSaveTasks" class="btnMain">שמור משימות</button>
            </div>

            <div style="display:flex;gap:10px;margin:0 0 18px">
              <button id="btnSaveFields" class="btnMini">שמור שדות (סטטוס/אחראי/תיאור/קהל)</button>
              <button id="btnReload" class="btnMini">רענון מהשיט</button>
            </div>
          </div>
        </div>
      `;

      lucide.createIcons();

      $('xClose').addEventListener('click', closeModal_);
      m.addEventListener('click', (ev)=>{ if(ev.target===m) closeModal_(); });

      $('mTabDoing').addEventListener('click', ()=>{ viewTaskMode='doing'; renderEventModal_(); });
      $('mTabDone').addEventListener('click', ()=>{ viewTaskMode='done'; renderEventModal_(); });

      $('btnAddTask').addEventListener('click', addTask_);
      $('newTaskText').addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); addTask_(); } });

      $('btnSaveTasks').addEventListener('click', saveTasks_);
      $('btnSaveFields').addEventListener('click', saveFields_);
      $('btnReload').addEventListener('click', async ()=>{ await loadAll_(true); closeModal_(); });

      renderTasksInsideModal_();
    }

    function addTask_(){
      const inp = $('newTaskText');
      const txt = String(inp.value||'').trim();
      if(!txt) return;
      activeEvent._tasks.unshift({
        id: 't_' + Math.random().toString(16).slice(2),
        text: txt,
        done: false,
        createdAt: new Date().toISOString(),
        doneAt: ''
      });
      inp.value='';
      renderTasksInsideModal_();
      updateBadge_();
    }

    function renderTasksInsideModal_(){
      const list = $('taskList');
      if(!list) return;

      const tasks = activeEvent._tasks || [];
      const filtered = (viewTaskMode==='doing')
        ? tasks.filter(t=>!t.done)
        : tasks.filter(t=>t.done);

      list.innerHTML = filtered.length ? '' : `<div style="color:var(--muted);font-weight:800;font-size:12px;padding:10px 6px">אין משימות בתצוגה הזו</div>`;

      filtered.forEach(t=>{
        const row = document.createElement('div');
        row.className = 'tr ' + (t.done?'done':'');
        row.innerHTML = `
          <input type="checkbox" ${t.done?'checked':''} />
          <div style="flex:1">
            <span style="font-weight:900;font-size:13px;line-height:1.2">${escapeHtml_(t.text)}</span>
            <div class="tMeta">
              ${t.createdAt ? `<span>נוצר: ${escapeHtml_(shortDate_(t.createdAt))}</span>`:''}
              ${t.doneAt ? `<span>בוצע: ${escapeHtml_(shortDate_(t.doneAt))}</span>`:''}
            </div>
          </div>
        `;
        row.querySelector('input').addEventListener('change', (ev)=>{
          const checked = !!ev.target.checked;
          const idx = (activeEvent._tasks||[]).findIndex(x=>x.id===t.id);
          if(idx>=0){
            activeEvent._tasks[idx].done = checked;
            activeEvent._tasks[idx].doneAt = checked ? new Date().toISOString() : '';
            renderTasksInsideModal_();
            updateBadge_();
          }
        });
        list.appendChild(row);
      });
    }

    function shortDate_(iso){
      try{
        const d = new Date(iso);
        if(isNaN(d.getTime())) return String(iso);
        return d.toLocaleDateString('he-IL');
      }catch(e){
        return String(iso);
      }
    }

    async function saveTasks_(){
      try{
        const payload = new URLSearchParams();
        payload.set('action','updateTasks');
        payload.set('id', activeEvent.ID);
        payload.set('tasks', JSON.stringify(activeEvent._tasks || []));

        const res = await fetch(BASE, { method:'POST', body: payload });
        const j = await res.json();
        if(!j.ok) throw new Error(j.error || 'Save failed');

        toast_('נשמר ✅');
        await loadAll_(false);
        closeModal_();
      }catch(err){
        console.error(err);
        toast_('שגיאה בשמירה: ' + (err.message || err));
      }
    }

    async function saveFields_(){
      try{
        const status = $('fStatus').value;
        const owner = $('fOwner').value;
        const desc  = $('fDesc').value;
        const ta    = $('fTA').value;

        await updateField_(activeEvent.ID, 'status', status);
        await updateField_(activeEvent.ID, 'owner', owner);
        await updateField_(activeEvent.ID, 'Description', desc);
        await updateField_(activeEvent.ID, 'Target Audience', ta);

        toast_('שדות עודכנו ✅');
        await loadAll_(false);
        closeModal_();
      }catch(err){
        console.error(err);
        toast_('שגיאה בעדכון שדות: ' + (err.message || err));
      }
    }

    async function updateField_(id, field, value){
      const payload = new URLSearchParams();
      payload.set('action','updateField');
      payload.set('id', id);
      payload.set('field', field);
      payload.set('value', value);

      const res = await fetch(BASE, { method:'POST', body: payload });
      const j = await res.json();
      if(!j.ok) throw new Error(j.error || 'Update failed');
      return j;
    }

    /* =========================
       Tasks hub view (all projects)
       ========================= */
    function buildTasksFilter_(){
      const sel = $('tFilter');
      const owners = new Set();
      events.forEach(e=>{
        const o = (e.owner||'').trim();
        if(o) owners.add(o);
      });

      const current = sel.value || '';
      const opts = [''].concat(Array.from(owners).sort((a,b)=>a.localeCompare(b,'he')));

      sel.innerHTML = opts.map(v=> `<option value="${escapeAttr_(v)}">${v?escapeHtml_(v):'כולם'}</option>`).join('');
      sel.value = current;

      sel.onchange = () => renderTasksHub_();
    }

    function renderTasksHub_(){
      const wrap = $('tCards');
      if(!wrap) return;
      wrap.innerHTML = '';

      const who = $('tFilter').value || '';

      let all = [];
      events.forEach(e=>{
        const tasks = e._tasks || [];
        tasks.forEach(t=>{
          all.push({ eventId:e.ID, title:e.Title, owner:e.owner, status:e.status, task:t });
        });
      });

      if(who){
        all = all.filter(x => String(x.owner||'').includes(who));
      }

      all = (viewTaskMode==='doing')
        ? all.filter(x=>!x.task.done)
        : all.filter(x=>x.task.done);

      all.sort((a,b)=>{
        const da = new Date(a.task.doneAt || a.task.createdAt || 0).getTime();
        const db = new Date(b.task.doneAt || b.task.createdAt || 0).getTime();
        return db - da;
      });

      if(!all.length){
        wrap.innerHTML = `<div style="color:var(--muted);font-weight:900;padding:10px 4px">אין משימות בתצוגה הזו</div>`;
        updateBadge_();
        setTabs_();
        return;
      }

      all.forEach(x=>{
        const div = document.createElement('div');
        div.className = 'ecard';
        div.style.cursor='pointer';
        div.innerHTML = `
          <div class="ecard-accent ${x.task.done?'done':''}"></div>
          <div class="ecard-body">
            <div class="ecard-title">${escapeHtml_(x.task.text)}</div>
            <div class="ecard-meta">
              <span class="pill pill-wip">${escapeHtml_(x.title || '')}</span>
              ${x.owner ? `<span class="ecard-owner">${escapeHtml_(x.owner)}</span>`:''}
              ${x.task.doneAt ? `<span class="ecard-owner">בוצע: ${escapeHtml_(shortDate_(x.task.doneAt))}</span>`:''}
            </div>
          </div>
        `;
        div.addEventListener('click', ()=> openEvent_(x.eventId));
        wrap.appendChild(div);
      });

      updateBadge_();
      setTabs_();
    }

    function setTabs_(){
      $('tabDoing').classList.toggle('on', viewTaskMode==='doing');
      $('tabDone').classList.toggle('on', viewTaskMode==='done');
    }

    function updateBadge_(){
      const openCount = events.reduce((sum,e)=> sum + ((e._tasks||[]).filter(t=>!t.done).length), 0);
      $('tbadge').style.display = openCount>0 ? '' : 'none';
    }

    /* =========================
       Calendar (✅ titles inside cells + supports ranges)
       ========================= */
    function renderCalendar_(){
      const title = $('calTit');
      const grid = $('calG');
      if(!title || !grid) return;

      const monthNames = ['ינואר','פברואר','מרץ','אפריל','מאי','יוני','יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'];
      title.textContent = monthNames[calM] + ' ' + calY;

      const first = new Date(calY, calM, 1);
      // ב-JS: 0=Sunday..6=Saturday, ולנו יש תצוגה א׳..ש׳, אז זה מתאים כמו שהוא
      const startDay = first.getDay(); 
      const daysInMonth = new Date(calY, calM+1, 0).getDate();

      grid.innerHTML='';

      for(let i=0;i<startDay;i++){
        grid.appendChild(dayCell_('', false, []));
      }

      for(let d=1; d<=daysInMonth; d++){
        const dateObj = new Date(calY, calM, d);
        const hits = eventsForDay_(dateObj);
        grid.appendChild(dayCell_(String(d), true, hits));
      }
    }

    function eventsForDay_(dateObj){
      const y = dateObj.getFullYear();
      const m = dateObj.getMonth();
      const d = dateObj.getDate();

      return events.filter(e=>{
        const raw = String(e.date||'').trim();
        if(!raw) return false;

        const rng = parseDateRange_(raw);
        if(rng){
          const start = new Date(rng.start.getFullYear(), rng.start.getMonth(), rng.start.getDate());
          const end   = new Date(rng.end.getFullYear(), rng.end.getMonth(), rng.end.getDate());
          const cur   = new Date(y, m, d);
          return cur >= start && cur <= end;
        }

        const ed = parseDate_(raw);
        if(!ed) return false;
        return ed.getFullYear()===y && ed.getMonth()===m && ed.getDate()===d;
      }).sort((a,b)=> sortKeyTime_(a)-sortKeyTime_(b));
    }

    function dayCell_(label, inMonth, hits){
      const div = document.createElement('div');
      div.style.background = inMonth ? 'white' : 'transparent';
      div.style.border = inMonth ? '1px solid var(--border)' : '1px solid transparent';
      div.style.borderRadius = '12px';
      div.style.minHeight = '56px';
      div.style.padding = '6px';
      div.style.fontWeight = '900';
      div.style.fontSize = '11px';
      div.style.color = inMonth ? 'var(--ink)' : 'transparent';
      div.style.position='relative';
      div.style.cursor = hits && hits.length ? 'pointer' : 'default';
      div.style.overflow='hidden';

      // מספר היום
      const top = document.createElement('div');
      top.textContent = label;
      top.style.fontSize = '11px';
      top.style.fontWeight = '900';
      div.appendChild(top);

      if(hits && hits.length){
        // מציגים עד 2 כותרות
        const maxShow = 2;
        hits.slice(0,maxShow).forEach(ev=>{
          const tag = document.createElement('div');
          tag.className = 'cal-ev';
          tag.title = ev.Title || '';
          tag.textContent = ev.Title || '(ללא כותרת)';
          div.appendChild(tag);
        });

        if(hits.length > maxShow){
          const more = document.createElement('div');
          more.className = 'cal-more';
          more.textContent = `+${hits.length - maxShow} עוד`;
          div.appendChild(more);
        }

        // נקודה קטנה כמו קודם
        const dot = document.createElement('div');
        dot.style.position='absolute';
        dot.style.bottom='6px';
        dot.style.left='8px';
        dot.style.width='8px';
        dot.style.height='8px';
        dot.style.borderRadius='50%';
        dot.style.background='var(--gold)';
        div.appendChild(dot);

        div.addEventListener('click', ()=> openEvent_(hits[0].ID));
      }

      return div;
    }

    /* =========================
       Utils
       ========================= */
    function escapeHtml_(s){
      return String(s||'')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }
    function escapeAttr_(s){ return escapeHtml_(s).replace(/"/g,'&quot;'); }
  </script>
</body>
</html>
