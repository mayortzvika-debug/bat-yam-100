<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bat Yam 100</title>
    
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkJhdCBZYW0gMTAwIiwKICAic2hvcnRfbmFtZSI6ICJCYXRZYW0iLAogICJzdGFydF91cmwiOiAiYXBwLmh0bWwiLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDc3YjYiLAogICJ0aGVtZV9jb2xvciI6ICIjMDA3N2I2IiwKICAiaWNvbnMiOiBbeyKic3JjIjogImh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzI5OTAvMjk5MDk5NS5wbmciLCAic2l6ZXMiOiAiMTkyeDE5MiIsICJ0eXBlIjogImltYWdlL3BuZyJ9XQp9">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #0077b6; --primary-dark: #023e8a; --bg: #f0f9ff; }
        body { background: var(--bg); font-family: 'Heebo', sans-serif; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        
        /* Hero */
        .hero-wrapper { position: relative; height: 230px; border-radius: 0 0 40px 40px; overflow: hidden; box-shadow: 0 16px 48px -12px rgba(0, 119, 182, 0.55); background: linear-gradient(145deg, var(--primary), var(--primary-dark)); }
        .hero-bg { background-image: url('baner.jpg'); background-size: cover; background-position: center top; position: absolute; inset: 0; z-index: 0; opacity: 0.75; }
        .hero-overlay { position: absolute; inset: 0; z-index: 1; background: linear-gradient(to bottom, rgba(0,30,80,0.3) 0%, rgba(0,20,60,0.6) 100%); }
        .hero-content { position: relative; z-index: 2; padding: 22px; height: 100%; display: flex; flex-direction: column; justify-content: space-between; }

        /* Buttons */
        .glass-btn { background: rgba(255,255,255,0.18); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.32); color: white; border-radius: 50px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
        .glass-btn:active { transform: scale(0.93); background: rgba(255,255,255,0.35); }

        /* Cards */
        .card { background: white; border-radius: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.055); border: 1px solid rgba(0,119,182,0.07); transition: transform 0.15s; cursor: pointer; }
        .card:active { transform: scale(0.97); }

        /* Nav */
        .nav-bar { position: fixed; bottom: 22px; left: 18px; right: 18px; background: rgba(255,255,255,0.95); backdrop-filter: blur(16px); padding: 8px 16px; border-radius: 26px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 16px 48px -8px rgba(0,0,0,0.14); border: 1px solid rgba(255,255,255,0.6); z-index: 40; }
        .nav-btn { padding: 10px 14px; border-radius: 18px; color: #94a3b8; transition: all 0.25s; display: flex; flex-direction: column; align-items: center; gap: 3px; font-size: 9px; font-weight: 700; }
        .nav-btn.active { color: var(--primary); background: #e0f2fe; }
        .nav-add { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 13px; border-radius: 22px; box-shadow: 0 8px 24px -4px rgba(0,119,182,0.5); transform: translateY(-18px); border: 4px solid white; transition: all 0.2s; }
        .nav-add:active { transform: translateY(-18px) scale(0.94); }

        /* Status Pills */
        .pill-new { background:#dbeafe; color:#1d4ed8; }
        .pill-active { background:#fef3c7; color:#b45309; }
        .pill-done { background:#dcfce7; color:#16a34a; }

        /* Calendar */
        .cal-day { min-height: 72px; background: white; border-radius: 10px; border: 1px solid #e0f2fe; padding: 4px; font-size: 10px; position: relative; }
        .cal-day.today { border: 2px solid var(--primary); background: #f0f9ff; }
        .cal-event { background: var(--primary); color: white; padding: 2px 4px; border-radius: 4px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 8px; font-weight: 700; cursor: pointer; }
        .cal-event.mine { background: #16a34a; }

        /* Modals */
        .modal-sheet { position: fixed; inset: 0; background: rgba(15,23,42,0.65); display: flex; align-items: flex-end; justify-content: center; z-index: 150; backdrop-filter: blur(4px); }
        .sheet-body { background: white; width: 100%; max-width: 480px; border-radius: 32px 32px 0 0; animation: slideUp 0.35s cubic-bezier(0.16,1,0.3,1); display: flex; flex-direction: column; max-height: 92vh; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Login */
        .login-box { background: white; border-radius: 28px; padding: 36px 28px; width: 100%; max-width: 340px; text-align: center; box-shadow: 0 24px 64px -12px rgba(0,0,0,0.25); animation: popIn 0.4s; }
        @keyframes popIn { from { transform: scale(0.88); opacity:0; } to { transform: scale(1); opacity:1; } }
        .user-chip { padding: 10px 20px; border-radius: 50px; border: 2px solid #e2e8f0; cursor: pointer; font-weight: 700; font-size: 15px; transition: all 0.18s; background: white; }
        .user-chip:hover, .user-chip.selected { border-color: var(--primary); background: #e0f2fe; color: var(--primary); }

        /* Utils */
        .task-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: #f8fafc; border-radius: 12px; transition: background 0.15s; }
        .task-item.done-task { opacity: 0.5; }
        .task-item input { width: 18px; height: 18px; accent-color: var(--primary); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .badge { position: absolute; top: 6px; right: 6px; width: 10px; height: 10px; background: #ef4444; border-radius: 50%; border: 2px solid white; }
        #loader.fade { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div id="loader" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center transition-opacity duration-300">
    <div class="relative mb-5">
        <div class="w-16 h-16 border-4 border-slate-100 border-t-blue-600 rounded-full animate-spin"></div>
    </div>
    <p class="text-slate-400 text-xs font-bold tracking-widest">×˜×•×¢×Ÿ ××¢×¨×›×ª...</p>
</div>

<div id="loginModal" class="fixed inset-0 bg-slate-900 z-[200] flex items-center justify-center p-5 hidden">
    <div class="login-box">
        <div class="w-20 h-20 rounded-full bg-blue-50 flex items-center justify-center mx-auto mb-5 text-4xl shadow-inner">ğŸ‘‹</div>
        <h2 class="text-2xl font-black text-slate-800 mb-1">×‘×¨×•×›×™× ×”×‘××™×</h2>
        <p class="text-slate-400 text-sm mb-6">××™ ××ª×—×‘×¨?</p>
        <div class="flex flex-wrap gap-2 justify-center mb-5" id="userChips"></div>
        <input id="customNameInput" type="text" placeholder="×©× ××—×¨..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-center font-bold outline-none focus:border-blue-500 mb-4 text-sm">
        <button onclick="login()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black shadow-lg active:scale-95 transition">×›× ×™×¡×” â†’</button>
    </div>
</div>

<div id="app" class="hidden max-w-md mx-auto">
    <div class="hero-wrapper">
        <div class="hero-bg"></div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <div class="flex justify-between items-center">
                <button onclick="logout()" class="glass-btn px-3 py-2 text-xs font-bold">
                    <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                    <span id="userGreeting">××•×¨×—</span>
                    <i data-lucide="log-out" class="w-3 h-3 opacity-70"></i>
                </button>
                <div class="flex gap-2">
                    <button onclick="loadData(true)" class="glass-btn p-2"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div>
                <h1 class="text-4xl font-black tracking-tighter leading-none text-white drop-shadow-lg mb-1">BAT YAM <span class="text-yellow-300">100</span></h1>
                <p class="text-blue-100 text-sm font-medium opacity-90">× ×™×”×•×œ ×¤×¨×•×™×§×˜×™× Â· 2026</p>
            </div>
        </div>
    </div>

    <div class="px-4 pt-5">
        <div id="listView">
            <div class="flex gap-3 mb-5 overflow-x-auto scrollbar-hide pb-1">
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex-1 min-w-[120px]">
                    <span class="text-[10px] text-slate-400 font-bold block mb-1">×¡×”"×› ×¤×¨×•×™×§×˜×™×</span>
                    <span id="statTotal" class="text-3xl font-black text-slate-800">0</span>
                </div>
                <div class="bg-green-50 p-4 rounded-2xl border border-green-100 shadow-sm flex-1 min-w-[120px]">
                    <span class="text-[10px] text-green-600 font-bold block mb-1">×”××©×™××•×ª ×©×œ×™</span>
                    <span id="statMine" class="text-3xl font-black text-green-700">0</span>
                </div>
            </div>
            
            <h2 class="text-base font-black text-slate-700 mb-3 flex items-center gap-2"><i data-lucide="layout-list" class="w-4 h-4 text-blue-500"></i> ×›×œ ×”×¤×¨×•×™×§×˜×™×</h2>
            <div id="eventCards" class="space-y-3 pb-28"></div>
        </div>

        <div id="calendarView" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-black text-slate-800 text-base" id="calTitle"></h2>
                <div class="flex gap-2">
                    <button onclick="changeMonth(-1)" class="p-2 bg-white rounded-full border"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button onclick="changeMonth(1)" class="p-2 bg-white rounded-full border"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                </div>
            </div>
            <div class="grid grid-cols-7 text-center text-[10px] font-black text-slate-400 mb-2 gap-1">
                <div>×</div><div>×‘</div><div>×’</div><div>×“</div><div>×”</div><div>×•</div><div>×©</div>
            </div>
            <div id="calGrid" class="grid grid-cols-7 gap-1 pb-28"></div>
        </div>

        <div id="tasksView" class="hidden">
            <h2 class="text-base font-black text-slate-700 mb-4 flex items-center gap-2"><i data-lucide="check-square" class="w-4 h-4 text-green-500"></i> ××©×™××•×ª ×©×œ×™</h2>
            <div id="taskCards" class="space-y-3 pb-28"></div>
        </div>
    </div>

    <div class="nav-bar">
        <button onclick="switchView('list')" id="nav-list" class="nav-btn active"><i data-lucide="home" class="w-5 h-5"></i><span>×‘×™×ª</span></button>
        <button onclick="switchView('tasks')" id="nav-tasks" class="nav-btn relative">
            <i data-lucide="check-square" class="w-5 h-5"></i><span>××©×™××•×ª</span>
            <span id="taskBadge" class="badge hidden"></span>
        </button>
        <button onclick="openModal('addModal')" class="nav-add"><i data-lucide="plus" class="w-7 h-7"></i></button>
        <button onclick="switchView('calendar')" id="nav-calendar" class="nav-btn"><i data-lucide="calendar" class="w-5 h-5"></i><span>×™×•××Ÿ</span></button>
    </div>
</div>

<div id="addModal" class="modal-sheet hidden">
    <div class="sheet-body" style="height:90vh;">
        <div class="p-5 flex justify-between items-center border-b border-slate-100">
            <h2 class="text-xl font-black text-slate-800">×¤×¨×•×™×§×˜ ×—×“×©</h2>
            <button onclick="closeModal('addModal')" class="p-2 bg-slate-50 rounded-full"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-5 space-y-4">
            <input id="inTitle" type="text" placeholder="×©× ×”××™×¨×•×¢ *" class="w-full p-4 bg-slate-50 rounded-xl border border-slate-200 font-bold text-lg outline-none focus:border-blue-500">
            <div class="grid grid-cols-2 gap-3">
                <input id="inDate" type="date" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none">
                <input id="inOwner" type="text" placeholder="××—×¨××™" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none">
            </div>
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase mb-1 block">×¡×˜×˜×•×¡</label>
                <div class="flex gap-2">
                    <button onclick="setStatus(this,'×—×“×©')" class="status-btn flex-1 py-2 rounded-xl font-bold text-sm pill-new border-2 border-blue-200">×—×“×©</button>
                    <button onclick="setStatus(this,'×‘×˜×™×¤×•×œ')" class="status-btn flex-1 py-2 rounded-xl font-bold text-sm bg-slate-50 text-slate-400 border-2 border-slate-100">×‘×˜×™×¤×•×œ</button>
                    <button onclick="setStatus(this,'×‘×•×¦×¢')" class="status-btn flex-1 py-2 rounded-xl font-bold text-sm bg-slate-50 text-slate-400 border-2 border-slate-100">×‘×•×¦×¢</button>
                </div>
                <input type="hidden" id="inStatus" value="×—×“×©">
            </div>
            <textarea id="inDesc" rows="3" placeholder="×ª×™××•×¨..." class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm"></textarea>
            
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <div class="flex justify-between items-center mb-3">
                    <label class="text-[10px] font-black text-slate-400 uppercase">××©×™××•×ª</label>
                    <button onclick="addTaskLine('newTasksList')" class="text-blue-600 text-xs font-bold">+ ×”×•×¡×£</button>
                </div>
                <div id="newTasksList" class="space-y-2"></div>
            </div>

            <label class="flex items-center gap-3 p-4 border-2 border-dashed border-slate-200 rounded-xl cursor-pointer hover:border-blue-400">
                <input type="file" class="hidden" accept="image/*" onchange="handleImage(this)">
                <i data-lucide="image-plus" class="text-slate-300 w-5 h-5"></i>
                <span class="text-sm font-bold text-slate-500" id="imgMsg">×”×•×¡×£ ×ª××•× ×” (×¢×“ 50KB)</span>
            </label>
        </div>
        <div class="p-5 border-t border-slate-100">
            <button onclick="saveEvent()" id="saveBtn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black shadow-lg active:scale-95 transition">×©××•×¨ ×•×¡× ×›×¨×Ÿ â†</button>
        </div>
    </div>
</div>

<div id="viewModal" class="modal-sheet hidden">
    <div class="sheet-body" style="height:88vh; border-radius:32px 32px 0 0;">
        <div class="h-44 bg-slate-200 relative shrink-0">
            <img id="viewImg" class="w-full h-full object-cover hidden">
            <div id="viewImgPlaceholder" class="absolute inset-0 flex items-center justify-center bg-slate-100"><i data-lucide="image" class="w-12 h-12 text-slate-200"></i></div>
            <button onclick="closeModal('viewModal')" class="absolute top-4 left-4 bg-black/30 text-white p-2 rounded-full backdrop-blur-sm"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-5">
            <h2 id="viewTitle" class="text-2xl font-black text-slate-800 mb-1 leading-snug"></h2>
            <div class="flex items-center gap-2 mb-4 text-sm text-slate-500">
                <span id="viewDate" class="bg-blue-50 text-blue-600 font-bold px-2 py-0.5 rounded-lg text-xs"></span>
                <span>â€¢</span>
                <span id="viewOwner"></span>
            </div>
            
            <div class="flex gap-2 mb-5">
                <button onclick="updateStatus('×—×“×©')" class="flex-1 py-2 rounded-xl font-bold text-xs border-2 bg-slate-50">×—×“×©</button>
                <button onclick="updateStatus('×‘×˜×™×¤×•×œ')" class="flex-1 py-2 rounded-xl font-bold text-xs border-2 bg-slate-50">×‘×˜×™×¤×•×œ</button>
                <button onclick="updateStatus('×‘×•×¦×¢')" class="flex-1 py-2 rounded-xl font-bold text-xs border-2 bg-slate-50">×‘×•×¦×¢</button>
            </div>

            <p id="viewDesc" class="text-sm text-slate-600 bg-slate-50 p-3 rounded-xl mb-5"></p>
            
            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <h3 class="text-[10px] font-black text-slate-400 uppercase mb-3">××©×™××•×ª</h3>
                <div id="viewTasksList" class="space-y-2 text-sm text-slate-600"></div>
            </div>
        </div>
    </div>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ02cU8av1KtchNykwq-QxjU6LiLZx-CSp5B28BxAgnsvJjlTwMMW1QO8qNylEYC78qDQFT_S3-fzUA/pub?output=csv";
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxpdgCT9MgQGJbGRJupmNpEZOxSlWBi99GrAznCFVUM7NsMKytt4gjquKR333sTb62vbg/exec";
const PRESET_USERS = ['×‘×Ÿ', '×¨×™× ×ª', '×“×•×“', '×©×¨×”'];

let events = [], currentUser = localStorage.getItem('batyamUser') || "", viewEventId = null;
let currentImageBase64 = "";

document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    if(currentUser) bootApp();
    else {
        const chips = document.getElementById('userChips');
        PRESET_USERS.forEach(u => {
            const b = document.createElement('button');
            b.className = 'user-chip'; b.innerText = u;
            b.onclick = () => { document.querySelectorAll('.user-chip').forEach(c=>c.classList.remove('selected')); b.classList.add('selected'); };
            chips.appendChild(b);
        });
        document.getElementById('loginModal').classList.remove('hidden');
    }
});

function login() {
    const chip = document.querySelector('.user-chip.selected');
    const custom = document.getElementById('customNameInput').value.trim();
    const name = custom || (chip ? chip.innerText : null);
    if(!name) return alert('×‘×—×¨ ×©×');
    localStorage.setItem('batyamUser', name);
    currentUser = name;
    document.getElementById('loginModal').classList.add('hidden');
    bootApp();
}

function logout() {
    if(confirm('×œ×”×ª× ×ª×§?')) {
        localStorage.removeItem('batyamUser');
        location.reload();
    }
}

function bootApp() {
    document.getElementById('userGreeting').innerText = currentUser;
    document.getElementById('app').classList.remove('hidden');
    loadData();
}

async function loadData(manual=false) {
    if(manual) document.getElementById('loader').classList.remove('fade');
    try {
        const res = await fetch(CSV_URL + '&t=' + Date.now());
        const text = await res.text();
        Papa.parse(text, { header:true, skipEmptyLines:true, complete: (r) => {
            events = r.data; // CSV Columns: ID, Title, Date, Owner, Description, Status, Tasks, Image
            renderAll();
            document.getElementById('loader').classList.add('fade');
        }});
    } catch(e) { console.error(e); document.getElementById('loader').classList.add('fade'); }
}

function renderAll() {
    // Stats
    document.getElementById('statTotal').innerText = events.length;
    const myTasks = events.filter(e => (e.Owner||e[3]||'').includes(currentUser));
    document.getElementById('statMine').innerText = myTasks.length;
    document.getElementById('taskBadge').classList.toggle('hidden', myTasks.length === 0);

    // List
    const list = document.getElementById('eventCards');
    list.innerHTML = '';
    [...events].reverse().forEach(e => {
        const title = e.Title||e[1], date = e.Date||e[2], owner = e.Owner||e[3], status = e.Status||e[5]||'×—×“×©';
        const isMine = (owner||'').includes(currentUser);
        const day = date.split('-')[2] || date.split('/')[0] || '?';
        const pill = status==='×‘×•×¦×¢'?'pill-done':status==='×‘×˜×™×¤×•×œ'?'pill-active':'pill-new';
        
        list.innerHTML += `
            <div onclick="openViewModal('${e.ID||e[0]}')" class="card p-4 flex items-center gap-4 border-r-4 ${isMine?'border-r-green-500':'border-r-transparent'}">
                <div class="w-14 h-14 bg-blue-50 rounded-2xl flex flex-col items-center justify-center border border-blue-100 font-black text-blue-600 shrink-0 shadow-sm">
                    <span class="text-xl leading-none">${day}</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start mb-1">
                        <h3 class="font-bold text-slate-800 text-sm truncate">${title}</h3>
                        <span class="text-[10px] font-black px-2 py-0.5 rounded-full ${pill}">${status}</span>
                    </div>
                    <span class="text-[11px] text-slate-400 font-medium">ğŸ‘¤ ${owner}</span>
                </div>
            </div>`;
    });

    // My Tasks
    const tasksContainer = document.getElementById('taskCards');
    tasksContainer.innerHTML = '';
    myTasks.forEach(e => {
        const tasks = (e.Tasks||e[6]||'').split('|').filter(t=>t);
        tasksContainer.innerHTML += `
            <div class="card p-4 border-r-4 border-r-green-500">
                <div class="flex justify-between border-b pb-2 mb-2">
                    <h3 class="font-bold text-slate-800 text-sm">${e.Title||e[1]}</h3>
                    <span class="text-[10px] bg-blue-50 text-blue-600 px-2 rounded font-bold">${e.Date||e[2]}</span>
                </div>
                ${tasks.length ? tasks.map(t=>`<div class="task-item"><input type="checkbox"><span>${t}</span></div>`).join('') : '<span class="text-xs text-slate-300">××™×Ÿ ××©×™××•×ª</span>'}
                <button onclick="openViewModal('${e.ID||e[0]}')" class="mt-2 text-xs font-bold text-blue-500">×¤×ª×— â†</button>
            </div>`;
    });
    
    renderCalendar();
    lucide.createIcons();
}

// --- Calendar ---
let calMonth = new Date().getMonth(), calYear = new Date().getFullYear();
function renderCalendar() {
    const grid = document.getElementById('calGrid'); grid.innerHTML = '';
    document.getElementById('calTitle').innerText = new Date(calYear, calMonth, 1).toLocaleDateString('he-IL',{month:'long',year:'numeric'});
    const firstDay = new Date(calYear, calMonth, 1).getDay();
    const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
    
    for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
    for(let d=1; d<=daysInMonth; d++) {
        const dateISO = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const dayEvents = events.filter(e => (e.Date||e[2]||'').startsWith(dateISO));
        grid.innerHTML += `
            <div class="cal-day ${new Date().getDate()===d && new Date().getMonth()===calMonth ? 'today':''}">
                <span class="font-bold block mb-1 text-slate-400">${d}</span>
                ${dayEvents.map(e => `<div class="cal-event ${e.Owner.includes(currentUser)?'mine':''}" onclick="openViewModal('${e.ID||e[0]}')">${e.Title||e[1]}</div>`).join('')}
            </div>`;
    }
}
function changeMonth(d) { calMonth+=d; if(calMonth>11){calMonth=0;calYear++} if(calMonth<0){calMonth=11;calYear--} renderCalendar(); }

// --- Modals & Logic ---
function openModal(id){ document.getElementById(id).classList.remove('hidden'); }
function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
function switchView(v){ 
    ['list','tasks','calendar'].forEach(i => document.getElementById(i+'View').classList.add('hidden'));
    document.getElementById(v+'View').classList.remove('hidden');
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('nav-'+v).classList.add('active');
    if(v==='calendar') renderCalendar();
}

function openViewModal(id) {
    const e = events.find(x => (x.ID||x[0]) == id);
    if(!e) return;
    viewEventId = id;
    
    document.getElementById('viewTitle').innerText = e.Title||e[1];
    document.getElementById('viewDate').innerText = e.Date||e[2];
    document.getElementById('viewOwner').innerText = e.Owner||e[3];
    document.getElementById('viewDesc').innerText = e.Description||e[4]||'';
    
    const img = e.Image||e[7];
    if(img && img.length > 50) {
        document.getElementById('viewImg').src = img;
        document.getElementById('viewImg').classList.remove('hidden');
        document.getElementById('viewImgPlaceholder').classList.add('hidden');
    } else {
        document.getElementById('viewImg').classList.add('hidden');
        document.getElementById('viewImgPlaceholder').classList.remove('hidden');
    }
    
    const tasks = (e.Tasks||e[6]||'').split('|').filter(t=>t);
    document.getElementById('viewTasksList').innerHTML = tasks.length ? tasks.map(t=>`<div>â€¢ ${t}</div>`).join('') : '××™×Ÿ ××©×™××•×ª';
    
    openModal('viewModal');
}

function setStatus(btn, val) {
    document.getElementById('inStatus').value = val;
    document.querySelectorAll('.status-btn').forEach(b => b.className = 'status-btn flex-1 py-2 rounded-xl font-bold text-sm bg-slate-50 text-slate-400 border-2 border-slate-100');
    const cls = val==='×‘×•×¦×¢'?'pill-done border-green-300':val==='×‘×˜×™×¤×•×œ'?'pill-active border-amber-300':'pill-new border-blue-300';
    btn.className = `status-btn flex-1 py-2 rounded-xl font-bold text-sm ${cls} border-2`;
}

function addTaskLine(id) {
    const div = document.createElement('div');
    div.innerHTML = `<div class="flex gap-2"><input type="text" class="task-input flex-1 bg-white border border-slate-200 rounded-xl p-2 text-sm outline-none" placeholder="××©×™××”..."><button onclick="this.parentElement.parentElement.remove()" class="text-red-400">ğŸ—‘</button></div>`;
    document.getElementById(id).appendChild(div);
}

function handleImage(input) {
    const reader = new FileReader();
    reader.onload = e => {
        if(e.target.result.length > 50000) { alert('×ª××•× ×” ×’×“×•×œ×” ××“×™! ×‘×—×¨ ×§×•×‘×¥ ×§×˜×Ÿ ×-50KB'); input.value=''; return; }
        currentImageBase64 = e.target.result;
        document.getElementById('imgMsg').innerText = 'âœ… ×ª××•× ×” × ×‘×—×¨×”';
    };
    reader.readAsDataURL(input.files[0]);
}

async function saveEvent() {
    const title = document.getElementById('inTitle').value;
    if(!title) return alert('×—×•×‘×” ×œ××œ× ×©×');
    
    const btn = document.getElementById('saveBtn');
    btn.innerText = '×©×•×œ×—...'; btn.disabled = true;
    
    // Create unique ID
    const id = Date.now().toString();
    const tasks = Array.from(document.querySelectorAll('#newTasksList input')).map(i=>i.value).join('|');
    const params = new URLSearchParams({
        action: 'create',
        id: id,
        title: title,
        date: document.getElementById('inDate').value,
        owner: document.getElementById('inOwner').value,
        status: document.getElementById('inStatus').value,
        desc: document.getElementById('inDesc').value,
        tasks: tasks,
        image: currentImageBase64
    });

    try {
        await fetch(APPS_SCRIPT_URL, { method:'POST', mode:'no-cors', body:params });
        alert('× ×©××¨ ×‘×”×¦×œ×—×”!');
        closeModal('addModal');
        setTimeout(loadData, 2000); // Reload to see new data
    } catch(e) { alert('×©×’×™××”'); }
    
    btn.innerText = '×©××•×¨ ×•×¡× ×›×¨×Ÿ â†'; btn.disabled = false;
}

async function updateStatus(newStatus) {
    if(!viewEventId) return;
    if(!confirm('×œ×¢×“×›×Ÿ ×¡×˜×˜×•×¡ ×œ-'+newStatus+'?')) return;
    
    const params = new URLSearchParams({ action: 'update', id: viewEventId, status: newStatus });
    try {
        await fetch(APPS_SCRIPT_URL, { method:'POST', mode:'no-cors', body:params });
        alert('×¢×•×“×›×Ÿ! ×™×•×¤×™×¢ ×ª×•×š ×›××” ×©× ×™×•×ª');
        closeModal('viewModal');
        setTimeout(loadData, 2000);
    } catch(e) { alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ'); }
}
</script>
</body>
</html>
